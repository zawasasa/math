<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„ÇÇ„Åê„ÇÇ„ÅêÁ¥ÑÂàÜ„Éû„Çπ„Çø„Éº </title>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@500&family=M+PLUS+Rounded+1c:wght@800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF9AA2;
            --secondary: #B5EAD7;
            --accent: #FFDAC1;
            --text: #6B5B95;
            --white: #FFFFF0;
            --badge-bg: rgba(255, 255, 255, 0.6);
            --font-main: 'M PLUS Rounded 1c', sans-serif;
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body {
            font-family: var(--font-main);
            background-color: #E2F0CB;
            background-image: radial-gradient(rgba(255,255,255,0.4) 15%, transparent 16%),
                              radial-gradient(rgba(255,255,255,0.4) 15%, transparent 16%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            color: var(--text);
            overflow: hidden;
            font-size: 16px;
            transition: background-color 1s ease;
        }

        .main-wrapper {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 10px;
            width: 98%;
            max-width: 600px;
            height: 96vh; 
            max-height: 700px;
        }

        .game-container {
            background: var(--white);
            flex: 1;
            border-radius: 20px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            padding: 10px 15px;
            text-align: center;
            position: relative; /* „Åì„Åì„ÇíÂü∫Ê∫ñ„Å´„Éú„Çø„É≥„ÇíÈÖçÁΩÆ */
            border: 4px solid var(--white);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
        }

        /* „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Éú„Çø„É≥Ôºà„Éõ„Éº„É†„Å´Êàª„ÇãÔºâ */
        .index-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--secondary);
            border: 2px solid var(--text);
            color: var(--text);
            border-radius: 12px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-family: var(--font-main);
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
            z-index: 50;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .index-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥Ôºà„Åä„ÅÜ„Å°„Éú„Çø„É≥Ôºâ */
        .home-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fff;
            border: 2px solid var(--text);
            color: var(--text);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
            z-index: 50; /* ‰ªñ„ÅÆË¶ÅÁ¥†„Çà„ÇäÊâãÂâç„Å´ */
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 3px; /* „Ç¢„Ç§„Ç≥„É≥‰ΩçÁΩÆÂæÆË™øÊï¥ */
        }
        .home-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* Âè≥ÂÅ¥„ÅÆ„Éê„ÉÉ„Ç∏„Ç®„É™„Ç¢ */
        .badge-sidebar {
            width: 55px;
            background: var(--badge-bg);
            border: 4px solid var(--white);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .badge-title {
            writing-mode: vertical-rl;
            font-family: 'Kiwi Maru', serif;
            font-size: 0.75rem;
            color: var(--primary);
            margin-bottom: 5px;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .badge-slot {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            margin-bottom: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        @keyframes pop-in {
            0% { transform: scale(0) rotate(-180deg); }
            60% { transform: scale(1.4) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .badge-new {
            animation: pop-in 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #FFF9C4;
            border: 2px solid #FFD54F;
        }

        h1 {
            font-family: 'Kiwi Maru', serif;
            color: var(--primary);
            margin: 0;
            text-shadow: 2px 2px 0 #FFF;
            font-size: 1.2rem;
            flex-shrink: 0;
            line-height: 1.2;
            padding-right: 30px; /* „Éú„Çø„É≥„Å®Ë¢´„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´‰ΩôÁôΩ */
        }

        .screen {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            width: 100%;
            padding-top: 5px;
        }
        .hidden { display: none !important; }

        /* UI„Éë„Éº„ÉÑ */
        .level-display {
            background: var(--primary);
            color: white;
            padding: 2px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            background: var(--accent);
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.8rem;
            color: #555;
            margin: 5px 0;
            flex-shrink: 0;
        }

        .mascot-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            min-height: 40px;
            max-height: 100px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .speech-bubble {
            position: relative;
            background: var(--secondary);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #333;
            flex-shrink: 0;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            top: -6px; left: 50%; transform: translateX(-50%);
            border-width: 0 6px 6px; border-style: solid; border-color: transparent transparent var(--secondary);
        }

        .fraction-display {
            font-size: 1.6rem;
            color: var(--text);
            margin-top: 2px;
            background: #fff;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 2px 15px;
            border-radius: 12px;
            border: 2px dashed var(--primary);
            min-height: 50px;
        }
        .fraction-wrap { display: inline-flex; flex-direction: column; align-items: center; line-height: 1; }
        .numerator { border-bottom: 2px solid currentColor; padding: 0 5px 1px 5px; text-align: center; width: 100%; }
        .denominator { padding: 1px 5px 0 5px; text-align: center; width: 100%; }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .option-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0;
            font-size: 1.2rem;
            border-radius: 12px;
            font-family: var(--font-main);
            cursor: pointer;
            box-shadow: 0 3px 0 #E07A86;
            transition: transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
        }
        .option-btn:active { transform: translateY(3px); box-shadow: none; }
        .option-btn.cant-do { background: #C7CEEA; box-shadow: 0 3px 0 #9AA3C6; font-size: 1rem; font-weight: bold; }
        .option-btn.integer-answer { font-size: 1.8rem; background: #FFB7B2; box-shadow: 0 3px 0 #E0908C; }
        .option-btn .numerator { border-bottom-color: white; }

        .feedback {
            position: absolute;
            top: 45%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 5rem;
            font-weight: bold;
            text-shadow: 2px 2px 0 #FFF;
            pointer-events: none;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
        }
        .feedback.show { transform: translate(-50%, -50%) scale(1); }
        .correct { color: #FF6B6B; }
        .wrong { color: #6B5B95; font-size: 4rem; }

        .start-btn, .retry-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 0;
            font-size: 1.2rem;
            border-radius: 25px;
            font-family: var(--font-main);
            font-weight: bold;
            box-shadow: 0 4px 0 #E07A86;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
        }
        .start-btn:active, .retry-btn:active { transform: translateY(4px); box-shadow: none; }

        .mode-select { background: #f0f0f0; padding: 8px; border-radius: 12px; margin-bottom: 10px; text-align: left; font-size: 0.85rem;}
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle; margin-left: 8px;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--secondary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .clear-title { font-size: 1.8rem; color: #FFD700; text-shadow: 2px 2px 0 #E65100; font-family: 'Kiwi Maru'; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.1);} }

        @media (max-height: 750px) {
            .game-container { padding: 5px 10px; }
            h1 { font-size: 1rem; margin-bottom: 2px; }
            .mascot-area { font-size: 2.5rem; height: auto; min-height: 0; flex-grow: 0.5; margin: 0; }
            .speech-bubble { padding: 5px; margin-bottom: 5px; font-size: 0.85rem; }
            .fraction-display { font-size: 1.4rem; min-height: 40px; padding: 0 10px; }
            .option-btn { height: 45px; font-size: 1.1rem; }
            .header-info { padding: 2px 8px; font-size: 0.75rem; margin: 3px 0;}
            .level-display { font-size: 0.8rem; padding: 1px 10px; }
        }

    </style>
</head>
<body>

    <div class="main-wrapper">
        <!-- „É°„Ç§„É≥„Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
        <div class="game-container">
            <a href="index.html" class="index-btn" title="„Éõ„Éº„É†„Å´Êàª„Çã">üè† „Éõ„Éº„É†</a>
            <!-- „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥ÔºàÂè≥‰∏ä„Å´ÈÖçÁΩÆÔºâ -->
            <button class="home-btn" onclick="confirmReset()" title="„Çø„Ç§„Éà„É´„Å´Êàª„Çã">üè†</button>

            <h1>üç© „ÇÇ„Åê„ÇÇ„ÅêÁ¥ÑÂàÜ„Éâ„Éº„Éä„ÉÑ</h1>

            <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
            <div id="title-screen" class="screen">
                <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
                    <div style="font-size:3.5rem; margin-bottom:5px;">üêª</div>
                    <div class="speech-bubble">
                        „ÇÅ„Åñ„Åõ„É¨„Éô„É´10„ÇØ„É™„Ç¢ÔºÅ<br>
                        „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Åß<br>
                        „Åä„Çì„Åå„Åè„ÇÑ „ÅØ„ÅÑ„Åë„ÅÑ„Åå<br>
                        „Åã„Çè„Çã„Çà‚ú®
                    </div>
                    
                    <div class="mode-select">
                        <label style="display:flex; align-items:center; justify-content:space-between;">
                            <span>‚è±Ô∏è „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ(60Áßí)</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                </div>
                <button class="start-btn" onclick="startGame()">„Çπ„Çø„Éº„ÉàÔºÅ</button>
            </div>

            <!-- „Ç≤„Éº„É†„Éó„É¨„Ç§ÁîªÈù¢ -->
            <div id="game-screen" class="screen hidden">
                <div style="text-align:center;">
                    <div class="level-display">Lv.<span id="level-num">1</span></div>
                </div>
                <div class="header-info">
                    <span>„Çπ„Ç≥„Ç¢: <span id="score">0</span></span>
                    <span id="timer-display" style="color:var(--primary);">--</span>
                    <span>„ÅÇ„Å®: <span id="to-next-level">5</span></span>
                </div>

                <div class="mascot-area" id="mascot">üêª</div>

                <div class="speech-bubble">
                    <span id="hint-text">„Åì„Çå„ÄÅË®àÁÆó„Åß„Åç„ÇãÔºü</span>
                    <br>
                    <div class="fraction-display" id="question"></div>
                </div>

                <div class="options-grid" id="options"></div>
            </div>

            <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ -->
            <div id="result-screen" class="screen hidden">
                <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
                    <div class="mascot-area" id="result-mascot">üò¢</div>
                    <div class="speech-bubble">
                        <div style="font-size:1.1rem; margin-bottom:5px;">„Åò„Åã„Çì„Åé„ÇåÔºÅ</div>
                        „Çπ„Ç≥„Ç¢: <span style="font-size:1.5rem; color:#FF6B6B; font-weight:bold;" id="final-score">0</span><br>
                        „É¨„Éô„É´: <span style="font-size:1.2rem; color:#6B5B95; font-weight:bold;" id="final-level">1</span>
                    </div>
                </div>
                <button class="retry-btn" onclick="toTitle()">„Çø„Ç§„Éà„É´„Å´„ÇÇ„Å©„Çã</button>
            </div>

            <!-- ÂÖ®„ÇØ„É™ÁîªÈù¢ÔºàLevel 10ÈÅîÊàêÔºâ -->
            <div id="clear-screen" class="screen hidden">
                <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                    <div class="clear-title">ALL CLEAR!!</div>
                    <div style="font-size:4rem; margin:5px 0;">üëë</div>
                    <div class="speech-bubble" style="background:#FFF9C4;">
                        <div style="font-size:1rem; font-weight:bold; color:#E65100;">„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</div>
                        „ÅÇ„Å™„Åü„ÅØ<br>
                        „ÇÑ„Åè„Å∂„Çì„Éû„Çπ„Çø„Éº„Åß„ÅôÔºÅ<br>
                        „Åï„ÅÑ„Åî„ÅÆ„Çπ„Ç≥„Ç¢: <span id="clear-score" style="font-size:1.4rem; color:#FF6B6B;"></span>
                    </div>
                </div>
                <button class="retry-btn" onclick="toTitle()">„Åï„ÅÑ„Åó„Çá„Åã„Çâ„ÅÇ„Åù„Å∂</button>
            </div>

            <div id="feedback-msg" class="feedback">‚≠ïÔ∏è</div>
        </div>

        <!-- Âè≥ÂÅ¥„ÅÆ„Éê„ÉÉ„Ç∏„Ç®„É™„Ç¢ -->
        <div class="badge-sidebar" id="badge-container">
            <div class="badge-title">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</div>
        </div>
    </div>

    <script>
        // --- Èü≥Â£∞Èñ¢ÈÄ£ ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); else if (audioCtx.state === 'suspended') audioCtx.resume(); }
        
        function playSound(type) {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') {
                const osc = audioCtx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(783.99, now + 0.1);
                osc.connect(gainNode);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(); osc.stop(now + 0.3);

            } else if (type === 'levelup') {
                const freqs = [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98, 2093.00];
                freqs.forEach((f, i) => {
                    const osc = audioCtx.createOscillator();
                    osc.type = i % 2 === 0 ? 'sine' : 'triangle';
                    osc.frequency.setValueAtTime(f, now + i * 0.08);
                    osc.connect(gainNode);
                    osc.start();
                    osc.stop(now + i * 0.08 + 0.3);
                });
                gainNode.gain.setValueAtTime(0.05, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 1.0);

            } else if (type === 'clear') {
                const freqs = [523.25, 523.25, 523.25, 659.25, 783.99, 659.25, 783.99, 1046.50];
                const times = [0, 0.2, 0.4, 0.6, 0.8, 1.2, 1.4, 1.6];
                freqs.forEach((f, i) => {
                    const osc = audioCtx.createOscillator();
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(f, now + times[i]);
                    osc.connect(gainNode);
                    osc.start();
                    osc.stop(now + times[i] + 0.2);
                });
                gainNode.gain.setValueAtTime(0.05, now);

            } else {
                const osc = audioCtx.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.connect(gainNode);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(); osc.stop(now + 0.2);
            }
        }

        // --- „Ç≤„Éº„É†ÂÆöÊï∞„ÉªÂ§âÊï∞ ---
        const bgColors = [
            "#E2F0CB", "#E2F0CB", 
            "#FFDAC1", "#FFDAC1", 
            "#C7CEEA", "#C7CEEA", 
            "#2C3E50", "#2C3E50", 
            "#FFF59D", "#FFF59D"
        ];
        const textColors = [
            "#6B5B95", "#6B5B95", "#6B5B95", "#6B5B95", "#6B5B95", "#6B5B95", 
            "#FFFFFF", "#FFFFFF", "#6B5B95", "#6B5B95"
        ];
        
        const badges = ['üç¨', 'üç©', 'üç™', 'üç∞', 'üç¶', 'üçÆ', 'ü•û', 'üíé', 'ü¶Ñ', 'üëë'];

        let currentScore = 0;
        let currentLevel = 1;
        let correctInLevel = 0; 
        const requiredForLevelUp = 5; 
        let currentQuestion = {};
        let isTimeAttack = false;
        let timeLeft = 60;
        let timerInterval = null;

        // --- DOMË¶ÅÁ¥† ---
        const titleScreen = document.getElementById('title-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const clearScreen = document.getElementById('clear-screen');
        const modeToggle = document.getElementById('mode-toggle');
        
        const scoreEl = document.getElementById('score');
        const levelNumEl = document.getElementById('level-num');
        const toNextLevelEl = document.getElementById('to-next-level');
        const timerDisplay = document.getElementById('timer-display');
        const questionEl = document.getElementById('question');
        const optionsEl = document.getElementById('options');
        const feedbackEl = document.getElementById('feedback-msg');
        const mascotEl = document.getElementById('mascot');
        const hintText = document.getElementById('hint-text');
        const badgeContainer = document.getElementById('badge-container');

        const mascots = ['üêª', 'üê∞', 'üêº', 'üê±', 'üê∂', 'üêπ'];

        // --- „Éò„É´„Éë„ÉºÈñ¢Êï∞ ---
        function makeFractionHTML(text) {
            if (!text.includes('/')) return text;
            const parts = text.split('/');
            return `<div class="fraction-wrap"><div class="numerator">${parts[0]}</div><div class="denominator">${parts[1]}</div></div>`;
        }
        function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }

        function updateBackground(level) {
            const idx = Math.min(level - 1, bgColors.length - 1);
            document.body.style.backgroundColor = bgColors[idx];
            document.body.style.color = textColors[idx];
        }

        // --- „É™„Çª„ÉÉ„ÉàÊ©üËÉΩ ---
        function confirmReset() {
            // „Çø„Ç§„Éà„É´ÁîªÈù¢„ÅÆ„Å®„Åç„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (!titleScreen.classList.contains('hidden')) return;

            if (confirm("„Çø„Ç§„Éà„É´„Å´„ÇÇ„Å©„ÇãÔºü\nÔºà‰ªä„ÅÆ„Çπ„Ç≥„Ç¢„ÅØ„Åç„Åà„Å°„ÇÉ„ÅÜ„ÇàÔºâ")) {
                if (timerInterval) clearInterval(timerInterval);
                toTitle();
            }
        }

        // --- „Ç≤„Éº„É†ÈÄ≤Ë°å ---
        function startGame() {
            initAudio();
            isTimeAttack = modeToggle.checked;
            
            titleScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            clearScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            currentScore = 0;
            currentLevel = 1;
            correctInLevel = 0;
            
            scoreEl.innerText = 0;
            levelNumEl.innerText = 1;
            toNextLevelEl.innerText = requiredForLevelUp;
            
            updateBackground(1);
            
            badgeContainer.innerHTML = '<div class="badge-title">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</div>';

            if (isTimeAttack) {
                timeLeft = 60;
                timerDisplay.innerText = "60Áßí";
                startTimer();
            } else {
                timerDisplay.innerText = "„Å™„Åó";
            }
            
            generateProblem();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft + "Áßí";
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        function generateProblem() {
            mascotEl.innerText = mascots[Math.floor(Math.random() * mascots.length)];

            let denominators = [];
            let allowTrick = false;
            let allowInt = false;
            
            if (currentLevel <= 2) {
                denominators = [4, 6, 8, 9, 10];
                hintText.innerText = "„Åã„Çì„Åü„ÇìÔºÅ";
            } else if (currentLevel <= 5) {
                denominators = [12, 14, 15, 16, 18, 20];
                allowTrick = true;
                hintText.innerText = "„Å°„Çá„Å£„Å®„ÇÄ„Åö„Åã„Åó„ÅÑ";
            } else if (currentLevel <= 8) {
                denominators = [20, 24, 25, 27, 28, 30, 36];
                allowTrick = true;
                allowInt = true;
                hintText.innerText = "„Åß„Åç„Çã„Åã„Å™Ôºü";
            } else {
                denominators = [30, 32, 40, 42, 45, 48, 50, 60];
                allowTrick = true;
                allowInt = true;
                hintText.innerText = "„É©„Çπ„Éà„Çπ„Éë„Éº„ÉàÔºÅ";
            }

            const rand = Math.random();
            if (allowInt && rand < 0.20) {
                const ans = Math.floor(Math.random() * 5) + 2;
                const den = Math.floor(Math.random() * 5) + 2;
                currentQuestion = { q: `${ans * den}/${den}`, a: `${ans}` };
            } else if (allowTrick && rand < 0.40) {
                let d = denominators[Math.floor(Math.random() * denominators.length)];
                let n = Math.floor(Math.random() * (d - 1)) + 1;
                while (gcd(n, d) !== 1) n = Math.floor(Math.random() * (d - 1)) + 1;
                currentQuestion = { q: `${n}/${d}`, a: "„Åß„Åç„Å™„ÅÑ" };
            } else {
                let d = denominators[Math.floor(Math.random() * denominators.length)];
                let n = Math.floor(Math.random() * (d - 1)) + 1;
                while (gcd(n, d) === 1) n = Math.floor(Math.random() * (d - 1)) + 1;
                const cd = gcd(n, d);
                currentQuestion = { q: `${n}/${d}`, a: `${n/cd}/${d/cd}` };
            }

            questionEl.innerHTML = makeFractionHTML(currentQuestion.q);
            generateOptions(currentQuestion.a);
        }

        function generateOptions(ans) {
            optionsEl.innerHTML = '';
            let options = new Set([ans]);
            const isInt = !ans.includes('/') && ans !== "„Åß„Åç„Å™„ÅÑ";

            if (isInt) {
                while(options.size < 4) options.add(`${Math.floor(Math.random()*9)+1}`);
            } else {
                options.add("„Åß„Åç„Å™„ÅÑ");
                while(options.size < 4) {
                    let n = Math.floor(Math.random()*7)+1;
                    let d = Math.floor(Math.random()*9)+2;
                    if(n<d && gcd(n,d)===1) options.add(`${n}/${d}`);
                }
            }

            Array.from(options).sort(() => Math.random() - 0.5).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = makeFractionHTML(opt);
                if (opt === "„Åß„Åç„Å™„ÅÑ") btn.classList.add('cant-do');
                else if (!opt.includes('/')) btn.classList.add('integer-answer');
                
                btn.onclick = () => checkAnswer(opt);
                optionsEl.appendChild(btn);
            });
        }

        function checkAnswer(selected) {
            if (selected === currentQuestion.a) {
                currentScore += 10 * currentLevel;
                scoreEl.innerText = currentScore;
                correctInLevel++;
                
                if (correctInLevel >= requiredForLevelUp) {
                    levelUp();
                } else {
                    playSound('correct');
                    showFeedback(true);
                    toNextLevelEl.innerText = requiredForLevelUp - correctInLevel;
                    setTimeout(nextTurn, 800);
                }
            } else {
                playSound('wrong');
                showFeedback(false);
                setTimeout(nextTurn, 800);
            }
        }

        function levelUp() {
            const badgeIndex = Math.min(currentLevel - 1, badges.length - 1);
            const badgeIcon = badges[badgeIndex];
            const badgeEl = document.createElement('div');
            badgeEl.className = 'badge-slot badge-new';
            badgeEl.innerText = badgeIcon;
            badgeContainer.appendChild(badgeEl);
            badgeEl.scrollIntoView({ behavior: 'smooth' });

            currentLevel++;
            correctInLevel = 0;

            if (currentLevel > 10) {
                playSound('levelup');
                showFeedback(true, "Clear!");
                setTimeout(() => {
                    gameClear();
                }, 1500);
                return;
            }

            playSound('levelup');
            showFeedback(true, "Level Up!");
            updateBackground(currentLevel);

            setTimeout(() => {
                levelNumEl.innerText = currentLevel;
                toNextLevelEl.innerText = requiredForLevelUp;
                nextTurn();
            }, 1500);
        }

        function nextTurn() {
            if (isTimeAttack && timeLeft <= 0) return;
            generateProblem();
        }

        function showFeedback(isCorrect, text = null) {
            feedbackEl.innerText = text ? text : (isCorrect ? '‚≠ïÔ∏è' : '‚ùå');
            feedbackEl.className = `feedback show ${isCorrect ? 'correct' : 'wrong'}`;
            if (text) feedbackEl.style.fontSize = "3.5rem"; // Â∞ë„ÅóÂ∞è„Åï„Åè
            else feedbackEl.style.fontSize = "";

            mascotEl.innerText = isCorrect ? 'üòÜ' : 'ü•∫';
            setTimeout(() => feedbackEl.classList.remove('show'), 700);
        }

        function endGame() {
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('final-score').innerText = currentScore;
            document.getElementById('final-level').innerText = currentLevel;
            gameScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
        }

        function gameClear() {
            if (timerInterval) clearInterval(timerInterval);
            playSound('clear');
            document.getElementById('clear-score').innerText = currentScore;
            gameScreen.classList.add('hidden');
            clearScreen.classList.remove('hidden');
        }

        function toTitle() {
            updateBackground(1);
            gameScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            clearScreen.classList.add('hidden');
            titleScreen.classList.remove('hidden');
        }
    </script>
</body>
</html>