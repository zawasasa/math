<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ã‚Šç®—ãƒã‚¹ã‚¿ãƒ¼ - ã•ã•ã£ã¨ç®—æ•°</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@500&family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1;
            --primary-light: #818CF8;
            --secondary: #F472B6;
            --accent: #34D399;
            --warning: #FBBF24;
            --danger: #F87171;
            --bg-gradient: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #D1FAE5 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #1E293B;
            --text-light: #64748B;
            --font-main: 'M PLUS Rounded 1c', sans-serif;
            --font-title: 'Kiwi Maru', serif;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --radius: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
        .title-screen {
            text-align: center;
            padding: 30px 20px;
        }

        .game-title {
            font-family: var(--font-title);
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .game-subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 30px;
            line-height: 1.8;
        }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚«ãƒ¼ãƒ‰ */
        .mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: var(--shadow);
        }

        .mode-card:hover {
            transform: translateY(-5px);
        }

        .mode-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #EEF2FF 0%, #FDF2F8 100%);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .mode-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }

        .mode-desc {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.6;
        }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        .settings-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
            display: block;
        }

        .option-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .option-btn {
            background: white;
            border: 2px solid #E2E8F0;
            color: var(--text);
            font-size: 0.95rem;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover {
            border-color: var(--primary-light);
        }

        .option-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .start-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-size: 1.4rem;
            font-weight: 700;
            padding: 18px 50px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
            transition: all 0.3s;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.5);
        }

        .back-button {
            background: #E2E8F0;
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .back-button:hover {
            background: #CBD5E1;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        .game-screen {
            display: none;
        }

        .game-screen.active {
            display: block;
        }

        /* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ */
        .score-board {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 3px;
        }

        .score-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* å•é¡Œã‚¨ãƒªã‚¢ */
        .problem-area {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        /* ã‚·ãƒŠãƒªã‚ªè¡¨ç¤º */
        .scenario-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-radius: 15px;
        }

        .scenario-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .scenario-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text);
        }

        .scenario-highlight {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
        }

        /* å¼è¡¨ç¤º */
        .formula-display {
            text-align: center;
            padding: 20px;
            background: #F8FAFC;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .formula {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .formula-number {
            background: white;
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid #E2E8F0;
        }

        .formula-operator {
            color: var(--primary);
        }

        /* æ¦‚æ•°ãƒ’ãƒ³ãƒˆ */
        .approx-hint {
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .approx-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .approx-content {
            font-size: 1rem;
            color: var(--text);
            line-height: 1.6;
        }

        .approx-calc {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* æ•°ç›´ç·š */
        .number-line {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .number-line-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 15px;
            text-align: center;
        }

        .line-container {
            position: relative;
            height: 50px;
            margin: 0 20px;
        }

        .line-track {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background: #E2E8F0;
            border-radius: 2px;
        }

        .line-marker {
            position: absolute;
            top: 10px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .line-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area {
            background: linear-gradient(135deg, #FDF4FF 0%, #FAE8FF 100%);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .input-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 15px;
            text-align: center;
        }

        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .answer-input {
            font-family: var(--font-main);
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            width: 150px;
            padding: 15px;
            border: 3px solid var(--primary-light);
            border-radius: 15px;
            background: white;
            color: var(--text);
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .times-label {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
        .choice-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .choice-btn {
            background: white;
            border: 3px solid #E2E8F0;
            color: var(--text);
            font-size: 1.8rem;
            font-weight: 700;
            padding: 20px 35px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }

        .choice-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-3px);
        }

        .choice-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ */
        .hint-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .hint-btn {
            background: var(--warning);
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hint-btn:hover {
            transform: scale(1.05);
        }

        .hint-btn:disabled {
            background: #CBD5E1;
            cursor: not-allowed;
        }

        /* ãƒ’ãƒ³ãƒˆè¡¨ç¤º */
        .hint-display {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--warning);
            display: none;
        }

        .hint-display.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hint-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #92400E;
            margin-bottom: 8px;
        }

        .hint-content {
            font-size: 1rem;
            color: var(--text);
            line-height: 1.6;
        }

        /* é€ä¿¡ãƒœã‚¿ãƒ³ */
        .submit-button {
            background: linear-gradient(135deg, var(--accent) 0%, #10B981 100%);
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(52, 211, 153, 0.4);
            transition: all 0.2s;
            display: block;
            margin: 0 auto;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 211, 153, 0.5);
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        .feedback {
            display: none;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback.show {
            display: block;
        }

        .feedback-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .feedback-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .feedback-title.perfect {
            color: var(--primary);
        }

        .feedback-title.good {
            color: var(--warning);
        }

        .feedback-title.ok {
            color: var(--accent);
        }

        .feedback-message {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .feedback-explanation {
            background: #F1F5F9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
            line-height: 1.8;
        }

        /* ä½™ã‚Šãƒã‚§ãƒƒã‚¯ */
        .remainder-check {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
            border-left: 4px solid var(--accent);
        }

        .remainder-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #065F46;
            margin-bottom: 8px;
        }

        .remainder-content {
            font-size: 1rem;
            color: var(--text);
        }

        .remainder-ok {
            color: var(--accent);
            font-weight: 700;
        }

        .remainder-ng {
            color: var(--danger);
            font-weight: 700;
        }

        .next-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            transition: all 0.2s;
        }

        .next-button:hover {
            transform: translateY(-2px);
        }

        /* æˆé•·ã‚°ãƒ©ãƒ• */
        .growth-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .growth-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 20px;
            text-align: center;
        }

        .growth-item {
            margin-bottom: 15px;
        }

        .growth-label {
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .growth-bar-bg {
            height: 12px;
            background: #E2E8F0;
            border-radius: 6px;
            overflow: hidden;
        }

        .growth-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s;
        }

        .growth-bar.approx {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .growth-bar.calc {
            background: linear-gradient(90deg, var(--secondary) 0%, #F9A8D4 100%);
        }

        .growth-bar.remainder {
            background: linear-gradient(90deg, var(--accent) 0%, #6EE7B7 100%);
        }

        /* ç­†ç®—è¡¨ç¤º */
        .division-process {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 1.2rem;
        }

        .division-step {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
        }

        .division-step.current {
            background: #FEF3C7;
            border: 2px solid var(--warning);
        }

        .division-step.completed {
            background: #D1FAE5;
        }

        .step-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .game-title {
                font-size: 1.8rem;
            }

            .formula {
                font-size: 1.5rem;
            }

            .answer-input {
                font-size: 1.5rem;
                width: 120px;
            }

            .choice-btn {
                font-size: 1.5rem;
                padding: 15px 25px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* ç­†ç®—è¡¨ç¤º */
        .division-process {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            font-family: 'M PLUS Rounded 1c', monospace;
            font-size: 1.2rem;
        }

        .division-process-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 15px;
            text-align: center;
        }

        .division-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .division-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .division-cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: 700;
            border-radius: 8px;
        }

        .division-cell.divisor {
            background: var(--primary-light);
            color: white;
        }

        .division-cell.dividend {
            background: #F1F5F9;
            border-bottom: 3px solid var(--text);
        }

        .division-cell.quotient {
            background: var(--accent);
            color: white;
        }

        .division-cell.quotient.empty {
            background: #FEF3C7;
            color: var(--warning);
            border: 2px dashed var(--warning);
        }

        .division-cell.product {
            background: #FDF2F8;
            color: var(--secondary);
        }

        .division-cell.remainder-cell {
            background: #DBEAFE;
            color: var(--primary);
        }

        .division-symbol {
            font-size: 1.5rem;
            color: var(--text);
            margin: 0 5px;
        }

        .division-line {
            width: 100%;
            height: 2px;
            background: var(--text);
            margin: 5px 0;
        }

        /* è¨ˆç®—ã‚¹ãƒ†ãƒƒãƒ— */
        .calc-steps {
            background: #F8FAFC;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .calc-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .calc-step.current {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid var(--warning);
        }

        .calc-step.completed {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
        }

        .calc-step.pending {
            opacity: 0.5;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .step-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-right: auto;
        }

        .step-action {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
        }

        /* ç­†ç®—å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ */
        .written-input-mode {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .digit-input-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .digit-btn {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-weight: 700;
            border: 2px solid #E2E8F0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .digit-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .digit-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* ãƒãƒˆãƒ«ãƒ¢ãƒ¼ãƒ‰ */
        .battle-area {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .battle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .battle-timer {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .battle-timer.warning {
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .battle-round {
            color: #FDE68A;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .enemy-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }

        .enemy-character {
            font-size: 4rem;
            animation: enemyBounce 1s ease-in-out infinite;
        }

        @keyframes enemyBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .enemy-name {
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 10px;
        }

        .hp-bar-container {
            width: 100%;
            max-width: 250px;
            margin-top: 15px;
        }

        .hp-label {
            display: flex;
            justify-content: space-between;
            color: #A5B4FC;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .hp-bar {
            height: 12px;
            background: #374151;
            border-radius: 6px;
            overflow: hidden;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #84cc16 100%);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .hp-fill.low {
            background: linear-gradient(90deg, #ef4444 0%, #f97316 100%);
        }

        .battle-message {
            color: #FDE68A;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 15px;
            min-height: 24px;
        }

        .damage-effect {
            position: absolute;
            color: #ef4444;
            font-size: 2rem;
            font-weight: 700;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes damageFloat {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }

        .heal-effect {
            position: absolute;
            color: #22c55e;
            font-size: 2rem;
            font-weight: 700;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div class="title-screen" id="titleScreen">
            <h1 class="game-title">ğŸ“ ã‚ã‚Šç®—ãƒã‚¹ã‚¿ãƒ¼</h1>
            <p class="game-subtitle">
                æ—¥å¸¸ã®å ´é¢ã§ã‚ã‚Šç®—ã‚’ä½¿ã„ã“ãªãã†ï¼<br>
                <strong>æ¦‚æ•°ã§è¦‹å½“ã‚’ã¤ã‘ã‚‹</strong>åŠ›ã‚’èº«ã«ã¤ã‘ã‚ˆã† ğŸ¯
            </p>

            <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
            <div class="mode-cards">
                <div class="mode-card selected" data-mode="story" onclick="selectMode('story')">
                    <div class="mode-icon">ğŸŒŸ</div>
                    <div class="mode-title">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰</div>
                    <div class="mode-desc">ãŠè²·ã„ç‰©ã‚„ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãªã©<br>æ—¥å¸¸ã®å ´é¢ã§ã‚ã‚Šç®—ã‚’ç·´ç¿’</div>
                </div>
                <div class="mode-card" data-mode="approx" onclick="selectMode('approx')">
                    <div class="mode-icon">ğŸ“</div>
                    <div class="mode-title">è¦‹ç©ã‚‚ã‚Šãƒ¢ãƒ¼ãƒ‰</div>
                    <div class="mode-desc">æ¦‚æ•°ã‚’ä½¿ã£ã¦<br>å•†ã®è¦‹å½“ã‚’ã¤ã‘ã‚‹ç·´ç¿’</div>
                </div>
                <div class="mode-card" data-mode="written" onclick="selectMode('written')">
                    <div class="mode-icon">âœï¸</div>
                    <div class="mode-title">ç­†ç®—ãƒ¢ãƒ¼ãƒ‰</div>
                    <div class="mode-desc">ãŸã¦ã‚‹ãƒ»ã‹ã‘ã‚‹ãƒ»ã²ããƒ»ãŠã‚ã™<br>ç­†ç®—ã®æ‰‹é †ã‚’ç·´ç¿’</div>
                </div>
                <div class="mode-card" data-mode="battle" onclick="selectMode('battle')">
                    <div class="mode-icon">âš”ï¸</div>
                    <div class="mode-title">ãƒãƒˆãƒ«ãƒ¢ãƒ¼ãƒ‰</div>
                    <div class="mode-desc">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¨æˆ¦ã„ãªãŒã‚‰<br>ã‚ã‚Šç®—ã‚’ãƒã‚¹ã‚¿ãƒ¼</div>
                </div>
            </div>

            <!-- è¨­å®šãƒ‘ãƒãƒ« -->
            <div class="settings-panel">
                <div class="setting-group">
                    <label class="setting-label">é›£æ˜“åº¦</label>
                    <div class="option-buttons">
                        <button class="option-btn active" data-difficulty="easy" onclick="setDifficulty('easy')">
                            ğŸ˜Š ã‹ã‚“ãŸã‚“<br><small>(2æ¡Ã·1æ¡)</small>
                        </button>
                        <button class="option-btn" data-difficulty="normal" onclick="setDifficulty('normal')">
                            ğŸ˜ ãµã¤ã†<br><small>(3æ¡Ã·2æ¡)</small>
                        </button>
                        <button class="option-btn" data-difficulty="hard" onclick="setDifficulty('hard')">
                            ğŸ˜¤ ã‚€ãšã‹ã—ã„<br><small>(4æ¡Ã·2æ¡)</small>
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">å…¥åŠ›æ–¹æ³•</label>
                    <div class="option-buttons">
                        <button class="option-btn active" data-input="choice" onclick="setInputMode('choice')">âœ‹
                            3æŠ</button>
                        <button class="option-btn" data-input="number" onclick="setInputMode('number')">ğŸ”¢ æ•°å­—å…¥åŠ›</button>
                    </div>
                </div>
            </div>

            <button class="start-button" onclick="startGame()">ğŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
            <br>
            <button class="back-button" onclick="location.href='index.html'">ğŸ  ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div class="game-screen" id="gameScreen">
            <!-- ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ -->
            <div class="score-board">
                <div class="score-item">
                    <div class="score-label">å•é¡Œæ•°</div>
                    <div class="score-value" id="totalCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">æ­£è§£</div>
                    <div class="score-value" id="correctCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">é€£ç¶š</div>
                    <div class="score-value" id="comboCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">æ­£è§£ç‡</div>
                    <div class="score-value" id="accuracy">--%</div>
                </div>
            </div>

            <!-- å•é¡Œã‚¨ãƒªã‚¢ -->
            <div class="problem-area" id="problemArea">
                <!-- ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ï¼ˆãƒãƒˆãƒ«ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ -->
                <div class="battle-area hidden" id="battleArea">
                    <div class="battle-header">
                        <div class="battle-round" id="battleRound">ROUND 1</div>
                        <div class="battle-timer" id="battleTimer">
                            â±ï¸ <span id="timerValue">30</span>
                        </div>
                    </div>
                    <div class="enemy-container">
                        <div class="enemy-character" id="enemyCharacter">ğŸ‘¾</div>
                        <div class="enemy-name" id="enemyName">ã‚¹ãƒ©ã‚¤ãƒ </div>
                        <div class="hp-bar-container">
                            <div class="hp-label">
                                <span>HP</span>
                                <span id="hpValue">100/100</span>
                            </div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="hpFill" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="battle-message" id="battleMessage">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒç¾ã‚ŒãŸï¼ã‚ã‚Šç®—ã§å€’ãã†ï¼</div>
                </div>

                <!-- ã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºï¼ˆã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ -->
                <div class="scenario-display" id="scenarioDisplay">
                    <div class="scenario-icon" id="scenarioIcon">ğŸ›’</div>
                    <div class="scenario-text" id="scenarioText">
                        ã¿ã‚“ãªã§è²·ã„ç‰©ã«æ¥ãŸã‚ˆï¼<br>
                        <span class="scenario-highlight" id="scenarioProblem">1200å††ã‚’4äººã§å‰²ã‚Šå‹˜ã™ã‚‹ã¨ã€1äººã„ãã‚‰ï¼Ÿ</span>
                    </div>
                </div>

                <!-- å¼è¡¨ç¤º -->
                <div class="formula-display">
                    <div class="formula">
                        <span class="formula-number" id="dividend">1200</span>
                        <span class="formula-operator">Ã·</span>
                        <span class="formula-number" id="divisor">4</span>
                        <span class="formula-operator">=</span>
                        <span class="formula-number">ï¼Ÿ</span>
                    </div>
                </div>

                <!-- æ¦‚æ•°ãƒ’ãƒ³ãƒˆï¼ˆå¼·åŒ–ç‰ˆï¼‰ -->
                <div class="approx-hint" id="approxHint">
                    <div class="approx-title">ğŸ’¡ æ¦‚æ•°ã§è¦‹å½“ã‚’ã¤ã‘ã‚ˆã†</div>
                    <div class="approx-method-buttons"
                        style="margin-bottom: 10px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                        <button class="approx-method-btn active" data-method="round" onclick="setApproxMethod('round')"
                            style="padding: 5px 12px; border-radius: 15px; border: 2px solid var(--primary); background: var(--primary); color: white; font-size: 0.8rem; cursor: pointer;">å››æ¨äº”å…¥</button>
                        <button class="approx-method-btn" data-method="floor" onclick="setApproxMethod('floor')"
                            style="padding: 5px 12px; border-radius: 15px; border: 2px solid #E2E8F0; background: white; color: var(--text); font-size: 0.8rem; cursor: pointer;">åˆ‡ã‚Šæ¨ã¦</button>
                        <button class="approx-method-btn" data-method="ceil" onclick="setApproxMethod('ceil')"
                            style="padding: 5px 12px; border-radius: 15px; border: 2px solid #E2E8F0; background: white; color: var(--text); font-size: 0.8rem; cursor: pointer;">åˆ‡ã‚Šä¸Šã’</button>
                    </div>
                    <div class="approx-content">
                        <div
                            style="display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-light);">è¢«é™¤æ•°</div>
                                <span id="dividendRounded" style="font-size: 1.1rem;">1200</span> â†’ <strong
                                    id="dividendApprox" style="font-size: 1.2rem; color: var(--primary);">1000</strong>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-light);">é™¤æ•°</div>
                                <span id="divisorRounded" style="font-size: 1.1rem;">4</span> â†’ <strong
                                    id="divisorApprox" style="font-size: 1.2rem; color: var(--primary);">4</strong>
                            </div>
                        </div>
                        <div
                            style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                            <span class="approx-calc" id="approxCalc" style="font-size: 1.1rem;">ç´„1000 Ã· 4 = ç´„250</span>
                        </div>
                    </div>
                </div>

                <!-- æ•°ç›´ç·šï¼ˆå¼·åŒ–ç‰ˆï¼‰ -->
                <div class="number-line" id="numberLine">
                    <div class="number-line-title">ğŸ“ æ•°ç›´ç·šã§è€ƒãˆã‚ˆã†</div>
                    <div class="line-container" style="position: relative; height: 60px; margin: 0 20px;">
                        <div class="line-track"
                            style="position: absolute; top: 25px; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, #E2E8F0 0%, var(--primary-light) 100%); border-radius: 3px;">
                        </div>
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºˆæƒ³ãƒãƒ¼ã‚«ãƒ¼ -->
                        <div class="line-marker user-marker" id="userMarker"
                            style="position: absolute; top: 12px; width: 30px; height: 30px; background: var(--secondary); border-radius: 50%; transform: translateX(-50%); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700; left: 50%; opacity: 0.5; transition: all 0.3s;">
                            ï¼Ÿ</div>
                        <!-- æ­£è§£ãƒãƒ¼ã‚«ãƒ¼ï¼ˆè§£ç­”å¾Œã«è¡¨ç¤ºï¼‰ -->
                        <div class="line-marker answer-marker" id="answerMarker"
                            style="position: absolute; top: 12px; width: 30px; height: 30px; background: var(--accent); border-radius: 50%; transform: translateX(-50%); display: none; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700; left: 50%;">
                            âœ“</div>
                    </div>
                    <div class="line-labels"
                        style="display: flex; justify-content: space-between; margin-top: 5px; padding: 0 20px;">
                        <span id="lineMin" style="font-size: 0.85rem; color: var(--text-light);">0</span>
                        <span id="lineMid" style="font-size: 0.85rem; color: var(--text-light);"></span>
                        <span id="lineMax" style="font-size: 0.85rem; color: var(--text-light);">500</span>
                    </div>
                </div>
            </div>


            <!-- ç­†ç®—è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆç­†ç®—ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ -->
            <div class="division-process hidden" id="divisionProcess">
                <div class="division-process-title">âœï¸ ç­†ç®—ã§è¨ˆç®—ã—ã‚ˆã†</div>

                <!-- ç­†ç®—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
                <div class="division-layout" id="divisionLayout"></div>

                <!-- è¨ˆç®—ã‚¹ãƒ†ãƒƒãƒ— -->
                <div class="calc-steps" id="calcSteps">
                    <div class="calc-step current" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">ãŸã¦ã‚‹</div>
                        <div class="step-action">å•†ã‚’ç«‹ã¦ã‚‹</div>
                    </div>
                    <div class="calc-step pending" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">ã‹ã‘ã‚‹</div>
                        <div class="step-action">å•† Ã— é™¤æ•°</div>
                    </div>
                    <div class="calc-step pending" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">ã²ã</div>
                        <div class="step-action">å¼•ãç®—</div>
                    </div>
                    <div class="calc-step pending" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">ãŠã‚ã™</div>
                        <div class="step-action">æ¬¡ã®æ¡ã‚’ãŠã‚ã™</div>
                    </div>
                </div>
            </div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="input-area">
                <div class="input-label" id="inputLabel">ç­”ãˆã‚’é¸ã‚“ã§ã­ï¼</div>

                <!-- ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ -->
                <div class="hint-buttons">
                    <button class="hint-btn" id="hintBtn1" onclick="showHint(1)">ğŸ’¡ ãƒ’ãƒ³ãƒˆ1</button>
                    <button class="hint-btn" id="hintBtn2" onclick="showHint(2)">ğŸ’¡ ãƒ’ãƒ³ãƒˆ2</button>
                    <button class="hint-btn" id="hintBtn3" onclick="showHint(3)">ğŸ’¡ ãƒ’ãƒ³ãƒˆ3</button>
                </div>

                <!-- ãƒ’ãƒ³ãƒˆè¡¨ç¤º -->
                <div class="hint-display" id="hintDisplay">
                    <div class="hint-title" id="hintTitle">ãƒ’ãƒ³ãƒˆ</div>
                    <div class="hint-content" id="hintContent"></div>
                </div>

                <!-- 3æŠãƒ¢ãƒ¼ãƒ‰ -->
                <div id="choiceInputMode" class="input-mode">
                    <div class="choice-buttons" id="choiceButtons"></div>
                </div>

                <!-- æ•°å­—å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
                <div id="numberInputMode" class="input-mode hidden">
                    <div class="input-group">
                        <input type="number" class="answer-input" id="answerInput" placeholder="?" min="1">
                        <span class="times-label" id="unitLabel">å††</span>
                    </div>
                </div>

                <button class="submit-button" id="submitButton" onclick="checkAnswer()">âœ… ç­”ãˆåˆã‚ã›</button>
            </div>

            <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
            <div class="feedback" id="feedback">
                <div class="feedback-icon" id="feedbackIcon">ğŸ‰</div>
                <div class="feedback-title" id="feedbackTitle">ã™ã°ã‚‰ã—ã„ï¼</div>
                <div class="feedback-message" id="feedbackMessage">æ­£è§£ã§ã™ï¼</div>
                <div class="feedback-explanation" id="feedbackExplanation"></div>

                <!-- ä½™ã‚Šãƒã‚§ãƒƒã‚¯ -->
                <div class="remainder-check" id="remainderCheck">
                    <div class="remainder-title">âœ… ä½™ã‚Šã‚’ãƒã‚§ãƒƒã‚¯</div>
                    <div class="remainder-content" id="remainderContent"></div>
                </div>

                <button class="next-button" onclick="nextProblem()">æ¬¡ã®å•é¡Œã¸ â–¶</button>
            </div>

            <!-- æˆé•·ã‚°ãƒ©ãƒ• -->
            <div class="growth-panel" id="growthPanel">
                <div class="growth-title">ğŸ“Š ã‚ãªãŸã®æˆé•·</div>
                <div class="growth-item">
                    <div class="growth-label">
                        <span>æ¦‚æ•°ã®ç†è§£</span>
                        <span id="approxPercent">0%</span>
                    </div>
                    <div class="growth-bar-bg">
                        <div class="growth-bar approx" id="approxBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="growth-item">
                    <div class="growth-label">
                        <span>è¨ˆç®—ã®æ­£ç¢ºã•</span>
                        <span id="calcPercent">0%</span>
                    </div>
                    <div class="growth-bar-bg">
                        <div class="growth-bar calc" id="calcBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="growth-item">
                    <div class="growth-label">
                        <span>ä½™ã‚Šã®ç†è§£</span>
                        <span id="remainderPercent">0%</span>
                    </div>
                    <div class="growth-bar-bg">
                        <div class="growth-bar remainder" id="remainderBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <button class="back-button" onclick="backToTitle()">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ è¨­å®š
        let gameSettings = {
            mode: 'story',
            difficulty: 'easy',
            inputMode: 'choice'
        };

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            dividend: 0,
            divisor: 0,
            correctAnswer: 0,
            remainder: 0,
            userAnswer: 0,
            combo: 0,
            correctCount: 0,
            totalCount: 0,
            hintsUsed: 0,
            currentScenario: null,
            approxSkill: 0,
            calcSkill: 0,
            remainderSkill: 0
        };

        // ãƒãƒˆãƒ«çŠ¶æ…‹
        let battleState = {
            enemyHp: 100,
            enemyMaxHp: 100,
            timer: 30,
            round: 1,
            currentEnemy: null,
            timerInterval: null
        };

        // æ•µã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿
        const enemies = [
            { emoji: 'ğŸ¸', name: 'ã‚ã‚Šç®—ã‚¬ã‚¨ãƒ«', hp: 50 },
            { emoji: 'ğŸ‘»', name: 'ã‚´ãƒ¼ã‚¹ãƒˆ', hp: 75 },
            { emoji: 'ğŸ²', name: 'ãƒ‰ãƒ©ã‚´ãƒ³', hp: 100 },
            { emoji: 'ğŸ‘¾', name: 'ã‚¹ãƒ©ã‚¤ãƒ ', hp: 60 },
            { emoji: 'ğŸ¦‘', name: 'ã‚¤ã‚«ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼', hp: 80 },
            { emoji: 'ğŸ¤–', name: 'ãƒ­ãƒœãƒƒãƒˆ', hp: 90 },
            { emoji: 'ğŸ‘¹', name: 'ã‚ªãƒ¼ã‚¬', hp: 120 },
            { emoji: 'ğŸ§™', name: 'ã¾ã»ã†ã¤ã‹ã„', hp: 85 }
        ];

        // ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ˆã‚Šè‡ªç„¶ãªæ—¥æœ¬èªè¡¨ç¾ã«ä¿®æ­£ï¼‰
        const scenarios = {
            shopping: [
                { icon: 'ğŸ›’', text: 'ã¿ã‚“ãªã§ãŠè²·ã„ç‰©ï¼', template: 'åˆè¨ˆ{dividend}å††ã‚’{divisor}äººã§å‰²ã‚Šå‹˜ã™ã‚‹ã¨ã€1äººã„ãã‚‰æ‰•ã†ï¼Ÿ', unit: 'å††', allowRemainder: true },
                { icon: 'ğŸ°', text: 'ã‚±ãƒ¼ã‚­å±‹ã•ã‚“ã§ï¼', template: '{dividend}å††ã®ã‚±ãƒ¼ã‚­ã‚»ãƒƒãƒˆã‚’{divisor}äººã§åˆ†ã‘ã‚‹ã¨ã€1äººã„ãã‚‰ï¼Ÿ', unit: 'å††', allowRemainder: false },
                { icon: 'ğŸ', text: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆé¸ã³ï¼', template: '{dividend}å††ã®äºˆç®—ã§{divisor}äººåˆ†ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã‚’è²·ã†ã¨ã€1äººåˆ†ã„ãã‚‰ï¼Ÿ', unit: 'å††', allowRemainder: true }
            ],
            party: [
                { icon: 'ğŸ¬', text: 'ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®æº–å‚™ï¼', template: 'ãŠè“å­{dividend}å€‹ã‚’{divisor}äººã§åŒã˜æ•°ãšã¤åˆ†ã‘ã‚‹ã¨ã€1äººä½•å€‹ï¼Ÿ', unit: 'å€‹', allowRemainder: true },
                { icon: 'ğŸ•', text: 'ãƒ”ã‚¶ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ï¼', template: 'ãƒ”ã‚¶ã‚’{dividend}ãƒ”ãƒ¼ã‚¹ã«åˆ‡ã£ã¦{divisor}äººã§åˆ†ã‘ã‚‹ã¨ã€1äººä½•ãƒ”ãƒ¼ã‚¹ï¼Ÿ', unit: 'ãƒ”ãƒ¼ã‚¹', allowRemainder: true },
                { icon: 'ğŸˆ', text: 'é£¾ã‚Šã¤ã‘ï¼', template: 'é¢¨èˆ¹{dividend}å€‹ã‚’{divisor}ã‹æ‰€ã«åŒã˜æ•°ãšã¤é£¾ã‚‹ã¨ã€1ã‹æ‰€ä½•å€‹ï¼Ÿ', unit: 'å€‹', allowRemainder: true }
            ],
            school: [
                { icon: 'ğŸ“š', text: 'æœ¬ã®æ•´ç†ï¼', template: 'æœ¬{dividend}å†Šã‚’1æ®µã«{divisor}å†Šãšã¤ä¸¦ã¹ã‚‹ã¨ã€ä½•æ®µå¿…è¦ï¼Ÿ', unit: 'æ®µ', allowRemainder: true, isContained: true },
                { icon: 'ğŸšŒ', text: 'é è¶³ã®ãƒã‚¹ï¼', template: 'å…ç«¥{dividend}äººã‚’{divisor}äººä¹—ã‚Šã®ãƒã‚¹ã§é‹ã¶ã¨ã€ãƒã‚¹ã¯ä½•å°å¿…è¦ï¼Ÿ', unit: 'å°', allowRemainder: true, isContained: true },
                { icon: 'âœï¸', text: 'ãˆã‚“ã´ã¤é…ã‚Šï¼', template: 'ãˆã‚“ã´ã¤{dividend}æœ¬ã‚’{divisor}äººã«åŒã˜æœ¬æ•°ãšã¤é…ã‚‹ã¨ã€1äººä½•æœ¬ï¼Ÿ', unit: 'æœ¬', allowRemainder: true }
            ]
        };


        // é›£æ˜“åº¦è¨­å®š
        const difficultySettings = {
            easy: { dividendMin: 20, dividendMax: 99, divisorMin: 2, divisorMax: 9 },
            normal: { dividendMin: 100, dividendMax: 999, divisorMin: 10, divisorMax: 50 },
            hard: { dividendMin: 1000, dividendMax: 9999, divisorMin: 10, divisorMax: 99 }

        };

        // ãƒãƒˆãƒ«åˆæœŸåŒ–
        function initBattle() {
            // ãƒ©ãƒ³ãƒ€ãƒ ãªæ•µã‚’ã‚»ãƒƒãƒˆ
            battleState.currentEnemy = enemies[randomInt(0, enemies.length - 1)];
            battleState.enemyMaxHp = battleState.currentEnemy.hp;
            battleState.enemyHp = battleState.currentEnemy.hp;
            battleState.timer = 30;

            document.getElementById('enemyCharacter').textContent = battleState.currentEnemy.emoji;
            document.getElementById('enemyName').textContent = battleState.currentEnemy.name;
            updateBattleHp();
            document.getElementById('battleRound').textContent = `ROUND ${battleState.round}`;
            document.getElementById('battleMessage').textContent = `${battleState.currentEnemy.name}ãŒç¾ã‚ŒãŸï¼ã‚ã‚Šç®—ã§å€’ãã†ï¼`;

            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            startBattleTimer();
        }

        // ãƒãƒˆãƒ«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startBattleTimer() {
            if (battleState.timerInterval) {
                clearInterval(battleState.timerInterval);
            }

            battleState.timer = 30;
            document.getElementById('timerValue').textContent = battleState.timer;
            document.getElementById('battleTimer').classList.remove('warning');

            battleState.timerInterval = setInterval(() => {
                battleState.timer--;
                document.getElementById('timerValue').textContent = battleState.timer;

                if (battleState.timer <= 5) {
                    document.getElementById('battleTimer').classList.add('warning');
                }

                if (battleState.timer <= 0) {
                    clearInterval(battleState.timerInterval);
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼šæ•µã‹ã‚‰åæ’ƒ
                    document.getElementById('battleMessage').textContent = 'æ™‚é–“åˆ‡ã‚Œï¼æ•µã®æ”»æ’ƒã ï¼';
                }
            }, 1000);
        }

        // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        function stopBattleTimer() {
            if (battleState.timerInterval) {
                clearInterval(battleState.timerInterval);
                battleState.timerInterval = null;
            }
        }

        // HPæ›´æ–°
        function updateBattleHp() {
            const hpPercent = Math.max(0, (battleState.enemyHp / battleState.enemyMaxHp) * 100);
            document.getElementById('hpValue').textContent = `${battleState.enemyHp}/${battleState.enemyMaxHp}`;
            document.getElementById('hpFill').style.width = hpPercent + '%';

            if (hpPercent <= 30) {
                document.getElementById('hpFill').classList.add('low');
            } else {
                document.getElementById('hpFill').classList.remove('low');
            }
        }

        // ãƒãƒˆãƒ«çµæœå‡¦ç†
        function processBattleResult(isCorrect) {
            stopBattleTimer();

            if (isCorrect) {
                // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ï¼ˆæ®‹ã‚Šæ™‚é–“ã«å¿œã˜ãŸãƒœãƒ¼ãƒŠã‚¹ï¼‰
                const damage = 20 + Math.floor(battleState.timer * 0.5) + (gameState.combo * 5);
                battleState.enemyHp = Math.max(0, battleState.enemyHp - damage);
                updateBattleHp();

                // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                showDamageEffect(damage);
                document.getElementById('battleMessage').textContent = `${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼æ®‹ã‚ŠHP: ${battleState.enemyHp}`;

                if (battleState.enemyHp <= 0) {
                    // æ•µã‚’å€’ã—ãŸ
                    document.getElementById('battleMessage').textContent = `${battleState.currentEnemy.name}ã‚’å€’ã—ãŸï¼ğŸ‰`;
                    battleState.round++;
                }
            } else {
                document.getElementById('battleMessage').textContent = 'æ”»æ’ƒãŒå¤–ã‚ŒãŸï¼æ¬¡ã¯æ­£è§£ã—ã‚ˆã†ï¼';
            }
        }

        // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
        function showDamageEffect(damage) {
            const effect = document.createElement('div');
            effect.className = 'damage-effect';
            effect.textContent = `-${damage}`;
            effect.style.left = '50%';
            effect.style.top = '50%';
            document.getElementById('battleArea').appendChild(effect);

            setTimeout(() => effect.remove(), 1000);
        }

        // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        function selectMode(mode) {
            gameSettings.mode = mode;
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.mode === mode);
            });
        }

        // é›£æ˜“åº¦è¨­å®š
        function setDifficulty(level) {
            gameSettings.difficulty = level;
            document.querySelectorAll('[data-difficulty]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.difficulty === level);
            });
        }

        // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰è¨­å®š
        function setInputMode(mode) {
            gameSettings.inputMode = mode;
            document.querySelectorAll('[data-input]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.input === mode);
            });
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            document.getElementById('titleScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('active');

            // çŠ¶æ…‹åˆæœŸåŒ–
            gameState.combo = 0;
            gameState.correctCount = 0;
            gameState.totalCount = 0;

            loadProgress();
            generateProblem();
        }

        // å•é¡Œç”Ÿæˆ
        function generateProblem() {
            const settings = difficultySettings[gameSettings.difficulty];

            // å‰²ã‚Šåˆ‡ã‚Œã‚‹å•é¡Œã‚’ç”Ÿæˆ
            gameState.divisor = randomInt(settings.divisorMin, settings.divisorMax);
            const quotient = randomInt(2, Math.floor(settings.dividendMax / gameState.divisor));
            gameState.dividend = quotient * gameState.divisor + randomInt(0, gameState.divisor - 1);
            gameState.correctAnswer = Math.floor(gameState.dividend / gameState.divisor);
            gameState.remainder = gameState.dividend % gameState.divisor;

            // ã‚·ãƒŠãƒªã‚ªé¸æŠ
            const categoryKeys = Object.keys(scenarios);
            const category = categoryKeys[randomInt(0, categoryKeys.length - 1)];
            const scenarioList = scenarios[category];
            gameState.currentScenario = scenarioList[randomInt(0, scenarioList.length - 1)];

            // UIæ›´æ–°
            updateProblemDisplay();
            updateApproxHint();
            updateNumberLine();
            resetHints();

            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('divisionProcess').classList.add('hidden');
            document.getElementById('scenarioDisplay').classList.add('hidden');
            document.getElementById('approxHint').classList.add('hidden');
            document.getElementById('numberLine').classList.add('hidden');

            if (gameSettings.mode === 'written') {
                // ç­†ç®—ãƒ¢ãƒ¼ãƒ‰
                document.getElementById('approxHint').classList.add('hidden');
                document.getElementById('numberLine').classList.add('hidden');
                document.getElementById('divisionProcess').classList.remove('hidden');
                initWrittenDivision();
            } else if (gameSettings.mode === 'battle') {
                // ãƒãƒˆãƒ«ãƒ¢ãƒ¼ãƒ‰
                document.getElementById('battleArea').classList.remove('hidden');
                document.getElementById('approxHint').classList.remove('hidden');
                document.getElementById('numberLine').classList.remove('hidden');
                initBattle();
            } else if (gameSettings.mode === 'story') {
                // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰
                document.getElementById('scenarioDisplay').classList.remove('hidden');
                document.getElementById('approxHint').classList.remove('hidden');
                document.getElementById('numberLine').classList.remove('hidden');
            } else {
                // è¦‹ç©ã‚‚ã‚Šãƒ¢ãƒ¼ãƒ‰
                document.getElementById('approxHint').classList.remove('hidden');
                document.getElementById('numberLine').classList.remove('hidden');
            }

            if (gameSettings.inputMode === 'choice') {
                document.getElementById('choiceInputMode').classList.remove('hidden');
                document.getElementById('numberInputMode').classList.add('hidden');
                generateChoices();
            } else {
                document.getElementById('choiceInputMode').classList.add('hidden');
                document.getElementById('numberInputMode').classList.remove('hidden');
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').focus();
            }

            document.getElementById('feedback').classList.remove('show');
            document.getElementById('submitButton').disabled = false;
            gameState.userAnswer = 0;
        }

        // å•é¡Œè¡¨ç¤ºæ›´æ–°
        function updateProblemDisplay() {
            const scenario = gameState.currentScenario;

            if (gameSettings.mode === 'story' && scenario) {
                document.getElementById('scenarioDisplay').classList.remove('hidden');
                document.getElementById('scenarioIcon').textContent = scenario.icon;
                document.getElementById('scenarioText').innerHTML = scenario.text + '<br><span class="scenario-highlight">' +
                    scenario.template.replace('{dividend}', gameState.dividend).replace('{divisor}', gameState.divisor) + '</span>';
                document.getElementById('unitLabel').textContent = scenario.unit;
            } else {
                document.getElementById('scenarioDisplay').classList.add('hidden');
                document.getElementById('unitLabel').textContent = '';
            }

            document.getElementById('dividend').textContent = gameState.dividend;
            document.getElementById('divisor').textContent = gameState.divisor;
        }

        // ç­†ç®—åˆæœŸåŒ–
        function initWrittenDivision() {
            const dividendStr = gameState.dividend.toString();
            const divisorStr = gameState.divisor.toString();

            const layout = document.getElementById('divisionLayout');
            layout.innerHTML = '';

            // ç­†ç®—ã®ä¸Šéƒ¨ï¼ˆå•†ã®ä½ç½®ï¼‰
            const quotientRow = document.createElement('div');
            quotientRow.className = 'division-row';
            quotientRow.innerHTML = `<div class="division-cell" style="visibility: hidden;"></div>`;
            for (let i = 0; i < dividendStr.length; i++) {
                quotientRow.innerHTML += `<div class="division-cell quotient empty" id="quotient-${i}">?</div>`;
            }
            layout.appendChild(quotientRow);

            // é™¤æ•°ã¨è¢«é™¤æ•°ã®è¡Œ
            const mainRow = document.createElement('div');
            mainRow.className = 'division-row';
            mainRow.innerHTML = `
                <div class="division-cell divisor">${divisorStr}</div>
                <span class="division-symbol">)</span>
            `;
            for (let i = 0; i < dividendStr.length; i++) {
                mainRow.innerHTML += `<div class="division-cell dividend">${dividendStr[i]}</div>`;
            }
            layout.appendChild(mainRow);

            // è¨ˆç®—ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.calc-step').forEach((step, index) => {
                step.classList.remove('current', 'completed');
                if (index === 0) {
                    step.classList.add('current');
                } else {
                    step.classList.add('pending');
                }
            });
        }

        // ç­†ç®—ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€²ã‚ã‚‹
        function advanceWrittenStep(stepNum) {
            document.querySelectorAll('.calc-step').forEach((step, index) => {
                step.classList.remove('current', 'completed', 'pending');
                if (index < stepNum) {
                    step.classList.add('completed');
                } else if (index === stepNum) {
                    step.classList.add('current');
                } else {
                    step.classList.add('pending');
                }
            });
        }

        // ç¾åœ¨ã®æ¦‚æ•°è¨ˆç®—æ–¹æ³•
        let currentApproxMethod = 'round'; // 'round', 'floor', 'ceil'

        // æ¦‚æ•°è¨ˆç®—æ–¹æ³•ã‚’è¨­å®š
        function setApproxMethod(method) {
            currentApproxMethod = method;
            document.querySelectorAll('.approx-method-btn').forEach(btn => {
                if (btn.dataset.method === method) {
                    btn.style.background = 'var(--primary)';
                    btn.style.borderColor = 'var(--primary)';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'white';
                    btn.style.borderColor = '#E2E8F0';
                    btn.style.color = 'var(--text)';
                    btn.classList.remove('active');
                }
            });
            updateApproxHint();
        }

        // æ¦‚æ•°ãƒ’ãƒ³ãƒˆæ›´æ–°ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function updateApproxHint() {
            const dividendApprox = roundToFirstDigitWithMethod(gameState.dividend, currentApproxMethod);
            const divisorApprox = roundToFirstDigitWithMethod(gameState.divisor, currentApproxMethod);
            const approxAnswer = Math.floor(dividendApprox / divisorApprox);

            document.getElementById('dividendRounded').textContent = gameState.dividend;
            document.getElementById('dividendApprox').textContent = dividendApprox;
            document.getElementById('divisorRounded').textContent = gameState.divisor;
            document.getElementById('divisorApprox').textContent = divisorApprox;

            const methodName = currentApproxMethod === 'round' ? 'å››æ¨äº”å…¥' :
                (currentApproxMethod === 'floor' ? 'åˆ‡ã‚Šæ¨ã¦' : 'åˆ‡ã‚Šä¸Šã’');
            document.getElementById('approxCalc').innerHTML = `<span style="font-size:0.8rem;color:var(--text-light);">(${methodName})</span> ç´„${dividendApprox} Ã· ${divisorApprox} = <strong style="color:var(--primary);">ç´„${approxAnswer}</strong>`;
        }

        // æ•°ç›´ç·šæ›´æ–°ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function updateNumberLine() {
            const maxValue = Math.ceil(gameState.correctAnswer * 1.5 / 10) * 10;
            const minValue = 0;
            const midValue = Math.floor(maxValue / 2);

            document.getElementById('lineMin').textContent = minValue;
            document.getElementById('lineMid').textContent = midValue;
            document.getElementById('lineMax').textContent = maxValue;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            const userMarker = document.getElementById('userMarker');
            userMarker.textContent = 'ï¼Ÿ';
            userMarker.style.left = '50%';
            userMarker.style.opacity = '0.5';
            userMarker.style.display = 'flex';

            // æ­£è§£ãƒãƒ¼ã‚«ãƒ¼ã‚’éè¡¨ç¤º
            const answerMarker = document.getElementById('answerMarker');
            answerMarker.style.display = 'none';
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
        function updateUserMarker(value) {
            const maxValue = parseInt(document.getElementById('lineMax').textContent);
            const position = Math.min(100, Math.max(0, (value / maxValue) * 100));

            const userMarker = document.getElementById('userMarker');
            userMarker.textContent = value;
            userMarker.style.left = position + '%';
            userMarker.style.opacity = '1';
        }

        // æ­£è§£ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
        function showAnswerMarker() {
            const maxValue = parseInt(document.getElementById('lineMax').textContent);
            const position = Math.min(100, Math.max(0, (gameState.correctAnswer / maxValue) * 100));

            const answerMarker = document.getElementById('answerMarker');
            answerMarker.textContent = gameState.correctAnswer;
            answerMarker.style.left = position + '%';
            answerMarker.style.display = 'flex';
        }

        // ä¸Šã‹ã‚‰1æ¡ã«ä¸¸ã‚ã‚‹ï¼ˆæ–¹å¼é¸æŠå¯èƒ½ï¼‰
        function roundToFirstDigitWithMethod(num, method) {
            if (num < 10) return num;
            const digits = num.toString().length;
            const divisor = Math.pow(10, digits - 1);

            switch (method) {
                case 'floor':
                    return Math.floor(num / divisor) * divisor;
                case 'ceil':
                    return Math.ceil(num / divisor) * divisor;
                case 'round':
                default:
                    return Math.round(num / divisor) * divisor;
            }
        }

        // ä¸Šã‹ã‚‰1æ¡ã«ä¸¸ã‚ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: å››æ¨äº”å…¥ï¼‰
        function roundToFirstDigit(num) {
            return roundToFirstDigitWithMethod(num, 'round');
        }

        // ãƒ©ãƒ³ãƒ€ãƒ æ•´æ•°
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }


        // 3æŠç”Ÿæˆ
        function generateChoices() {
            const correct = gameState.correctAnswer;
            const choices = [correct];

            while (choices.length < 3) {
                const offset = randomInt(-5, 5);
                if (offset === 0) continue;
                const choice = correct + offset;
                if (choice > 0 && !choices.includes(choice)) {
                    choices.push(choice);
                }
            }

            choices.sort(() => Math.random() - 0.5);

            const container = document.getElementById('choiceButtons');
            container.innerHTML = '';
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice;
                btn.onclick = () => selectChoice(btn, choice);
                container.appendChild(btn);
            });
        }

        // é¸æŠè‚¢é¸æŠ
        function selectChoice(btn, value) {
            document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            gameState.userAnswer = value;

            // æ•°ç›´ç·šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
            updateUserMarker(value);
        }

        // ãƒ’ãƒ³ãƒˆè¡¨ç¤ºï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function showHint(level) {
            const hintDisplay = document.getElementById('hintDisplay');
            const hintContent = document.getElementById('hintContent');
            const hintTitle = document.getElementById('hintTitle');

            // ç¾åœ¨é¸æŠä¸­ã®æ¦‚æ•°è¨ˆç®—æ–¹æ³•ã‚’ä½¿ç”¨
            const dividendApprox = roundToFirstDigitWithMethod(gameState.dividend, currentApproxMethod);
            const divisorApprox = roundToFirstDigitWithMethod(gameState.divisor, currentApproxMethod);
            const approxAnswer = Math.floor(dividendApprox / divisorApprox);

            const methodName = currentApproxMethod === 'round' ? 'å››æ¨äº”å…¥' :
                (currentApproxMethod === 'floor' ? 'åˆ‡ã‚Šæ¨ã¦' : 'åˆ‡ã‚Šä¸Šã’');

            let content = '';
            let icon = '';
            switch (level) {
                case 1:
                    icon = 'ğŸ”';
                    content = `<strong>è€ƒãˆæ–¹ã®ã‚³ãƒ„</strong><br>
                        ä¸Šã‹ã‚‰1ã‘ãŸã®æ¦‚æ•°ï¼ˆãŒã„ã™ã†ï¼‰ã«ã—ã¦è€ƒãˆã¦ã¿ã‚ˆã†ï¼<br>
                        <small style="color:var(--text-light);">ä¾‹: 234 â†’ ç´„200ã€47 â†’ ç´„50</small>`;
                    break;
                case 2:
                    icon = 'ğŸ“';
                    content = `<strong>${methodName}ã§æ¦‚æ•°ã«ã™ã‚‹ã¨...</strong><br>
                        ${gameState.dividend} â†’ <strong style="color:var(--primary);">ç´„${dividendApprox}</strong><br>
                        ${gameState.divisor} â†’ <strong style="color:var(--primary);">ç´„${divisorApprox}</strong><br>
                        <small style="color:var(--text-light);">ã“ã®2ã¤ã®æ•°ã§è¨ˆç®—ã—ã¦ã¿ã‚ˆã†ï¼</small>`;
                    break;
                case 3:
                    icon = 'ğŸ¯';
                    content = `<strong>è¦‹å½“ãŒã¤ã„ãŸã‚ˆï¼</strong><br>
                        ç´„${dividendApprox} Ã· ${divisorApprox} = <strong style="color:var(--accent);font-size:1.2em;">ç´„${approxAnswer}</strong><br>
                        ç­”ãˆã¯ <strong>${approxAnswer}</strong> ã«è¿‘ã„æ•°ã«ãªã‚‹ã¯ãšï¼<br>
                        <small style="color:var(--text-light);">âœ“ ã“ã‚Œã‚ˆã‚Šå°‘ã—å¤§ãã„ã‹å°ã•ã„ã‹ã‚‚ç¢ºèªã—ã‚ˆã†</small>`;
                    break;
            }

            hintTitle.innerHTML = `${icon} ãƒ’ãƒ³ãƒˆ ${level}`;
            hintContent.innerHTML = content;
            hintDisplay.classList.add('show');

            // ãƒ’ãƒ³ãƒˆä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
            for (let i = 1; i <= level; i++) {
                document.getElementById(`hintBtn${i}`).disabled = true;
            }
            gameState.hintsUsed = Math.max(gameState.hintsUsed, level);
        }

        // ãƒ’ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
        function resetHints() {
            document.getElementById('hintDisplay').classList.remove('show');
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`hintBtn${i}`).disabled = false;
            }
            gameState.hintsUsed = 0;
        }

        // å›ç­”ãƒã‚§ãƒƒã‚¯
        function checkAnswer() {
            if (gameSettings.inputMode === 'number') {
                gameState.userAnswer = parseInt(document.getElementById('answerInput').value);
            }

            if (!gameState.userAnswer || gameState.userAnswer < 1) {
                alert('ç­”ãˆã‚’é¸ã‚“ã§ã­ï¼');
                return;
            }

            gameState.totalCount++;
            const isCorrect = gameState.userAnswer === gameState.correctAnswer;
            const diff = Math.abs(gameState.userAnswer - gameState.correctAnswer);

            let icon, title, message, titleClass;

            if (isCorrect) {
                icon = 'ğŸ‰';
                title = 'â— å®Œç’§ï¼';
                message = 'ã™ã°ã‚‰ã—ã„ï¼æ­£ç¢ºã«è¨ˆç®—ã§ããŸã­ï¼';
                titleClass = 'perfect';
                gameState.correctCount++;
                gameState.combo++;
                gameState.calcSkill = Math.min(100, gameState.calcSkill + 5);
            } else if (diff <= 2) {
                icon = 'ğŸ‘';
                title = 'â—‹ ãŠã—ã„ï¼';
                message = 'ã„ã„æ„Ÿã˜ï¼ã‚‚ã†å°‘ã—ã§æ­£è§£ã ã£ãŸã­ï¼';
                titleClass = 'good';
                gameState.combo = 0;
                gameState.approxSkill = Math.min(100, gameState.approxSkill + 3);
            } else {
                icon = 'ğŸ’¡';
                title = 'â–³ ã‚‚ã†ä¸€åº¦ï¼';
                message = 'æ¦‚æ•°ã‚’ä½¿ã£ã¦è¦‹å½“ã‚’ã¤ã‘ã¦ã¿ã‚ˆã†ï¼';
                titleClass = 'ok';
                gameState.combo = 0;
            }

            // æ¦‚æ•°ä½¿ç”¨ã§ãƒœãƒ¼ãƒŠã‚¹
            if (gameState.hintsUsed > 0 && isCorrect) {
                gameState.approxSkill = Math.min(100, gameState.approxSkill + 3);
            }

            // ãƒãƒˆãƒ«ãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†
            if (gameSettings.mode === 'battle') {
                processBattleResult(isCorrect);
            }

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
            document.getElementById('feedbackIcon').textContent = icon;
            document.getElementById('feedbackTitle').textContent = title;
            document.getElementById('feedbackTitle').className = 'feedback-title ' + titleClass;
            document.getElementById('feedbackMessage').textContent = message;

            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸå˜ä½è¡¨ç¤º
            const unitText = (gameSettings.mode === 'story' && gameState.currentScenario) ? gameState.currentScenario.unit : '';

            // ã¤ã¾ãšãå¯¾å¿œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            let stumbleAdvice = '';
            if (!isCorrect) {
                if (diff <= 3) {
                    stumbleAdvice = `<div style="background:#FEF3C7;padding:10px;border-radius:8px;margin-top:10px;">
                        <strong>ğŸ’­ ãƒ’ãƒ³ãƒˆï¼š</strong>æ¦‚æ•°ã§è¦‹å½“ã‚’ã¤ã‘ã‚‹ã¨ãã€è¢«é™¤æ•°ã¨é™¤æ•°ã‚’ä¸Šã‹ã‚‰1ã‘ãŸã®æ¦‚æ•°ã«ã—ã¦è€ƒãˆã¦ã¿ã‚ˆã†ï¼
                    </div>`;
                } else {
                    stumbleAdvice = `<div style="background:#FEE2E2;padding:10px;border-radius:8px;margin-top:10px;">
                        <strong>ğŸ“š å¾©ç¿’ï¼š</strong>${gameState.dividend}ã‚’${gameState.divisor}ã§å‰²ã‚‹ã¨ãã€ã¾ãšã€Œ${gameState.divisor}ãŒä½•å›å…¥ã‚‹ã‹ã€ã‚’è€ƒãˆã‚ˆã†ã€‚
                        <br>ä¾‹: ${roundToFirstDigit(gameState.dividend)} Ã· ${roundToFirstDigit(gameState.divisor)} = ç´„${Math.floor(roundToFirstDigit(gameState.dividend) / roundToFirstDigit(gameState.divisor))} ã¨è¦‹å½“ãŒã¤ãã‚ˆï¼
                    </div>`;
                }
            }

            // è§£èª¬
            const explanation = `
                <strong>æ­£è§£: ${gameState.correctAnswer}${unitText}</strong><br><br>
                ${gameState.dividend} Ã· ${gameState.divisor} = ${gameState.correctAnswer}${gameState.remainder > 0 ? ' ä½™ã‚Š ' + gameState.remainder : ''}<br><br>
                ğŸ’¡ <strong>è€ƒãˆæ–¹:</strong><br>
                ${getRoundingHint()}
                ${stumbleAdvice}
            `;
            document.getElementById('feedbackExplanation').innerHTML = explanation;

            // ä½™ã‚Šãƒã‚§ãƒƒã‚¯
            const remainderCheck = document.getElementById('remainderCheck');
            const remainderContent = document.getElementById('remainderContent');
            if (gameState.remainder > 0) {
                remainderCheck.style.display = 'block';
                const isRemainderCorrect = gameState.remainder < gameState.divisor;
                remainderContent.innerHTML = `
                    ä½™ã‚Š (${gameState.remainder}) ${isRemainderCorrect ? '<' : 'â‰¥'} å‰²ã‚‹æ•° (${gameState.divisor}) 
                    ${isRemainderCorrect ? '<span class="remainder-ok">âœ“ OKï¼</span>' : '<span class="remainder-ng">âœ— ç¢ºèªã—ã‚ˆã†</span>'}
                    <br><small>ğŸ’¡ ä½™ã‚Šã¯å‰²ã‚‹æ•°ã‚ˆã‚Šå°ã•ããªã‚‹ã‚ˆï¼</small>
                `;
                if (isRemainderCorrect) {
                    gameState.remainderSkill = Math.min(100, gameState.remainderSkill + 2);
                }
            } else {
                remainderCheck.style.display = 'none';
            }

            // æ•°ç›´ç·šæ›´æ–°
            updateNumberLineWithAnswer();

            document.getElementById('feedback').classList.add('show');
            document.getElementById('submitButton').disabled = true;

            updateScore();
            updateGrowth();
            saveProgress();
        }

        // ä¸¸ã‚æ–¹ã®ãƒ’ãƒ³ãƒˆ
        function getRoundingHint() {
            const dividendApprox = roundToFirstDigit(gameState.dividend);
            const divisorApprox = roundToFirstDigit(gameState.divisor);
            const approxAnswer = Math.floor(dividendApprox / divisorApprox);

            return `${gameState.dividend} â†’ ç´„${dividendApprox}ã€${gameState.divisor} â†’ ç´„${divisorApprox} ã¨è€ƒãˆã‚‹ã¨<br>
                    ç´„${dividendApprox} Ã· ${divisorApprox} = ç´„${approxAnswer} ã¨è¦‹å½“ãŒã¤ãã‚ˆï¼`;
        }

        // æ•°ç›´ç·šã«ç­”ãˆè¡¨ç¤º
        function updateNumberLineWithAnswer() {
            // æ­£è§£ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
            showAnswerMarker();
        }

        // ã‚¹ã‚³ã‚¢æ›´æ–°
        function updateScore() {
            document.getElementById('totalCount').textContent = gameState.totalCount;
            document.getElementById('correctCount').textContent = gameState.correctCount;
            document.getElementById('comboCount').textContent = gameState.combo;

            const accuracy = gameState.totalCount > 0 ? Math.round((gameState.correctCount / gameState.totalCount) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // æˆé•·ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateGrowth() {
            document.getElementById('approxBar').style.width = gameState.approxSkill + '%';
            document.getElementById('approxPercent').textContent = gameState.approxSkill + '%';

            document.getElementById('calcBar').style.width = gameState.calcSkill + '%';
            document.getElementById('calcPercent').textContent = gameState.calcSkill + '%';

            document.getElementById('remainderBar').style.width = gameState.remainderSkill + '%';
            document.getElementById('remainderPercent').textContent = gameState.remainderSkill + '%';
        }

        // æ¬¡ã®å•é¡Œ
        function nextProblem() {
            generateProblem();
        }

        // ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
        function backToTitle() {
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('titleScreen').classList.remove('hidden');
        }

        // é€²æ—ä¿å­˜
        function saveProgress() {
            localStorage.setItem('divisionMaster', JSON.stringify({
                approxSkill: gameState.approxSkill,
                calcSkill: gameState.calcSkill,
                remainderSkill: gameState.remainderSkill,
                totalCount: gameState.totalCount,
                correctCount: gameState.correctCount
            }));
        }

        // é€²æ—èª­ã¿è¾¼ã¿
        function loadProgress() {
            const saved = localStorage.getItem('divisionMaster');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.approxSkill = data.approxSkill || 0;
                gameState.calcSkill = data.calcSkill || 0;
                gameState.remainderSkill = data.remainderSkill || 0;
            }
            updateGrowth();
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('answerInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') checkAnswer();
            });
        });
    </script>
</body>

</html>