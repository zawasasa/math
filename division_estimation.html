<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†ã®è¦‹ç«‹ã¦ãƒãƒˆãƒ« - ã•ã•ã£ã¨ç®—æ•°</title>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@500&family=M+PLUS+Rounded+1c:wght@800&display=swap" rel="stylesheet">
    <style>
        :root {
            --orange: #FF9AA2;
            --yellow: #FFDAC1;
            --light-green: #E2F0CB;
            --light-blue: #B5EAD7;
            --text: #6B5B95;
            --white: #FFFFF0;
            --font-main: 'M PLUS Rounded 1c', sans-serif;
            --font-title: 'Kiwi Maru', serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--light-green) 0%, var(--light-blue) 100%);
            background-image:
                radial-gradient(rgba(255,255,255,0.3) 15%, transparent 16%),
                radial-gradient(rgba(255,255,255,0.3) 15%, transparent 16%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
        .title-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .game-title {
            font-family: var(--font-title);
            font-size: 3rem;
            color: var(--text);
            text-shadow: 3px 3px 0 var(--white);
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .game-subtitle {
            font-size: 1.3rem;
            color: var(--text);
            margin-bottom: 40px;
            line-height: 1.8;
        }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        .settings-panel {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-label {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text);
            margin-bottom: 15px;
            display: block;
        }

        .option-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .option-btn {
            background: white;
            border: 3px solid var(--text);
            color: var(--text);
            font-size: 1.1rem;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .option-btn.active {
            background: var(--orange);
            border-color: var(--orange);
            color: white;
        }

        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #CCC;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .switch.active {
            background: var(--light-blue);
        }

        .switch-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .switch.active .switch-knob {
            transform: translateX(30px);
        }

        .start-button, .next-button, .back-button {
            background: linear-gradient(135deg, var(--orange) 0%, #FF8A95 100%);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 20px 60px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #E07A86;
            transition: all 0.2s;
            margin: 10px;
        }

        .start-button:hover, .next-button:hover, .back-button:hover {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #E07A86;
        }

        .start-button:active, .next-button:active, .back-button:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        .back-button {
            background: linear-gradient(135deg, var(--light-blue) 0%, #A0D9C4 100%);
            box-shadow: 0 6px 0 #8AC4AF;
            font-size: 1.2rem;
            padding: 15px 40px;
        }

        .back-button:hover {
            box-shadow: 0 3px 0 #8AC4AF;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        .game-screen {
            display: none;
        }

        .score-board {
            background: var(--white);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--text);
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text);
        }

        /* ãƒãƒƒã‚¸ã‚¨ãƒªã‚¢ */
        .badges-area {
            background: var(--yellow);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .badges-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text);
        }

        .badges-list {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .badge {
            background: white;
            border-radius: 15px;
            padding: 15px;
            min-width: 100px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            opacity: 0.3;
            transition: all 0.3s;
        }

        .badge.unlocked {
            opacity: 1;
            transform: scale(1.05);
            animation: badgeUnlock 0.5s ease-out;
        }

        @keyframes badgeUnlock {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1.05) rotate(0deg); opacity: 1; }
        }

        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }

        .badge-name {
            font-size: 0.8rem;
            color: var(--text);
            font-weight: bold;
        }

        /* ãƒãƒˆãƒ«ç”»é¢ */
        .battle-area {
            background: var(--white);
            border-radius: 20px;
            padding: 40px 20px;
            margin-bottom: 30px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .monster {
            margin-bottom: 30px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .monster-icon {
            font-size: 6rem;
            margin-bottom: 15px;
        }

        .hp-label {
            font-size: 1.2rem;
            color: var(--text);
            margin-bottom: 10px;
        }

        .hp-value {
            font-size: 4rem;
            font-weight: bold;
            color: var(--orange);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }

        /* HPãƒãƒ¼ */
        .hp-bar-container {
            width: 80%;
            max-width: 400px;
            height: 30px;
            background: #DDD;
            border-radius: 15px;
            margin: 20px auto;
            overflow: hidden;
            border: 3px solid var(--text);
            position: relative;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 50%, #CDDC39 100%);
            width: 100%;
            transition: width 0.8s ease-out, background 0.5s;
            border-radius: 12px;
        }

        .hp-bar.low {
            background: linear-gradient(90deg, #FF9800 0%, #FFC107 100%);
        }

        .hp-bar.critical {
            background: linear-gradient(90deg, #F44336 0%, #FF5252 100%);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ãƒ€ãƒ¡ãƒ¼ã‚¸æ•°å€¤ */
        .damage-number {
            position: absolute;
            font-size: 3rem;
            font-weight: bold;
            color: #FF6B6B;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            pointer-events: none;
            animation: damageFloat 1s ease-out forwards;
            z-index: 1000;
        }

        @keyframes damageFloat {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 1;
            }
            50% {
                transform: translateY(-50px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }

        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
        .particle {
            position: absolute;
            font-size: 2rem;
            pointer-events: none;
            animation: particleFloat 1.5s ease-out forwards;
            z-index: 999;
        }

        @keyframes particleFloat {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) rotate(720deg) scale(0);
                opacity: 0;
            }
        }

        /* ç”»é¢ã‚·ã‚§ã‚¤ã‚¯ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        /* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ */
        .monster.damaged {
            animation: monsterDamage 0.5s;
        }

        @keyframes monsterDamage {
            0%, 100% { transform: translateY(0) scale(1); filter: brightness(1); }
            25% { transform: translateY(-10px) scale(1.1); filter: brightness(1.5); }
            50% { transform: translateY(5px) scale(0.95); filter: brightness(0.8); }
            75% { transform: translateY(-5px) scale(1.05); filter: brightness(1.2); }
        }

        /* ã‚³ãƒ³ãƒœç‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .combo-fire {
            position: relative;
        }

        .combo-fire::before {
            content: 'ğŸ”¥';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            animation: fireFlicker 0.3s infinite;
        }

        @keyframes fireFlicker {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 0.8; }
        }

        /* ç´™å¹é›ª */
        .confetti {
            position: absolute;
            font-size: 1.5rem;
            pointer-events: none;
            animation: confettiFall 3s ease-out forwards;
            z-index: 1001;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(500px) rotate(720deg);
                opacity: 0;
            }
        }

        /* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼æ’ƒç ´æ¼”å‡º */
        .monster.defeated {
            animation: monsterDefeat 1s forwards;
        }

        @keyframes monsterDefeat {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 0.5;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }

        /* çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .explosion {
            position: absolute;
            font-size: 5rem;
            pointer-events: none;
            animation: explode 1s ease-out forwards;
            z-index: 1002;
        }

        @keyframes explode {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        /* èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
        .flash-gold {
            animation: flashGold 0.5s;
        }

        @keyframes flashGold {
            0%, 100% { background: var(--white); }
            50% { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        }

        .flash-silver {
            animation: flashSilver 0.5s;
        }

        @keyframes flashSilver {
            0%, 100% { background: var(--white); }
            50% { background: linear-gradient(135deg, #C0C0C0 0%, #E8E8E8 100%); }
        }

        /* è¶…ã‚³ãƒ³ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .super-combo {
            position: relative;
        }

        .super-combo::after {
            content: 'âš¡';
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            animation: lightning 0.2s infinite;
        }

        @keyframes lightning {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.5; transform: translateX(-50%) scale(1.3); }
        }

        .mega-combo {
            position: relative;
        }

        .mega-combo::after {
            content: 'ğŸŒˆ';
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            animation: rainbow 1s infinite;
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* ãƒœã‚¿ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¼·åŒ– */
        .submit-button {
            position: relative;
            overflow: hidden;
        }

        .submit-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .submit-button:active::before {
            width: 300px;
            height: 300px;
        }

        .vs-divider {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text);
            margin: 30px 0;
        }

        .attack-section {
            margin-bottom: 30px;
        }

        .attack-label {
            font-size: 1.2rem;
            color: var(--text);
            margin-bottom: 10px;
        }

        .attack-value {
            font-size: 3rem;
            font-weight: bold;
            color: var(--light-blue);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area {
            background: var(--yellow);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .input-label {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text);
            margin-bottom: 20px;
            text-align: center;
        }

        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .answer-input {
            font-family: var(--font-main);
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            width: 200px;
            padding: 15px;
            border: 4px solid var(--text);
            border-radius: 15px;
            background: white;
            color: var(--text);
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 4px rgba(255, 154, 162, 0.3);
        }

        /* 3æŠãƒ¢ãƒ¼ãƒ‰ */
        .choice-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .choice-btn {
            background: white;
            border: 4px solid var(--text);
            color: var(--text);
            font-size: 2.5rem;
            font-weight: bold;
            padding: 20px 40px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }

        .choice-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .choice-btn.selected {
            background: var(--orange);
            border-color: var(--orange);
            color: white;
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ */
        .slider-container {
            margin-bottom: 30px;
        }

        .slider-value {
            font-size: 3rem;
            font-weight: bold;
            color: var(--text);
            margin-bottom: 20px;
            text-align: center;
        }

        .slider {
            width: 100%;
            height: 15px;
            border-radius: 10px;
            background: #DDD;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 10px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--orange);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--orange);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text);
            opacity: 0.7;
        }

        .times-label {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text);
        }

        .submit-button {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%);
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            padding: 20px 50px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #D84343;
            transition: all 0.2s;
            display: block;
            margin: 0 auto;
        }

        .submit-button:hover {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #D84343;
        }

        .submit-button:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        .submit-button:disabled {
            background: #CCC;
            box-shadow: 0 6px 0 #AAA;
            cursor: not-allowed;
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        .feedback {
            display: none;
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback.show {
            display: block;
        }

        .feedback-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .feedback-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .feedback-message {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .feedback-explanation {
            background: var(--light-green);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            line-height: 1.8;
        }

        .feedback-perfect {
            color: #FF6B6B;
        }

        .feedback-good {
            color: #FFA500;
        }

        .feedback-ok {
            color: #4CAF50;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }

            .monster-icon {
                font-size: 4rem;
            }

            .hp-value {
                font-size: 3rem;
            }

            .attack-value {
                font-size: 2rem;
            }

            .answer-input {
                font-size: 2rem;
                width: 150px;
            }

            .choice-btn {
                font-size: 2rem;
                padding: 15px 30px;
                min-width: 100px;
            }

            .submit-button {
                font-size: 1.5rem;
                padding: 15px 40px;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 1.5rem;
            }

            .answer-input {
                font-size: 1.8rem;
                width: 120px;
            }

            .choice-btn {
                font-size: 1.8rem;
                padding: 12px 25px;
            }

            .score-board {
                flex-direction: column;
            }

            .option-buttons {
                flex-direction: column;
            }

            .option-btn {
                width: 100%;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div class="title-screen" id="titleScreen">
            <h1 class="game-title">âš”ï¸ å•†ã®è¦‹ç«‹ã¦ãƒãƒˆãƒ« âš”ï¸</h1>
            <p class="game-subtitle">
                ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®HPã‚’è¦‹ã¦ã€<br>
                ä½•å›æ”»æ’ƒã™ã‚Œã°å€’ã›ã‚‹ã‹è¦‹ç«‹ã¦ã‚ˆã†ï¼<br>
                <strong>ã€Œã ã„ãŸã„ä½•å€ã‹ã€</strong>ã‚’æ„Ÿè¦šã§æ´ã‚€ç·´ç¿’ã ã‚ˆğŸ¯
            </p>

            <!-- è¨­å®šãƒ‘ãƒãƒ« -->
            <div class="settings-panel">
                <div class="setting-group">
                    <label class="setting-label">ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰</label>
                    <div class="option-buttons">
                        <button class="option-btn active" data-gamemode="endless" onclick="setGameMode('endless')">
                            â™¾ï¸ ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹<br><small>(è‡ªç”±ç·´ç¿’)</small>
                        </button>
                        <button class="option-btn" data-gamemode="timeattack" onclick="setGameMode('timeattack')">
                            â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯<br><small>(60ç§’)</small>
                        </button>
                        <button class="option-btn" data-gamemode="survival" onclick="setGameMode('survival')">
                            â¤ï¸ ã‚µãƒã‚¤ãƒãƒ«<br><small>(ãƒŸã‚¹3å›)</small>
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">é›£æ˜“åº¦</label>
                    <div class="option-buttons">
                        <button class="option-btn active" data-difficulty="easy" onclick="setDifficulty('easy')">
                            ğŸ˜Š ç°¡å˜<br><small>(2æ¡Ã·2æ¡)</small>
                        </button>
                        <button class="option-btn" data-difficulty="normal" onclick="setDifficulty('normal')">
                            ğŸ˜ æ™®é€š<br><small>(3æ¡Ã·2æ¡)</small>
                        </button>
                        <button class="option-btn" data-difficulty="hard" onclick="setDifficulty('hard')">
                            ğŸ˜¤ é›£ã—ã„<br><small>(4æ¡Ã·3æ¡)</small>
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</label>
                    <div class="option-buttons">
                        <button class="option-btn active" data-mode="number" onclick="setInputMode('number')">
                            ğŸ”¢ æ•°å­—å…¥åŠ›
                        </button>
                        <button class="option-btn" data-mode="choice" onclick="setInputMode('choice')">
                            âœ‹ 3æŠ
                        </button>
                        <button class="option-btn" data-mode="slider" onclick="setInputMode('slider')">
                            ğŸšï¸ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">ã‚µã‚¦ãƒ³ãƒ‰</label>
                    <div class="toggle-switch">
                        <span>ğŸ”‡ OFF</span>
                        <div class="switch active" onclick="toggleSound()">
                            <div class="switch-knob"></div>
                        </div>
                        <span>ğŸ”Š ON</span>
                    </div>
                </div>
            </div>

            <button class="start-button" onclick="startGame()">âš”ï¸ ãƒãƒˆãƒ«é–‹å§‹ï¼</button>
            <br>
            <button class="back-button" onclick="location.href='index.html'">ğŸ  ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div class="game-screen" id="gameScreen">
            <!-- ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ -->
            <div class="score-board">
                <!-- ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¿ã‚¤ãƒãƒ¼ -->
                <div class="score-item" id="timerDisplay" style="display: none;">
                    <div class="score-label">â±ï¸ æ®‹ã‚Šæ™‚é–“</div>
                    <div class="score-value" id="timerValue">60</div>
                </div>
                <!-- ã‚µãƒã‚¤ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ©ã‚¤ãƒ• -->
                <div class="score-item" id="livesDisplay" style="display: none;">
                    <div class="score-label">â¤ï¸ æ®‹ã‚Šãƒ©ã‚¤ãƒ•</div>
                    <div class="score-value" id="livesValue">â¤ï¸â¤ï¸â¤ï¸</div>
                </div>
                <div class="score-item">
                    <div class="score-label">é€£ç¶šæ­£è§£</div>
                    <div class="score-value" id="comboCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">æ’ƒç ´æ•°</div>
                    <div class="score-value" id="defeatCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">â—åˆ¤å®š</div>
                    <div class="score-value" id="perfectCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">â—‹åˆ¤å®š</div>
                    <div class="score-value" id="goodCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">å•é¡Œæ•°</div>
                    <div class="score-value" id="totalCount">0</div>
                </div>
            </div>

            <!-- ãƒãƒƒã‚¸ã‚¨ãƒªã‚¢ -->
            <div class="badges-area">
                <div class="badges-title">ğŸ† ç²å¾—ãƒãƒƒã‚¸</div>
                <div class="badges-list" id="badgesList">
                    <div class="badge" data-badge="perfect10">
                        <div class="badge-icon">ğŸ¥‰</div>
                        <div class="badge-name">â—10å›</div>
                    </div>
                    <div class="badge" data-badge="perfect30">
                        <div class="badge-icon">ğŸ¥ˆ</div>
                        <div class="badge-name">â—30å›</div>
                    </div>
                    <div class="badge" data-badge="perfect50">
                        <div class="badge-icon">ğŸ¥‡</div>
                        <div class="badge-name">â—50å›</div>
                    </div>
                    <div class="badge" data-badge="combo5">
                        <div class="badge-icon">ğŸ”¥</div>
                        <div class="badge-name">é€£ç¶š5å›</div>
                    </div>
                    <div class="badge" data-badge="total100">
                        <div class="badge-icon">ğŸ“š</div>
                        <div class="badge-name">100å•é”æˆ</div>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ -->
            <div class="battle-area" id="battleArea">
                <div class="monster" id="monsterElement">
                    <div class="monster-icon" id="monsterIcon">ğŸ‘¾</div>
                    <div class="hp-label">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼HP</div>
                    <div class="hp-value" id="hpValue">1234</div>

                    <!-- HPãƒãƒ¼ -->
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="hpBar"></div>
                    </div>
                </div>

                <div class="vs-divider">Ã·</div>

                <div class="attack-section">
                    <div class="attack-label">ã‚ãªãŸã®æ”»æ’ƒåŠ›</div>
                    <div class="attack-value" id="attackValue">56</div>
                </div>
            </div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="input-area">
                <div class="input-label">ä½•å›æ”»æ’ƒã™ã‚Œã°å€’ã›ã‚‹ï¼Ÿ</div>

                <!-- æ•°å­—å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
                <div id="numberInputMode" class="input-mode">
                    <div class="input-group">
                        <input type="number" class="answer-input" id="answerInput" placeholder="?" min="1" max="999">
                        <span class="times-label">å›</span>
                    </div>
                </div>

                <!-- 3æŠãƒ¢ãƒ¼ãƒ‰ -->
                <div id="choiceInputMode" class="input-mode hidden">
                    <div class="choice-buttons" id="choiceButtons">
                        <!-- å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ -->
                <div id="sliderInputMode" class="input-mode hidden">
                    <div class="slider-container">
                        <div class="slider-value"><span id="sliderValue">50</span> å›</div>
                        <input type="range" class="slider" id="answerSlider" min="1" max="100" value="50">
                        <div class="slider-labels">
                            <span id="sliderMin">1</span>
                            <span id="sliderMax">100</span>
                        </div>
                    </div>
                </div>

                <button class="submit-button" id="submitButton" onclick="checkAnswer()">âš”ï¸ æ”»æ’ƒã™ã‚‹ï¼</button>
            </div>

            <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
            <div class="feedback" id="feedback">
                <div class="feedback-icon" id="feedbackIcon">ğŸ‰</div>
                <div class="feedback-title" id="feedbackTitle">å®Œç’§ãªè¦‹ç«‹ã¦ï¼</div>
                <div class="feedback-message" id="feedbackMessage">ç´ æ™´ã‚‰ã—ã„ï¼</div>
                <div class="feedback-explanation" id="feedbackExplanation"></div>
                <button class="next-button" onclick="nextProblem()">æ¬¡ã®å•é¡Œã¸ â–¶</button>
            </div>

            <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
            <div class="feedback" id="gameOverScreen" style="display: none;">
                <div class="feedback-icon" id="gameOverIcon">ğŸ</div>
                <div class="feedback-title" id="gameOverTitle">ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</div>
                <div class="feedback-message" id="gameOverMessage">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</div>
                <div class="feedback-explanation" id="gameOverStats"></div>
                <button class="next-button" onclick="restartGame()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ ğŸ”„</button>
                <button class="back-button" onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹ ğŸ </button>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ è¨­å®š
        let gameSettings = {
            difficulty: 'easy',    // easy, normal, hard
            inputMode: 'number',   // number, choice, slider
            soundEnabled: true,
            gameMode: 'endless',   // endless, timeattack, survival
        };

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            dividend: 0,
            divisor: 0,
            correctAnswer: 0,
            userAnswer: 0,
            combo: 0,
            perfectCount: 0,
            goodCount: 0,
            totalCount: 0,
            defeatCount: 0,  // æ’ƒç ´æ•°
            currentHP: 100,  // ç¾åœ¨ã®HPï¼ˆä»®æƒ³ï¼‰
            timeRemaining: 60,  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼ˆç§’ï¼‰
            livesRemaining: 3,  // ã‚µãƒã‚¤ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ç”¨
            badges: {
                perfect10: false,
                perfect30: false,
                perfect50: false,
                combo5: false,
                total100: false,
            }
        };

        // ã‚¿ã‚¤ãƒãƒ¼ç”¨
        let timerInterval = null;

        // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®çµµæ–‡å­—ãƒªã‚¹ãƒˆ
        const monsters = ['ğŸ‘¾', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‰', 'ğŸ¦–', 'ğŸ¦•', 'ğŸ²', 'ğŸ§Ÿ', 'ğŸ§›'];

        // AudioContext for sound
        let audioContext;

        // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®š
        function setGameMode(mode) {
            gameSettings.gameMode = mode;
            document.querySelectorAll('[data-gamemode]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.gamemode === mode);
            });
        }

        // é›£æ˜“åº¦è¨­å®š
        function setDifficulty(level) {
            gameSettings.difficulty = level;
            document.querySelectorAll('[data-difficulty]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.difficulty === level);
            });
        }

        // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰è¨­å®š
        function setInputMode(mode) {
            gameSettings.inputMode = mode;
            document.querySelectorAll('[data-mode]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        // ã‚µã‚¦ãƒ³ãƒ‰åˆ‡æ›¿
        function toggleSound() {
            gameSettings.soundEnabled = !gameSettings.soundEnabled;
            const switchEl = document.querySelector('.switch');
            switchEl.classList.toggle('active', gameSettings.soundEnabled);
        }

        // ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿ
        function playSound(type) {
            if (!gameSettings.soundEnabled) return;

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'perfect') {
                // å®Œç’§ãªè¦‹ç«‹ã¦: é«˜ã„éŸ³
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'good') {
                // ã„ã„è¦‹ç«‹ã¦: ä¸­éŸ³
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } else if (type === 'ok') {
                // ã‚‚ã†ä¸€æ¯: ä½ã„éŸ³
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            document.getElementById('titleScreen').classList.add('hidden');
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gameOverScreen').style.display = 'none';

            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦åˆæœŸåŒ–
            if (gameSettings.gameMode === 'timeattack') {
                gameState.timeRemaining = 60;
                document.getElementById('timerDisplay').style.display = 'block';
                document.getElementById('livesDisplay').style.display = 'none';
                startTimer();
            } else if (gameSettings.gameMode === 'survival') {
                gameState.livesRemaining = 3;
                document.getElementById('livesDisplay').style.display = 'block';
                document.getElementById('timerDisplay').style.display = 'none';
                updateLivesDisplay();
            } else {
                // ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰
                document.getElementById('timerDisplay').style.display = 'none';
                document.getElementById('livesDisplay').style.display = 'none';
            }

            loadProgress();
            updateBadges();
            generateProblem();
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                document.getElementById('timerValue').textContent = gameState.timeRemaining;

                // 10ç§’ä»¥ä¸‹ã§è­¦å‘Šè‰²
                if (gameState.timeRemaining <= 10) {
                    document.getElementById('timerValue').style.color = '#FF6B6B';
                }

                // æ™‚é–“åˆ‡ã‚Œ
                if (gameState.timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    gameOver('timeup');
                }
            }, 1000);
        }

        // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // ãƒ©ã‚¤ãƒ•è¡¨ç¤ºæ›´æ–°
        function updateLivesDisplay() {
            const hearts = 'â¤ï¸'.repeat(gameState.livesRemaining);
            const brokenHearts = 'ğŸ–¤'.repeat(3 - gameState.livesRemaining);
            document.getElementById('livesValue').textContent = hearts + brokenHearts;
        }

        // ãƒ©ã‚¤ãƒ•æ¸›å°‘
        function loseLife() {
            gameState.livesRemaining--;
            updateLivesDisplay();

            if (gameState.livesRemaining <= 0) {
                gameOver('nolives');
            }
        }

        // å•é¡Œç”Ÿæˆ
        function generateProblem() {
            const types = {
                easy: [{ dividendDigits: 2, divisorDigits: 2 }],
                normal: [
                    { dividendDigits: 2, divisorDigits: 2 },
                    { dividendDigits: 3, divisorDigits: 2 }
                ],
                hard: [
                    { dividendDigits: 2, divisorDigits: 2 },
                    { dividendDigits: 3, divisorDigits: 2 },
                    { dividendDigits: 4, divisorDigits: 3 }
                ]
            };

            const availableTypes = types[gameSettings.difficulty];
            const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];

            gameState.divisor = randomNumber(type.divisorDigits);
            const quotient = Math.floor(Math.random() * 98) + 2;
            const remainder = Math.floor(Math.random() * gameState.divisor);
            gameState.dividend = quotient * gameState.divisor + remainder;
            gameState.correctAnswer = quotient;

            // UIæ›´æ–°
            document.getElementById('hpValue').textContent = gameState.dividend;
            document.getElementById('attackValue').textContent = gameState.divisor;
            document.getElementById('monsterIcon').textContent = monsters[Math.floor(Math.random() * monsters.length)];
            document.getElementById('feedback').classList.remove('show');

            // HP ã‚’ãƒªã‚»ãƒƒãƒˆ
            gameState.currentHP = 100;

            // HPãƒãƒ¼æ›´æ–°
            updateHPBar();

            // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
            switchInputMode();
        }

        // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function switchInputMode() {
            const modes = ['numberInputMode', 'choiceInputMode', 'sliderInputMode'];
            modes.forEach(mode => {
                document.getElementById(mode).classList.add('hidden');
            });

            if (gameSettings.inputMode === 'number') {
                document.getElementById('numberInputMode').classList.remove('hidden');
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').focus();
            } else if (gameSettings.inputMode === 'choice') {
                document.getElementById('choiceInputMode').classList.remove('hidden');
                generateChoices();
            } else if (gameSettings.inputMode === 'slider') {
                document.getElementById('sliderInputMode').classList.remove('hidden');
                setupSlider();
            }
        }

        // 3æŠç”Ÿæˆ
        function generateChoices() {
            const correct = gameState.correctAnswer;
            const choices = [correct];

            // 2ã¤ã®ä¸æ­£è§£ã‚’ç”Ÿæˆ
            while (choices.length < 3) {
                const offset = Math.floor(Math.random() * 10) - 5; // -5ã€œ+5
                const choice = correct + offset;
                if (choice > 0 && !choices.includes(choice)) {
                    choices.push(choice);
                }
            }

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            choices.sort(() => Math.random() - 0.5);

            // ãƒœã‚¿ãƒ³ç”Ÿæˆ
            const container = document.getElementById('choiceButtons');
            container.innerHTML = '';
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice;
                btn.onclick = () => selectChoice(btn, choice);
                container.appendChild(btn);
            });
        }

        // é¸æŠè‚¢é¸æŠ
        function selectChoice(btn, value) {
            document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            gameState.userAnswer = value;
        }

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®š
        function setupSlider() {
            const slider = document.getElementById('answerSlider');
            const min = Math.max(1, gameState.correctAnswer - 20);
            const max = gameState.correctAnswer + 20;
            const mid = Math.floor((min + max) / 2);

            slider.min = min;
            slider.max = max;
            slider.value = mid;

            document.getElementById('sliderMin').textContent = min;
            document.getElementById('sliderMax').textContent = max;
            document.getElementById('sliderValue').textContent = mid;

            slider.oninput = function() {
                document.getElementById('sliderValue').textContent = this.value;
                gameState.userAnswer = parseInt(this.value);
            };
        }

        // æŒ‡å®šæ¡æ•°ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°ã‚’ç”Ÿæˆ
        function randomNumber(digits) {
            const min = Math.pow(10, digits - 1);
            const max = Math.pow(10, digits) - 1;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // === ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•° ===

        // HPãƒãƒ¼æ›´æ–°
        function updateHPBar() {
            const hpBar = document.getElementById('hpBar');
            const maxHP = gameState.divisor * 100; // æœ€å¤§HPã®æ¦‚ç®—
            const currentHP = gameState.dividend;
            const percentage = Math.min(100, (currentHP / maxHP) * 100);

            hpBar.style.width = percentage + '%';

            // HPæ®‹é‡ã§è‰²ã‚’å¤‰æ›´
            if (percentage < 30) {
                hpBar.className = 'hp-bar critical';
            } else if (percentage < 60) {
                hpBar.className = 'hp-bar low';
            } else {
                hpBar.className = 'hp-bar';
            }
        }

        // ãƒ€ãƒ¡ãƒ¼ã‚¸æ•°å€¤è¡¨ç¤º
        function showDamageNumber(damage) {
            const battleArea = document.getElementById('battleArea');
            const monster = document.getElementById('monsterElement');
            const rect = monster.getBoundingClientRect();
            const battleRect = battleArea.getBoundingClientRect();

            const damageEl = document.createElement('div');
            damageEl.className = 'damage-number';
            damageEl.textContent = `-${damage}`;
            damageEl.style.left = (rect.left - battleRect.left + rect.width / 2) + 'px';
            damageEl.style.top = (rect.top - battleRect.top + rect.height / 2) + 'px';

            battleArea.appendChild(damageEl);

            setTimeout(() => {
                damageEl.remove();
            }, 1000);
        }

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ
        function createParticles(x, y, count, emoji) {
            const battleArea = document.getElementById('battleArea');

            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = emoji;

                const angle = (Math.PI * 2 * i) / count;
                const distance = 100 + Math.random() * 100;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;

                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');

                battleArea.appendChild(particle);

                setTimeout(() => {
                    particle.remove();
                }, 1500);
            }
        }

        // ç”»é¢ã‚·ã‚§ã‚¤ã‚¯
        function shakeScreen() {
            const battleArea = document.getElementById('battleArea');
            battleArea.classList.add('shake');
            setTimeout(() => {
                battleArea.classList.remove('shake');
            }, 500);
        }

        // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function monsterDamage() {
            const monster = document.getElementById('monsterElement');
            monster.classList.add('damaged');
            setTimeout(() => {
                monster.classList.remove('damaged');
            }, 500);
        }

        // ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createConfetti() {
            const battleArea = document.getElementById('battleArea');
            const confettiEmojis = ['ğŸ‰', 'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'ğŸŠ'];

            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = confettiEmojis[Math.floor(Math.random() * confettiEmojis.length)];
                confetti.style.left = Math.random() * 600 + 'px';
                confetti.style.top = '0px';
                confetti.style.animationDelay = (Math.random() * 0.5) + 's';

                battleArea.appendChild(confetti);

                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }

        // ã‚³ãƒ³ãƒœç‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
        function addComboFire() {
            const comboElement = document.getElementById('comboCount');
            const parent = comboElement.parentElement;

            // æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’å…¨å‰Šé™¤
            parent.classList.remove('combo-fire', 'super-combo', 'mega-combo');

            // ã‚³ãƒ³ãƒœæ•°ã«å¿œã˜ã¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
            if (gameState.combo >= 10) {
                parent.classList.add('mega-combo');  // 10ã‚³ãƒ³ãƒœä»¥ä¸Šï¼šè™¹
            } else if (gameState.combo >= 5) {
                parent.classList.add('super-combo');  // 5ã‚³ãƒ³ãƒœä»¥ä¸Šï¼šç¨²å¦»
            } else if (gameState.combo >= 3) {
                parent.classList.add('combo-fire');   // 3ã‚³ãƒ³ãƒœä»¥ä¸Šï¼šç‚
            }
        }

        // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼æ’ƒç ´æ¼”å‡º
        function defeatMonster() {
            const monster = document.getElementById('monsterElement');
            const battleArea = document.getElementById('battleArea');
            const rect = monster.getBoundingClientRect();
            const battleRect = battleArea.getBoundingClientRect();

            // çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = 'ğŸ’¥';
            explosion.style.left = (rect.left - battleRect.left + rect.width / 2) + 'px';
            explosion.style.top = (rect.top - battleRect.top + rect.height / 2) + 'px';
            battleArea.appendChild(explosion);

            setTimeout(() => {
                explosion.remove();
            }, 1000);

            // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼æ¶ˆæ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            monster.classList.add('defeated');
            setTimeout(() => {
                monster.classList.remove('defeated');
                gameState.defeatCount++;
                updateScore();
                // æ–°ã—ã„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å‡ºç¾ï¼ˆæ¬¡ã®å•é¡Œç”Ÿæˆï¼‰
                nextProblem();
            }, 1000);
        }

        // èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
        function flashBackground(type) {
            const battleArea = document.getElementById('battleArea');
            if (type === 'gold') {
                battleArea.classList.add('flash-gold');
                setTimeout(() => {
                    battleArea.classList.remove('flash-gold');
                }, 500);
            } else if (type === 'silver') {
                battleArea.classList.add('flash-silver');
                setTimeout(() => {
                    battleArea.classList.remove('flash-silver');
                }, 500);
            }
        }

        // HPæ¸›å°‘å‡¦ç†
        function damageHP(damagePercent) {
            gameState.currentHP -= damagePercent;
            if (gameState.currentHP <= 0) {
                gameState.currentHP = 0;
                // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼æ’ƒç ´
                setTimeout(() => {
                    defeatMonster();
                }, 1500);  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¾Œã«æ’ƒç ´
            }
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
        function gameOver(reason) {
            // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
            stopTimer();

            // å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('submitButton').disabled = true;

            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤º
            let icon = 'ğŸ';
            let title = 'ã‚²ãƒ¼ãƒ çµ‚äº†ï¼';
            let message = '';

            if (reason === 'timeup') {
                icon = 'â°';
                title = 'ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼';
                message = '60ç§’é–“ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';
            } else if (reason === 'nolives') {
                icon = 'ğŸ’”';
                title = 'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼';
                message = 'ãƒ©ã‚¤ãƒ•ãŒãªããªã£ã¦ã—ã¾ã„ã¾ã—ãŸ...';
            }

            document.getElementById('gameOverIcon').textContent = icon;
            document.getElementById('gameOverTitle').textContent = title;
            document.getElementById('gameOverMessage').textContent = message;

            const stats = `
                <strong>ğŸ“Š ã‚ãªãŸã®æˆç¸¾</strong><br><br>
                æ’ƒç ´æ•°ï¼š${gameState.defeatCount} ä½“<br>
                â—åˆ¤å®šï¼š${gameState.perfectCount} å›<br>
                â—‹åˆ¤å®šï¼š${gameState.goodCount} å›<br>
                å•é¡Œæ•°ï¼š${gameState.totalCount} å•<br>
                æœ€é«˜é€£ç¶šæ­£è§£ï¼š${gameState.combo} å›<br>
            `;
            document.getElementById('gameOverStats').innerHTML = stats;

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’éè¡¨ç¤º
            document.getElementById('feedback').classList.remove('show');

            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤º
            setTimeout(() => {
                document.getElementById('gameOverScreen').style.display = 'block';
            }, 500);
        }

        // ã‚²ãƒ¼ãƒ å†é–‹
        function restartGame() {
            // ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆï¼ˆãƒãƒƒã‚¸ã¨ç´¯è¨ˆã¯ä¿æŒï¼‰
            const savedPerfectCount = gameState.perfectCount;
            const savedGoodCount = gameState.goodCount;
            const savedTotalCount = gameState.totalCount;
            const savedBadges = gameState.badges;

            gameState.combo = 0;
            gameState.defeatCount = 0;
            gameState.currentHP = 100;
            gameState.timeRemaining = 60;
            gameState.livesRemaining = 3;

            // ãƒãƒƒã‚¸ã¨ç´¯è¨ˆã¯å¾©å…ƒ
            gameState.perfectCount = savedPerfectCount;
            gameState.goodCount = savedGoodCount;
            gameState.totalCount = savedTotalCount;
            gameState.badges = savedBadges;

            // å…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('submitButton').disabled = false;

            // ç”»é¢ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('timerValue').style.color = '';

            startGame();
        }

        // ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
        function backToTitle() {
            stopTimer();
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('titleScreen').classList.remove('hidden');
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('submitButton').disabled = false;
        }

        // å›ç­”ãƒã‚§ãƒƒã‚¯
        function checkAnswer() {
            // å…¥åŠ›å€¤å–å¾—
            if (gameSettings.inputMode === 'number') {
                const input = document.getElementById('answerInput');
                gameState.userAnswer = parseInt(input.value);
            } else if (gameSettings.inputMode === 'choice') {
                if (!gameState.userAnswer) {
                    alert('é¸æŠè‚¢ã‚’é¸ã‚“ã§ã­ï¼');
                    return;
                }
            } else if (gameSettings.inputMode === 'slider') {
                // sliderã¯å¸¸ã«userAnswerã«å€¤ãŒå…¥ã£ã¦ã„ã‚‹
            }

            if (isNaN(gameState.userAnswer) || gameState.userAnswer < 1) {
                alert('æ•°å­—ã‚’å…¥åŠ›ã—ã¦ã­ï¼');
                return;
            }

            const diff = Math.abs(gameState.userAnswer - gameState.correctAnswer);

            let rank = '';
            let icon = '';
            let title = '';
            let message = '';
            let color = '';

            if (diff <= 1) {
                rank = 'perfect';
                icon = 'ğŸ‰';
                title = 'â— å®Œç’§ãªè¦‹ç«‹ã¦ï¼';
                message = 'ã™ã”ã„ï¼ã»ã¼æ­£ç¢ºã«è¦‹ç«‹ã¦ã‚‰ã‚ŒãŸã­ï¼';
                color = 'feedback-perfect';
                gameState.perfectCount++;
                gameState.combo++;
                playSound('perfect');

                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç™ºå‹•
                shakeScreen();
                flashBackground('gold');
                createConfetti();
                monsterDamage();
                showDamageNumber(gameState.divisor);
                const monster = document.getElementById('monsterElement');
                const rect = monster.getBoundingClientRect();
                const battleArea = document.getElementById('battleArea');
                const battleRect = battleArea.getBoundingClientRect();
                createParticles(rect.left - battleRect.left + rect.width / 2, rect.top - battleRect.top + rect.height / 2, 12, 'â­');
                damageHP(40);  // HPã‚’40%æ¸›å°‘
            } else if (diff <= 2) {
                rank = 'good';
                icon = 'ğŸ‘';
                title = 'â—‹ ã„ã„è¦‹ç«‹ã¦ï¼';
                message = 'ã„ã„æ„Ÿã˜ï¼ã‚‚ã†å°‘ã—ã§å®Œç’§ã ã‚ˆï¼';
                color = 'feedback-good';
                gameState.goodCount++;
                gameState.combo++;
                playSound('good');

                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç™ºå‹•
                flashBackground('silver');
                monsterDamage();
                showDamageNumber(Math.floor(gameState.divisor * 0.7));
                const monster = document.getElementById('monsterElement');
                const rect = monster.getBoundingClientRect();
                const battleArea = document.getElementById('battleArea');
                const battleRect = battleArea.getBoundingClientRect();
                createParticles(rect.left - battleRect.left + rect.width / 2, rect.top - battleRect.top + rect.height / 2, 8, 'âœ¨');
                damageHP(25);  // HPã‚’25%æ¸›å°‘
            } else {
                rank = 'ok';
                icon = 'ğŸ’¡';
                title = 'â–³ ã‚‚ã†ä¸€æ¯ï¼';
                message = diff > 10 ? 'å¤§ããå¤–ã‚Œã¡ã‚ƒã£ãŸã­ã€‚ä¸¸ã‚ã¦è€ƒãˆã¦ã¿ã‚ˆã†ï¼' : 'ã‚‚ã†å°‘ã—æ­£ç¢ºã«è¦‹ç«‹ã¦ã¦ã¿ã‚ˆã†ï¼';
                color = 'feedback-ok';
                gameState.combo = 0;
                playSound('ok');

                // è»½ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã¿
                showDamageNumber(Math.floor(gameState.divisor * 0.3));
                damageHP(10);  // HPã‚’10%æ¸›å°‘

                // ã‚µãƒã‚¤ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ãƒ©ã‚¤ãƒ•æ¸›å°‘
                if (gameSettings.gameMode === 'survival') {
                    loseLife();
                }
            }

            gameState.totalCount++;

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
            document.getElementById('feedbackIcon').textContent = icon;
            document.getElementById('feedbackTitle').textContent = title;
            document.getElementById('feedbackTitle').className = `feedback-title ${color}`;
            document.getElementById('feedbackMessage').textContent = message;

            const explanation = `
                <strong>æ­£ã—ã„å•†ï¼š${gameState.correctAnswer}å›</strong><br>
                ã‚ãªãŸã®è¦‹ç«‹ã¦ï¼š${gameState.userAnswer}å›<br>
                ${gameState.dividend} Ã· ${gameState.divisor} = ${gameState.correctAnswer}ã‚ã¾ã‚Š${gameState.dividend % gameState.divisor}<br>
                <br>
                ğŸ’¡ è€ƒãˆæ–¹ã®ãƒ’ãƒ³ãƒˆï¼š<br>
                ${getRoundingHint()}
            `;
            document.getElementById('feedbackExplanation').innerHTML = explanation;
            document.getElementById('feedback').classList.add('show');

            updateScore();
            checkBadges();
            saveProgress();
        }

        // ä¸¸ã‚æ–¹ã®ãƒ’ãƒ³ãƒˆç”Ÿæˆ
        function getRoundingHint() {
            const dividendRounded = roundToFirstDigit(gameState.dividend);
            const divisorRounded = roundToFirstDigit(gameState.divisor);
            const roughAnswer = Math.floor(dividendRounded / divisorRounded);

            return `ã€Œ${gameState.dividend}ã€ã‚’ã€Œ${dividendRounded}ã€ã€ã€Œ${gameState.divisor}ã€ã‚’ã€Œ${divisorRounded}ã€ã¨è€ƒãˆã‚‹ã¨<br>
                    ${dividendRounded} Ã· ${divisorRounded} â‰’ ${roughAnswer}å› ãã‚‰ã„ã¨è¦‹ç«‹ã¦ã‚‰ã‚Œã‚‹ã‚ˆï¼`;
        }

        // æœ€ä¸Šä½æ¡ã«ä¸¸ã‚ã‚‹
        function roundToFirstDigit(num) {
            const digits = num.toString().length;
            const divisor = Math.pow(10, digits - 1);
            return Math.round(num / divisor) * divisor;
        }

        // ã‚¹ã‚³ã‚¢æ›´æ–°
        function updateScore() {
            document.getElementById('comboCount').textContent = gameState.combo;
            document.getElementById('defeatCount').textContent = gameState.defeatCount;
            document.getElementById('perfectCount').textContent = gameState.perfectCount;
            document.getElementById('goodCount').textContent = gameState.goodCount;
            document.getElementById('totalCount').textContent = gameState.totalCount;

            // ã‚³ãƒ³ãƒœç‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            addComboFire();
        }

        // ãƒãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
        function checkBadges() {
            const newBadges = [];

            if (!gameState.badges.perfect10 && gameState.perfectCount >= 10) {
                gameState.badges.perfect10 = true;
                newBadges.push('perfect10');
            }
            if (!gameState.badges.perfect30 && gameState.perfectCount >= 30) {
                gameState.badges.perfect30 = true;
                newBadges.push('perfect30');
            }
            if (!gameState.badges.perfect50 && gameState.perfectCount >= 50) {
                gameState.badges.perfect50 = true;
                newBadges.push('perfect50');
            }
            if (!gameState.badges.combo5 && gameState.combo >= 5) {
                gameState.badges.combo5 = true;
                newBadges.push('combo5');
            }
            if (!gameState.badges.total100 && gameState.totalCount >= 100) {
                gameState.badges.total100 = true;
                newBadges.push('total100');
            }

            if (newBadges.length > 0) {
                updateBadges();
                // ãƒãƒƒã‚¸ç²å¾—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                setTimeout(() => {
                    newBadges.forEach(badge => {
                        const el = document.querySelector(`[data-badge="${badge}"]`);
                        if (el) {
                            el.classList.add('unlocked');
                        }
                    });
                }, 500);
            }
        }

        // ãƒãƒƒã‚¸è¡¨ç¤ºæ›´æ–°
        function updateBadges() {
            Object.keys(gameState.badges).forEach(badge => {
                const el = document.querySelector(`[data-badge="${badge}"]`);
                if (el && gameState.badges[badge]) {
                    el.classList.add('unlocked');
                }
            });
        }

        // æ¬¡ã®å•é¡Œ
        function nextProblem() {
            generateProblem();
        }

        // é€²æ—ä¿å­˜
        function saveProgress() {
            localStorage.setItem('divisionEstimation', JSON.stringify({
                perfectCount: gameState.perfectCount,
                goodCount: gameState.goodCount,
                totalCount: gameState.totalCount,
                badges: gameState.badges,
            }));
        }

        // é€²æ—èª­ã¿è¾¼ã¿
        function loadProgress() {
            const saved = localStorage.getItem('divisionEstimation');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.perfectCount = data.perfectCount || 0;
                gameState.goodCount = data.goodCount || 0;
                gameState.totalCount = data.totalCount || 0;
                gameState.badges = data.badges || gameState.badges;
                updateScore();
            }
        }

        // Enterã‚­ãƒ¼ã§é€ä¿¡
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('answerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });
        });
    </script>
</body>
</html>
