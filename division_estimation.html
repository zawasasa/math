<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Çè„ÇäÁÆó„Éû„Çπ„Çø„Éº - „Åï„Åï„Å£„Å®ÁÆóÊï∞</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@500&family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1;
            --primary-light: #818CF8;
            --secondary: #F472B6;
            --accent: #34D399;
            --warning: #FBBF24;
            --danger: #F87171;
            --bg-gradient: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #D1FAE5 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #1E293B;
            --text-light: #64748B;
            --font-main: 'M PLUS Rounded 1c', sans-serif;
            --font-title: 'Kiwi Maru', serif;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --radius: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* „Çø„Ç§„Éà„É´ÁîªÈù¢ */
        .title-screen {
            text-align: center;
            padding: 30px 20px;
        }

        .game-title {
            font-family: var(--font-title);
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .game-subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 30px;
            line-height: 1.8;
        }

        /* „É¢„Éº„ÉâÈÅ∏Êäû„Ç´„Éº„Éâ */
        .mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: var(--shadow);
        }

        .mode-card:hover {
            transform: translateY(-5px);
        }

        .mode-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #EEF2FF 0%, #FDF2F8 100%);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .mode-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }

        .mode-desc {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.6;
        }

        /* Ë®≠ÂÆö„Éë„Éç„É´ */
        .settings-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
            display: block;
        }

        .option-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .option-btn {
            background: white;
            border: 2px solid #E2E8F0;
            color: var(--text);
            font-size: 0.95rem;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover {
            border-color: var(--primary-light);
        }

        .option-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .start-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-size: 1.4rem;
            font-weight: 700;
            padding: 18px 50px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
            transition: all 0.3s;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.5);
        }

        .back-button {
            background: #E2E8F0;
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .back-button:hover {
            background: #CBD5E1;
        }

        /* „Ç≤„Éº„É†ÁîªÈù¢ */
        .game-screen {
            display: none;
        }

        .game-screen.active {
            display: block;
        }

        /* „Çπ„Ç≥„Ç¢„Éú„Éº„Éâ */
        .score-board {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 3px;
        }

        .score-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* ÂïèÈ°å„Ç®„É™„Ç¢ */
        .problem-area {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        /* „Ç∑„Éä„É™„Ç™Ë°®Á§∫ */
        .scenario-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-radius: 15px;
        }

        .scenario-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .scenario-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text);
        }

        .scenario-highlight {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
        }

        /* ÂºèË°®Á§∫ */
        .formula-display {
            text-align: center;
            padding: 20px;
            background: #F8FAFC;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .formula {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .formula-number {
            background: white;
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid #E2E8F0;
        }

        .formula-operator {
            color: var(--primary);
        }

        /* Ê¶ÇÊï∞„Éí„É≥„Éà */
        .approx-hint {
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .approx-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .approx-content {
            font-size: 1rem;
            color: var(--text);
            line-height: 1.6;
        }

        .approx-calc {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* Êï∞Áõ¥Á∑ö */
        .number-line {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .number-line-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 15px;
            text-align: center;
        }

        .line-container {
            position: relative;
            height: 50px;
            margin: 0 20px;
        }

        .line-track {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background: #E2E8F0;
            border-radius: 2px;
        }

        .line-marker {
            position: absolute;
            top: 10px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .line-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* ÂÖ•Âäõ„Ç®„É™„Ç¢ */
        .input-area {
            background: linear-gradient(135deg, #FDF4FF 0%, #FAE8FF 100%);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .input-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 15px;
            text-align: center;
        }

        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .answer-input {
            font-family: var(--font-main);
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            width: 150px;
            padding: 15px;
            border: 3px solid var(--primary-light);
            border-radius: 15px;
            background: white;
            color: var(--text);
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .times-label {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        /* ÈÅ∏ÊäûËÇ¢„Éú„Çø„É≥ */
        .choice-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .choice-btn {
            background: white;
            border: 3px solid #E2E8F0;
            color: var(--text);
            font-size: 1.8rem;
            font-weight: 700;
            padding: 20px 35px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }

        .choice-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-3px);
        }

        .choice-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* „Éí„É≥„Éà„Éú„Çø„É≥ */
        .hint-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .hint-btn {
            background: var(--warning);
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hint-btn:hover {
            transform: scale(1.05);
        }

        .hint-btn:disabled {
            background: #CBD5E1;
            cursor: not-allowed;
        }

        /* „Éí„É≥„ÉàË°®Á§∫ */
        .hint-display {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--warning);
            display: none;
        }

        .hint-display.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hint-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #92400E;
            margin-bottom: 8px;
        }

        .hint-content {
            font-size: 1rem;
            color: var(--text);
            line-height: 1.6;
        }

        /* ÈÄÅ‰ø°„Éú„Çø„É≥ */
        .submit-button {
            background: linear-gradient(135deg, var(--accent) 0%, #10B981 100%);
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(52, 211, 153, 0.4);
            transition: all 0.2s;
            display: block;
            margin: 0 auto;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 211, 153, 0.5);
        }

        /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .feedback {
            display: none;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback.show {
            display: block;
        }

        .feedback-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .feedback-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .feedback-title.perfect {
            color: var(--primary);
        }

        .feedback-title.good {
            color: var(--warning);
        }

        .feedback-title.ok {
            color: var(--accent);
        }

        .feedback-message {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .feedback-explanation {
            background: #F1F5F9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
            line-height: 1.8;
        }

        /* ‰Ωô„Çä„ÉÅ„Çß„ÉÉ„ÇØ */
        .remainder-check {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
            border-left: 4px solid var(--accent);
        }

        .remainder-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #065F46;
            margin-bottom: 8px;
        }

        .remainder-content {
            font-size: 1rem;
            color: var(--text);
        }

        .remainder-ok {
            color: var(--accent);
            font-weight: 700;
        }

        .remainder-ng {
            color: var(--danger);
            font-weight: 700;
        }

        .next-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            transition: all 0.2s;
        }

        .next-button:hover {
            transform: translateY(-2px);
        }

        /* ÊàêÈï∑„Ç∞„É©„Éï */
        .growth-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .growth-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 20px;
            text-align: center;
        }

        .growth-item {
            margin-bottom: 15px;
        }

        .growth-label {
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .growth-bar-bg {
            height: 12px;
            background: #E2E8F0;
            border-radius: 6px;
            overflow: hidden;
        }

        .growth-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s;
        }

        .growth-bar.approx {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .growth-bar.calc {
            background: linear-gradient(90deg, var(--secondary) 0%, #F9A8D4 100%);
        }

        .growth-bar.remainder {
            background: linear-gradient(90deg, var(--accent) 0%, #6EE7B7 100%);
        }

        /* Á≠ÜÁÆóË°®Á§∫ */
        .division-process {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 1.2rem;
        }

        .division-step {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
        }

        .division-step.current {
            background: #FEF3C7;
            border: 2px solid var(--warning);
        }

        .division-step.completed {
            background: #D1FAE5;
        }

        .step-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .game-title {
                font-size: 1.8rem;
            }

            .formula {
                font-size: 1.5rem;
            }

            .answer-input {
                font-size: 1.5rem;
                width: 120px;
            }

            .choice-btn {
                font-size: 1.5rem;
                padding: 15px 25px;
            }
        }

        /* iPad„Éª„Çø„Éñ„É¨„ÉÉ„ÉàÁî®ÊúÄÈÅ©Âåñ */
        @media (min-width: 768px) and (max-height: 1200px) {
            .container {
                padding: 2px 10px;
            }

            /* iPad„Åß„ÅØ„Çπ„Ç≥„Ç¢„Éê„Éº„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶È´ò„Åï„ÇíÁØÄÁ¥Ñ */
            .score-bar {
                display: none !important;
            }

            .problem-area {
                padding: 5px;
            }

            /* „Éê„Éà„É´„Ç®„É™„Ç¢„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .battle-area {
                padding: 5px 10px;
                margin-bottom: 3px;
            }

            .battle-header {
                margin-bottom: 3px;
            }

            .battle-timer {
                padding: 3px 8px;
                font-size: 0.8rem;
            }

            .battle-round {
                font-size: 0.7rem;
            }

            .enemy-container {
                margin: 2px 0;
                flex-direction: row;
                gap: 8px;
                align-items: center;
            }

            .enemy-character {
                font-size: 1.3rem;
            }

            .enemy-name {
                font-size: 0.65rem;
                margin-top: 0;
            }

            .hp-bar-container {
                margin-top: 0;
                max-width: 100px;
            }

            .hp-label {
                font-size: 0.55rem;
            }

            .hp-bar {
                height: 4px;
            }

            .battle-message {
                font-size: 0.65rem;
                margin-top: 3px;
                min-height: 14px;
            }

            /* ÂïèÈ°åË°®Á§∫„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .formula-box {
                padding: 8px;
                margin-bottom: 5px;
            }

            .formula {
                font-size: 1.5rem;
                gap: 5px;
            }

            .formula-number {
                padding: 5px 12px;
                min-width: 40px;
            }

            /* Ê¶ÇÊï∞„Éí„É≥„Éà„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .approx-hint {
                padding: 5px 10px;
                margin-bottom: 3px;
            }

            .approx-title {
                font-size: 0.65rem;
                margin-bottom: 3px;
            }

            .approx-method-buttons {
                margin-bottom: 3px;
                gap: 3px;
            }

            .approx-method-btn {
                padding: 2px 6px;
                font-size: 0.6rem;
            }

            .approx-calc {
                font-size: 0.7rem;
                gap: 2px;
            }

            .approx-result {
                font-size: 0.7rem;
                padding: 3px 8px;
                margin-top: 3px;
            }

            /* Êï∞Áõ¥Á∑ö„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .number-line {
                padding: 4px 8px;
                margin-bottom: 3px;
            }

            .number-line-title {
                font-size: 0.6rem;
                margin-bottom: 3px;
            }

            .number-line-track {
                height: 3px;
            }

            .number-line-labels {
                font-size: 0.55rem;
                margin-top: 2px;
            }

            .number-line-marker {
                width: 10px;
                height: 10px;
            }

            /* „Éí„É≥„Éà„Éú„Çø„É≥„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .hint-buttons {
                margin-bottom: 3px;
                gap: 3px;
            }

            .hint-btn {
                padding: 4px 8px;
                font-size: 0.65rem;
            }

            /* ÈÅ∏ÊäûËÇ¢„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .choice-grid {
                gap: 6px;
                margin-bottom: 8px;
            }

            .choice-btn {
                padding: 10px 15px;
                font-size: 1.2rem;
            }

            /* „Éú„Çø„É≥„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .submit-btn {
                padding: 10px 25px;
                font-size: 0.95rem;
            }

            /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .feedback-content {
                padding: 12px;
            }

            .feedback-icon {
                font-size: 2rem;
                margin-bottom: 8px;
            }

            .feedback-title {
                font-size: 1.1rem;
            }

            .feedback-message {
                font-size: 0.85rem;
            }

            /* ÊàêÈï∑„Ç∞„É©„Éï„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .growth-section {
                padding: 8px;
                margin-top: 8px;
            }

            .growth-title {
                font-size: 0.75rem;
                margin-bottom: 5px;
            }

            .growth-bars {
                gap: 5px;
            }

            .bar-label {
                font-size: 0.6rem;
            }

            .bar-value {
                font-size: 0.55rem;
            }

            .bar-track {
                height: 6px;
            }

            /* ÂÖ•Âäõ„Éë„Éç„É´„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .input-panel {
                padding: 10px;
            }

            .input-panel-title {
                font-size: 0.85rem;
                margin-bottom: 5px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Á≠ÜÁÆóË°®Á§∫ */
        .division-process {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            font-family: 'M PLUS Rounded 1c', monospace;
            font-size: 1.2rem;
        }

        .division-process-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 15px;
            text-align: center;
        }

        .division-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .division-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .division-cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: 700;
            border-radius: 8px;
        }

        .division-cell.divisor {
            background: var(--primary-light);
            color: white;
        }

        .division-cell.dividend {
            background: #F1F5F9;
            border-bottom: 3px solid var(--text);
        }

        .division-cell.quotient {
            background: var(--accent);
            color: white;
        }

        .division-cell.quotient.empty {
            background: #FEF3C7;
            color: var(--warning);
            border: 2px dashed var(--warning);
        }

        .division-cell.product {
            background: #FDF2F8;
            color: var(--secondary);
        }

        .division-cell.remainder-cell {
            background: #DBEAFE;
            color: var(--primary);
        }

        .division-symbol {
            font-size: 1.5rem;
            color: var(--text);
            margin: 0 5px;
        }

        .division-line {
            width: 100%;
            height: 2px;
            background: var(--text);
            margin: 5px 0;
        }

        /* Ë®àÁÆó„Çπ„ÉÜ„ÉÉ„Éó */
        .calc-steps {
            background: #F8FAFC;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .calc-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .calc-step.current {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 2px solid var(--warning);
        }

        .calc-step.completed {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
        }

        .calc-step.pending {
            opacity: 0.5;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .step-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-right: auto;
        }

        .step-action {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
        }

        /* Á≠ÜÁÆóÂÖ•Âäõ„É¢„Éº„Éâ */
        .written-input-mode {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .digit-input-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .digit-btn {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-weight: 700;
            border: 2px solid #E2E8F0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .digit-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .digit-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* „Éê„Éà„É´„É¢„Éº„Éâ */
        .battle-area {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .battle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .battle-timer {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .battle-timer.warning {
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .battle-round {
            color: #FDE68A;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .enemy-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }

        .enemy-character {
            font-size: 4rem;
            animation: enemyBounce 1s ease-in-out infinite;
        }

        @keyframes enemyBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .enemy-name {
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 10px;
        }

        .hp-bar-container {
            width: 100%;
            max-width: 250px;
            margin-top: 15px;
        }

        .hp-label {
            display: flex;
            justify-content: space-between;
            color: #A5B4FC;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .hp-bar {
            height: 12px;
            background: #374151;
            border-radius: 6px;
            overflow: hidden;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #84cc16 100%);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .hp-fill.low {
            background: linear-gradient(90deg, #ef4444 0%, #f97316 100%);
        }

        .battle-message {
            color: #FDE68A;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 15px;
            min-height: 24px;
        }

        .damage-effect {
            position: absolute;
            color: #ef4444;
            font-size: 2rem;
            font-weight: 700;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes damageFloat {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }

        .heal-effect {
            position: absolute;
            color: #22c55e;
            font-size: 2rem;
            font-weight: 700;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
        <div class="title-screen" id="titleScreen">
            <h1 class="game-title">üìê „Çè„ÇäÁÆó„Éû„Çπ„Çø„Éº</h1>
            <p class="game-subtitle">
                Êó•Â∏∏„ÅÆÂ†¥Èù¢„Åß„Çè„ÇäÁÆó„Çí‰Ωø„ÅÑ„Åì„Å™„Åù„ÅÜÔºÅ<br>
                <strong>Ê¶ÇÊï∞„ÅßË¶ãÂΩì„Çí„Å§„Åë„Çã</strong>Âäõ„ÇíË∫´„Å´„Å§„Åë„Çà„ÅÜ üéØ
            </p>

            <!-- „É¢„Éº„ÉâÈÅ∏Êäû -->
            <div class="mode-cards">
                <div class="mode-card selected" data-mode="story" onclick="selectMode('story')">
                    <div class="mode-icon">üåü</div>
                    <div class="mode-title">„Çπ„Éà„Éº„É™„Éº„É¢„Éº„Éâ</div>
                    <div class="mode-desc">„ÅäË≤∑„ÅÑÁâ©„ÇÑ„Éë„Éº„ÉÜ„Ç£„Éº„Å™„Å©<br>Êó•Â∏∏„ÅÆÂ†¥Èù¢„Åß„Çè„ÇäÁÆó„ÇíÁ∑¥Áøí</div>
                </div>
                <div class="mode-card" data-mode="approx" onclick="selectMode('approx')">
                    <div class="mode-icon">üìè</div>
                    <div class="mode-title">Ë¶ãÁ©ç„ÇÇ„Çä„É¢„Éº„Éâ</div>
                    <div class="mode-desc">Ê¶ÇÊï∞„Çí‰Ωø„Å£„Å¶<br>ÂïÜ„ÅÆË¶ãÂΩì„Çí„Å§„Åë„ÇãÁ∑¥Áøí</div>
                </div>
                <div class="mode-card" data-mode="written" onclick="selectMode('written')">
                    <div class="mode-icon">‚úèÔ∏è</div>
                    <div class="mode-title">Á≠ÜÁÆó„É¢„Éº„Éâ</div>
                    <div class="mode-desc">„Åü„Å¶„Çã„Éª„Åã„Åë„Çã„Éª„Å≤„Åè„Éª„Åä„Çç„Åô<br>Á≠ÜÁÆó„ÅÆÊâãÈ†Ü„ÇíÁ∑¥Áøí</div>
                </div>
                <div class="mode-card" data-mode="battle" onclick="selectMode('battle')">
                    <div class="mode-icon">‚öîÔ∏è</div>
                    <div class="mode-title">„Éê„Éà„É´„É¢„Éº„Éâ</div>
                    <div class="mode-desc">„É¢„É≥„Çπ„Çø„Éº„Å®Êà¶„ÅÑ„Å™„Åå„Çâ<br>„Çè„ÇäÁÆó„Çí„Éû„Çπ„Çø„Éº</div>
                </div>
            </div>

            <!-- Ë®≠ÂÆö„Éë„Éç„É´ -->
            <div class="settings-panel">
                <div class="setting-group">
                    <label class="setting-label">Èõ£ÊòìÂ∫¶</label>
                    <div class="option-buttons">
                        <button class="option-btn active" data-difficulty="easy" onclick="setDifficulty('easy')">
                            üòä „Åã„Çì„Åü„Çì<br><small>(2Ê°Å√∑1Ê°Å)</small>
                        </button>
                        <button class="option-btn" data-difficulty="normal" onclick="setDifficulty('normal')">
                            üòé „Åµ„Å§„ÅÜ<br><small>(3Ê°Å√∑2Ê°Å)</small>
                        </button>
                        <button class="option-btn" data-difficulty="hard" onclick="setDifficulty('hard')">
                            üò§ „ÇÄ„Åö„Åã„Åó„ÅÑ<br><small>(4Ê°Å√∑2Ê°Å)</small>
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">ÂÖ•ÂäõÊñπÊ≥ï</label>
                    <div class="option-buttons">
                        <button class="option-btn active" data-input="choice" onclick="setInputMode('choice')">‚úã
                            3Êäû</button>
                        <button class="option-btn" data-input="number" onclick="setInputMode('number')">üî¢ Êï∞Â≠óÂÖ•Âäõ</button>
                    </div>
                </div>
            </div>

            <button class="start-button" onclick="startGame()">üöÄ „Çπ„Çø„Éº„ÉàÔºÅ</button>
            <br>
            <button class="back-button" onclick="location.href='index.html'">üè† „Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
        </div>

        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div class="game-screen" id="gameScreen">
            <!-- „Çπ„Ç≥„Ç¢„Éú„Éº„Éâ -->
            <div class="score-board">
                <div class="score-item">
                    <div class="score-label">ÂïèÈ°åÊï∞</div>
                    <div class="score-value" id="totalCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Ê≠£Ëß£</div>
                    <div class="score-value" id="correctCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">ÈÄ£Á∂ö</div>
                    <div class="score-value" id="comboCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Ê≠£Ëß£Áéá</div>
                    <div class="score-value" id="accuracy">--%</div>
                </div>
            </div>

            <!-- ÂïèÈ°å„Ç®„É™„Ç¢ -->
            <div class="problem-area" id="problemArea">
                <!-- „Éê„Éà„É´„Ç®„É™„Ç¢Ôºà„Éê„Éà„É´„É¢„Éº„ÉâÁî®Ôºâ -->
                <div class="battle-area hidden" id="battleArea">
                    <div class="battle-header">
                        <div class="battle-round" id="battleRound">ROUND 1</div>
                        <div class="battle-timer" id="battleTimer">
                            ‚è±Ô∏è <span id="timerValue">30</span>
                        </div>
                    </div>
                    <div class="enemy-container">
                        <div class="enemy-character" id="enemyCharacter">üëæ</div>
                        <div class="enemy-name" id="enemyName">„Çπ„É©„Ç§„É†</div>
                        <div class="hp-bar-container">
                            <div class="hp-label">
                                <span>HP</span>
                                <span id="hpValue">100/100</span>
                            </div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="hpFill" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="battle-message" id="battleMessage">„É¢„É≥„Çπ„Çø„Éº„ÅåÁèæ„Çå„ÅüÔºÅ„Çè„ÇäÁÆó„ÅßÂÄí„Åù„ÅÜÔºÅ</div>
                </div>

                <!-- „Ç∑„Éä„É™„Ç™Ë°®Á§∫Ôºà„Çπ„Éà„Éº„É™„Éº„É¢„Éº„ÉâÁî®Ôºâ -->
                <div class="scenario-display" id="scenarioDisplay">
                    <div class="scenario-icon" id="scenarioIcon">üõí</div>
                    <div class="scenario-text" id="scenarioText">
                        „Åø„Çì„Å™„ÅßË≤∑„ÅÑÁâ©„Å´Êù•„Åü„ÇàÔºÅ<br>
                        <span class="scenario-highlight" id="scenarioProblem">1200ÂÜÜ„Çí4‰∫∫„ÅßÂâ≤„ÇäÂãò„Åô„Çã„Å®„ÄÅ1‰∫∫„ÅÑ„Åè„ÇâÔºü</span>
                    </div>
                </div>

                <!-- ÂºèË°®Á§∫ -->
                <div class="formula-display">
                    <div class="formula">
                        <span class="formula-number" id="dividend">1200</span>
                        <span class="formula-operator">√∑</span>
                        <span class="formula-number" id="divisor">4</span>
                        <span class="formula-operator">=</span>
                        <span class="formula-number">Ôºü</span>
                    </div>
                </div>

                <!-- Ê¶ÇÊï∞„Éí„É≥„ÉàÔºàÂº∑ÂåñÁâàÔºâ -->
                <div class="approx-hint" id="approxHint">
                    <div class="approx-title">üí° Ê¶ÇÊï∞„ÅßË¶ãÂΩì„Çí„Å§„Åë„Çà„ÅÜ</div>
                    <div class="approx-method-buttons"
                        style="margin-bottom: 10px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                        <button class="approx-method-btn active" data-method="round" onclick="setApproxMethod('round')"
                            style="padding: 5px 12px; border-radius: 15px; border: 2px solid var(--primary); background: var(--primary); color: white; font-size: 0.8rem; cursor: pointer;">ÂõõÊç®‰∫îÂÖ•</button>
                        <button class="approx-method-btn" data-method="floor" onclick="setApproxMethod('floor')"
                            style="padding: 5px 12px; border-radius: 15px; border: 2px solid #E2E8F0; background: white; color: var(--text); font-size: 0.8rem; cursor: pointer;">Âàá„ÇäÊç®„Å¶</button>
                        <button class="approx-method-btn" data-method="ceil" onclick="setApproxMethod('ceil')"
                            style="padding: 5px 12px; border-radius: 15px; border: 2px solid #E2E8F0; background: white; color: var(--text); font-size: 0.8rem; cursor: pointer;">Âàá„Çä‰∏ä„Åí</button>
                    </div>
                    <div class="approx-content">
                        <div
                            style="display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-light);">Ë¢´Èô§Êï∞</div>
                                <span id="dividendRounded" style="font-size: 1.1rem;">1200</span> ‚Üí <strong
                                    id="dividendApprox" style="font-size: 1.2rem; color: var(--primary);">1000</strong>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-light);">Èô§Êï∞</div>
                                <span id="divisorRounded" style="font-size: 1.1rem;">4</span> ‚Üí <strong
                                    id="divisorApprox" style="font-size: 1.2rem; color: var(--primary);">4</strong>
                            </div>
                        </div>
                        <div
                            style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                            <span class="approx-calc" id="approxCalc" style="font-size: 1.1rem;">Á¥Ñ1000 √∑ 4 = Á¥Ñ250</span>
                        </div>
                    </div>
                </div>


            </div>


            <!-- Á≠ÜÁÆóË°®Á§∫„Ç®„É™„Ç¢ÔºàÁ≠ÜÁÆó„É¢„Éº„ÉâÁî®Ôºâ -->
            <div class="division-process hidden" id="divisionProcess">
                <div class="division-process-title">‚úèÔ∏è Á≠ÜÁÆó„ÅßË®àÁÆó„Åó„Çà„ÅÜ</div>

                <!-- Á≠ÜÁÆó„É¨„Ç§„Ç¢„Ç¶„Éà -->
                <div class="division-layout" id="divisionLayout"></div>

                <!-- Ë®àÁÆó„Çπ„ÉÜ„ÉÉ„Éó -->
                <div class="calc-steps" id="calcSteps">
                    <div class="calc-step current" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">„Åü„Å¶„Çã</div>
                        <div class="step-action">ÂïÜ„ÇíÁ´ã„Å¶„Çã</div>
                    </div>
                    <div class="calc-step pending" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">„Åã„Åë„Çã</div>
                        <div class="step-action">ÂïÜ √ó Èô§Êï∞</div>
                    </div>
                    <div class="calc-step pending" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">„Å≤„Åè</div>
                        <div class="step-action">Âºï„ÅçÁÆó</div>
                    </div>
                    <div class="calc-step pending" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">„Åä„Çç„Åô</div>
                        <div class="step-action">Ê¨°„ÅÆÊ°Å„Çí„Åä„Çç„Åô</div>
                    </div>
                </div>
            </div>

            <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
            <div class="input-area">
                <div class="input-label" id="inputLabel">Á≠î„Åà„ÇíÈÅ∏„Çì„Åß„Å≠ÔºÅ</div>

                <!-- „Éí„É≥„Éà„Éú„Çø„É≥ -->
                <div class="hint-buttons">
                    <button class="hint-btn" id="hintBtn1" onclick="showHint(1)">üí° „Éí„É≥„Éà1</button>
                    <button class="hint-btn" id="hintBtn2" onclick="showHint(2)">üí° „Éí„É≥„Éà2</button>
                    <button class="hint-btn" id="hintBtn3" onclick="showHint(3)">üí° „Éí„É≥„Éà3</button>
                </div>

                <!-- „Éí„É≥„ÉàË°®Á§∫ -->
                <div class="hint-display" id="hintDisplay">
                    <div class="hint-title" id="hintTitle">„Éí„É≥„Éà</div>
                    <div class="hint-content" id="hintContent"></div>
                </div>

                <!-- 3Êäû„É¢„Éº„Éâ -->
                <div id="choiceInputMode" class="input-mode">
                    <div class="choice-buttons" id="choiceButtons"></div>
                </div>

                <!-- Êï∞Â≠óÂÖ•Âäõ„É¢„Éº„Éâ -->
                <div id="numberInputMode" class="input-mode hidden">
                    <div class="input-group">
                        <input type="number" class="answer-input" id="answerInput" placeholder="?" min="1">
                        <span class="times-label" id="unitLabel">ÂÜÜ</span>
                    </div>
                </div>

                <button class="submit-button" id="submitButton" onclick="checkAnswer()">‚úÖ Á≠î„ÅàÂêà„Çè„Åõ</button>
            </div>

            <!-- „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ -->
            <div class="feedback" id="feedback">
                <div class="feedback-icon" id="feedbackIcon">üéâ</div>
                <div class="feedback-title" id="feedbackTitle">„Åô„Å∞„Çâ„Åó„ÅÑÔºÅ</div>
                <div class="feedback-message" id="feedbackMessage">Ê≠£Ëß£„Åß„ÅôÔºÅ</div>
                <div class="feedback-explanation" id="feedbackExplanation"></div>

                <!-- ‰Ωô„Çä„ÉÅ„Çß„ÉÉ„ÇØ -->
                <div class="remainder-check" id="remainderCheck">
                    <div class="remainder-title">‚úÖ ‰Ωô„Çä„Çí„ÉÅ„Çß„ÉÉ„ÇØ</div>
                    <div class="remainder-content" id="remainderContent"></div>
                </div>

                <button class="next-button" onclick="nextProblem()">Ê¨°„ÅÆÂïèÈ°å„Å∏ ‚ñ∂</button>
            </div>

            <!-- ÊàêÈï∑„Ç∞„É©„Éï -->
            <div class="growth-panel" id="growthPanel">
                <div class="growth-title">üìä „ÅÇ„Å™„Åü„ÅÆÊàêÈï∑</div>
                <div class="growth-item">
                    <div class="growth-label">
                        <span>Ê¶ÇÊï∞„ÅÆÁêÜËß£</span>
                        <span id="approxPercent">0%</span>
                    </div>
                    <div class="growth-bar-bg">
                        <div class="growth-bar approx" id="approxBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="growth-item">
                    <div class="growth-label">
                        <span>Ë®àÁÆó„ÅÆÊ≠£Á¢∫„Åï</span>
                        <span id="calcPercent">0%</span>
                    </div>
                    <div class="growth-bar-bg">
                        <div class="growth-bar calc" id="calcBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="growth-item">
                    <div class="growth-label">
                        <span>‰Ωô„Çä„ÅÆÁêÜËß£</span>
                        <span id="remainderPercent">0%</span>
                    </div>
                    <div class="growth-bar-bg">
                        <div class="growth-bar remainder" id="remainderBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <button class="back-button" onclick="backToTitle()">üè† „Çø„Ç§„Éà„É´„Å´Êàª„Çã</button>
        </div>
    </div>

    <script>
        // „Ç≤„Éº„É†Ë®≠ÂÆö
        let gameSettings = {
            mode: 'story',
            difficulty: 'easy',
            inputMode: 'choice'
        };

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = {
            dividend: 0,
            divisor: 0,
            correctAnswer: 0,
            remainder: 0,
            userAnswer: 0,
            combo: 0,
            correctCount: 0,
            totalCount: 0,
            hintsUsed: 0,
            currentScenario: null,
            approxSkill: 0,
            calcSkill: 0,
            remainderSkill: 0
        };

        // „Éê„Éà„É´Áä∂ÊÖã
        let battleState = {
            enemyHp: 100,
            enemyMaxHp: 100,
            timer: 30,
            round: 1,
            currentEnemy: null,
            timerInterval: null
        };

        // Êïµ„Ç≠„É£„É©„Éá„Éº„Çø
        const enemies = [
            { emoji: 'üê∏', name: '„Çè„ÇäÁÆó„Ç¨„Ç®„É´', hp: 50 },
            { emoji: 'üëª', name: '„Ç¥„Éº„Çπ„Éà', hp: 75 },
            { emoji: 'üê≤', name: '„Éâ„É©„Ç¥„É≥', hp: 100 },
            { emoji: 'üëæ', name: '„Çπ„É©„Ç§„É†', hp: 60 },
            { emoji: 'ü¶ë', name: '„Ç§„Ç´„É¢„É≥„Çπ„Çø„Éº', hp: 80 },
            { emoji: 'ü§ñ', name: '„É≠„Éú„ÉÉ„Éà', hp: 90 },
            { emoji: 'üëπ', name: '„Ç™„Éº„Ç¨', hp: 120 },
            { emoji: 'üßô', name: '„Åæ„Åª„ÅÜ„Å§„Åã„ÅÑ', hp: 85 }
        ];

        // „Ç∑„Éä„É™„Ç™„Éá„Éº„ÇøÔºà„Çà„ÇäËá™ÁÑ∂„Å™Êó•Êú¨Ë™ûË°®Áèæ„Å´‰øÆÊ≠£Ôºâ
        const scenarios = {
            shopping: [
                { icon: 'üõí', text: '„Åø„Çì„Å™„Åß„ÅäË≤∑„ÅÑÁâ©ÔºÅ', template: 'ÂêàË®à{dividend}ÂÜÜ„Çí{divisor}‰∫∫„ÅßÂâ≤„ÇäÂãò„Åô„Çã„Å®„ÄÅ1‰∫∫„ÅÑ„Åè„ÇâÊâï„ÅÜÔºü', unit: 'ÂÜÜ', allowRemainder: true },
                { icon: 'üç∞', text: '„Ç±„Éº„Ç≠Â±ã„Åï„Çì„ÅßÔºÅ', template: '{dividend}ÂÜÜ„ÅÆ„Ç±„Éº„Ç≠„Çª„ÉÉ„Éà„Çí{divisor}‰∫∫„ÅßÂàÜ„Åë„Çã„Å®„ÄÅ1‰∫∫„ÅÑ„Åè„ÇâÔºü', unit: 'ÂÜÜ', allowRemainder: false },
                { icon: 'üéÅ', text: '„Éó„É¨„Çº„É≥„ÉàÈÅ∏„Å≥ÔºÅ', template: '{dividend}ÂÜÜ„ÅÆ‰∫àÁÆó„Åß{divisor}‰∫∫ÂàÜ„ÅÆ„Éó„É¨„Çº„É≥„Éà„ÇíË≤∑„ÅÜ„Å®„ÄÅ1‰∫∫ÂàÜ„ÅÑ„Åè„ÇâÔºü', unit: 'ÂÜÜ', allowRemainder: true }
            ],
            party: [
                { icon: 'üç¨', text: '„Éë„Éº„ÉÜ„Ç£„Éº„ÅÆÊ∫ñÂÇôÔºÅ', template: '„ÅäËèìÂ≠ê{dividend}ÂÄã„Çí{divisor}‰∫∫„ÅßÂêå„ÅòÊï∞„Åö„Å§ÂàÜ„Åë„Çã„Å®„ÄÅ1‰∫∫‰ΩïÂÄãÔºü', unit: 'ÂÄã', allowRemainder: true },
                { icon: 'üçï', text: '„Éî„Ç∂„Éë„Éº„ÉÜ„Ç£„ÉºÔºÅ', template: '„Éî„Ç∂„Çí{dividend}„Éî„Éº„Çπ„Å´Âàá„Å£„Å¶{divisor}‰∫∫„ÅßÂàÜ„Åë„Çã„Å®„ÄÅ1‰∫∫‰Ωï„Éî„Éº„ÇπÔºü', unit: '„Éî„Éº„Çπ', allowRemainder: true },
                { icon: 'üéà', text: 'È£æ„Çä„Å§„ÅëÔºÅ', template: 'È¢®Ëàπ{dividend}ÂÄã„Çí{divisor}„ÅãÊâÄ„Å´Âêå„ÅòÊï∞„Åö„Å§È£æ„Çã„Å®„ÄÅ1„ÅãÊâÄ‰ΩïÂÄãÔºü', unit: 'ÂÄã', allowRemainder: true }
            ],
            school: [
                { icon: 'üìö', text: 'Êú¨„ÅÆÊï¥ÁêÜÔºÅ', template: 'Êú¨{dividend}ÂÜä„Çí1ÊÆµ„Å´{divisor}ÂÜä„Åö„Å§‰∏¶„Åπ„Çã„Å®„ÄÅ‰ΩïÊÆµÂøÖË¶ÅÔºü', unit: 'ÊÆµ', allowRemainder: true, isContained: true },
                { icon: 'üöå', text: 'ÈÅ†Ë∂≥„ÅÆ„Éê„ÇπÔºÅ', template: 'ÂÖêÁ´•{dividend}‰∫∫„Çí{divisor}‰∫∫‰πó„Çä„ÅÆ„Éê„Çπ„ÅßÈÅã„Å∂„Å®„ÄÅ„Éê„Çπ„ÅØ‰ΩïÂè∞ÂøÖË¶ÅÔºü', unit: 'Âè∞', allowRemainder: true, isContained: true },
                { icon: '‚úèÔ∏è', text: '„Åà„Çì„Å¥„Å§ÈÖç„ÇäÔºÅ', template: '„Åà„Çì„Å¥„Å§{dividend}Êú¨„Çí{divisor}‰∫∫„Å´Âêå„ÅòÊú¨Êï∞„Åö„Å§ÈÖç„Çã„Å®„ÄÅ1‰∫∫‰ΩïÊú¨Ôºü', unit: 'Êú¨', allowRemainder: true }
            ]
        };


        // Èõ£ÊòìÂ∫¶Ë®≠ÂÆö
        const difficultySettings = {
            easy: { dividendMin: 20, dividendMax: 99, divisorMin: 2, divisorMax: 9 },
            normal: { dividendMin: 100, dividendMax: 999, divisorMin: 10, divisorMax: 50 },
            hard: { dividendMin: 1000, dividendMax: 9999, divisorMin: 10, divisorMax: 99 }

        };

        // „Éê„Éà„É´ÂàùÊúüÂåñ
        function initBattle() {
            // „É©„É≥„ÉÄ„É†„Å™Êïµ„Çí„Çª„ÉÉ„Éà
            battleState.currentEnemy = enemies[randomInt(0, enemies.length - 1)];
            battleState.enemyMaxHp = battleState.currentEnemy.hp;
            battleState.enemyHp = battleState.currentEnemy.hp;
            battleState.timer = 30;

            document.getElementById('enemyCharacter').textContent = battleState.currentEnemy.emoji;
            document.getElementById('enemyName').textContent = battleState.currentEnemy.name;
            updateBattleHp();
            document.getElementById('battleRound').textContent = `ROUND ${battleState.round}`;
            document.getElementById('battleMessage').textContent = `${battleState.currentEnemy.name}„ÅåÁèæ„Çå„ÅüÔºÅ„Çè„ÇäÁÆó„ÅßÂÄí„Åù„ÅÜÔºÅ`;

            // „Çø„Ç§„Éû„ÉºÈñãÂßã
            startBattleTimer();
        }

        // „Éê„Éà„É´„Çø„Ç§„Éû„ÉºÈñãÂßã
        function startBattleTimer() {
            if (battleState.timerInterval) {
                clearInterval(battleState.timerInterval);
            }

            battleState.timer = 30;
            document.getElementById('timerValue').textContent = battleState.timer;
            document.getElementById('battleTimer').classList.remove('warning');

            battleState.timerInterval = setInterval(() => {
                battleState.timer--;
                document.getElementById('timerValue').textContent = battleState.timer;

                if (battleState.timer <= 5) {
                    document.getElementById('battleTimer').classList.add('warning');
                }

                if (battleState.timer <= 0) {
                    clearInterval(battleState.timerInterval);
                    // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÔºöÊïµ„Åã„ÇâÂèçÊíÉ
                    document.getElementById('battleMessage').textContent = 'ÊôÇÈñìÂàá„ÇåÔºÅÊïµ„ÅÆÊîªÊíÉ„Å†ÔºÅ';
                }
            }, 1000);
        }

        // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
        function stopBattleTimer() {
            if (battleState.timerInterval) {
                clearInterval(battleState.timerInterval);
                battleState.timerInterval = null;
            }
        }

        // HPÊõ¥Êñ∞
        function updateBattleHp() {
            const hpPercent = Math.max(0, (battleState.enemyHp / battleState.enemyMaxHp) * 100);
            document.getElementById('hpValue').textContent = `${battleState.enemyHp}/${battleState.enemyMaxHp}`;
            document.getElementById('hpFill').style.width = hpPercent + '%';

            if (hpPercent <= 30) {
                document.getElementById('hpFill').classList.add('low');
            } else {
                document.getElementById('hpFill').classList.remove('low');
            }
        }

        // „Éê„Éà„É´ÁµêÊûúÂá¶ÁêÜ
        function processBattleResult(isCorrect) {
            stopBattleTimer();

            if (isCorrect) {
                // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÔºàÊÆã„ÇäÊôÇÈñì„Å´Âøú„Åò„Åü„Éú„Éº„Éä„ÇπÔºâ
                const damage = 20 + Math.floor(battleState.timer * 0.5) + (gameState.combo * 5);
                battleState.enemyHp = Math.max(0, battleState.enemyHp - damage);
                updateBattleHp();

                // „ÉÄ„É°„Éº„Ç∏„Ç®„Éï„Çß„ÇØ„Éà
                showDamageEffect(damage);
                document.getElementById('battleMessage').textContent = `${damage}„ÉÄ„É°„Éº„Ç∏ÔºÅÊÆã„ÇäHP: ${battleState.enemyHp}`;

                if (battleState.enemyHp <= 0) {
                    // Êïµ„ÇíÂÄí„Åó„Åü
                    document.getElementById('battleMessage').textContent = `${battleState.currentEnemy.name}„ÇíÂÄí„Åó„ÅüÔºÅüéâ`;
                    battleState.round++;
                }
            } else {
                document.getElementById('battleMessage').textContent = 'ÊîªÊíÉ„ÅåÂ§ñ„Çå„ÅüÔºÅÊ¨°„ÅØÊ≠£Ëß£„Åó„Çà„ÅÜÔºÅ';
            }
        }

        // „ÉÄ„É°„Éº„Ç∏„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫
        function showDamageEffect(damage) {
            const effect = document.createElement('div');
            effect.className = 'damage-effect';
            effect.textContent = `-${damage}`;
            effect.style.left = '50%';
            effect.style.top = '50%';
            document.getElementById('battleArea').appendChild(effect);

            setTimeout(() => effect.remove(), 1000);
        }

        // „É¢„Éº„ÉâÈÅ∏Êäû
        function selectMode(mode) {
            gameSettings.mode = mode;
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.mode === mode);
            });
        }

        // Èõ£ÊòìÂ∫¶Ë®≠ÂÆö
        function setDifficulty(level) {
            gameSettings.difficulty = level;
            document.querySelectorAll('[data-difficulty]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.difficulty === level);
            });
        }

        // ÂÖ•Âäõ„É¢„Éº„ÉâË®≠ÂÆö
        function setInputMode(mode) {
            gameSettings.inputMode = mode;
            document.querySelectorAll('[data-input]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.input === mode);
            });
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            document.getElementById('titleScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('active');

            // Áä∂ÊÖãÂàùÊúüÂåñ
            gameState.combo = 0;
            gameState.correctCount = 0;
            gameState.totalCount = 0;

            loadProgress();
            generateProblem();
        }

        // ÂïèÈ°åÁîüÊàê
        function generateProblem() {
            const settings = difficultySettings[gameSettings.difficulty];

            // Ââ≤„ÇäÂàá„Çå„ÇãÂïèÈ°å„ÇíÁîüÊàê
            gameState.divisor = randomInt(settings.divisorMin, settings.divisorMax);
            const quotient = randomInt(2, Math.floor(settings.dividendMax / gameState.divisor));
            gameState.dividend = quotient * gameState.divisor + randomInt(0, gameState.divisor - 1);
            gameState.correctAnswer = Math.floor(gameState.dividend / gameState.divisor);
            gameState.remainder = gameState.dividend % gameState.divisor;

            // „Ç∑„Éä„É™„Ç™ÈÅ∏Êäû
            const categoryKeys = Object.keys(scenarios);
            const category = categoryKeys[randomInt(0, categoryKeys.length - 1)];
            const scenarioList = scenarios[category];
            gameState.currentScenario = scenarioList[randomInt(0, scenarioList.length - 1)];

            // UIÊõ¥Êñ∞
            updateProblemDisplay();
            updateApproxHint();
            updateNumberLine();
            resetHints();

            // „É¢„Éº„Éâ„Å´Âøú„Åò„ÅüË°®Á§∫Âàá„ÇäÊõø„Åà
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('divisionProcess').classList.add('hidden');
            document.getElementById('scenarioDisplay').classList.add('hidden');
            document.getElementById('approxHint').classList.add('hidden');
            document.getElementById('numberLine').classList.add('hidden');

            if (gameSettings.mode === 'written') {
                // Á≠ÜÁÆó„É¢„Éº„Éâ
                document.getElementById('approxHint').classList.add('hidden');
                document.getElementById('numberLine').classList.add('hidden');
                document.getElementById('divisionProcess').classList.remove('hidden');
                initWrittenDivision();
            } else if (gameSettings.mode === 'battle') {
                // „Éê„Éà„É´„É¢„Éº„Éâ
                document.getElementById('battleArea').classList.remove('hidden');
                document.getElementById('approxHint').classList.remove('hidden');
                document.getElementById('numberLine').classList.remove('hidden');
                initBattle();
            } else if (gameSettings.mode === 'story') {
                // „Çπ„Éà„Éº„É™„Éº„É¢„Éº„Éâ
                document.getElementById('scenarioDisplay').classList.remove('hidden');
                document.getElementById('approxHint').classList.remove('hidden');
                document.getElementById('numberLine').classList.remove('hidden');
            } else {
                // Ë¶ãÁ©ç„ÇÇ„Çä„É¢„Éº„Éâ
                document.getElementById('approxHint').classList.remove('hidden');
                document.getElementById('numberLine').classList.remove('hidden');
            }

            if (gameSettings.inputMode === 'choice') {
                document.getElementById('choiceInputMode').classList.remove('hidden');
                document.getElementById('numberInputMode').classList.add('hidden');
                generateChoices();
            } else {
                document.getElementById('choiceInputMode').classList.add('hidden');
                document.getElementById('numberInputMode').classList.remove('hidden');
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').focus();
            }

            document.getElementById('feedback').classList.remove('show');
            document.getElementById('submitButton').disabled = false;
            gameState.userAnswer = 0;
        }

        // ÂïèÈ°åË°®Á§∫Êõ¥Êñ∞
        function updateProblemDisplay() {
            const scenario = gameState.currentScenario;

            if (gameSettings.mode === 'story' && scenario) {
                document.getElementById('scenarioDisplay').classList.remove('hidden');
                document.getElementById('scenarioIcon').textContent = scenario.icon;
                document.getElementById('scenarioText').innerHTML = scenario.text + '<br><span class="scenario-highlight">' +
                    scenario.template.replace('{dividend}', gameState.dividend).replace('{divisor}', gameState.divisor) + '</span>';
                document.getElementById('unitLabel').textContent = scenario.unit;
            } else {
                document.getElementById('scenarioDisplay').classList.add('hidden');
                document.getElementById('unitLabel').textContent = '';
            }

            document.getElementById('dividend').textContent = gameState.dividend;
            document.getElementById('divisor').textContent = gameState.divisor;
        }

        // Á≠ÜÁÆóÂàùÊúüÂåñ
        function initWrittenDivision() {
            const dividendStr = gameState.dividend.toString();
            const divisorStr = gameState.divisor.toString();

            const layout = document.getElementById('divisionLayout');
            layout.innerHTML = '';

            // Á≠ÜÁÆó„ÅÆ‰∏äÈÉ®ÔºàÂïÜ„ÅÆ‰ΩçÁΩÆÔºâ
            const quotientRow = document.createElement('div');
            quotientRow.className = 'division-row';
            quotientRow.innerHTML = `<div class="division-cell" style="visibility: hidden;"></div>`;
            for (let i = 0; i < dividendStr.length; i++) {
                quotientRow.innerHTML += `<div class="division-cell quotient empty" id="quotient-${i}">?</div>`;
            }
            layout.appendChild(quotientRow);

            // Èô§Êï∞„Å®Ë¢´Èô§Êï∞„ÅÆË°å
            const mainRow = document.createElement('div');
            mainRow.className = 'division-row';
            mainRow.innerHTML = `
                <div class="division-cell divisor">${divisorStr}</div>
                <span class="division-symbol">)</span>
            `;
            for (let i = 0; i < dividendStr.length; i++) {
                mainRow.innerHTML += `<div class="division-cell dividend">${dividendStr[i]}</div>`;
            }
            layout.appendChild(mainRow);

            // Ë®àÁÆó„Çπ„ÉÜ„ÉÉ„Éó„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.calc-step').forEach((step, index) => {
                step.classList.remove('current', 'completed');
                if (index === 0) {
                    step.classList.add('current');
                } else {
                    step.classList.add('pending');
                }
            });
        }

        // Á≠ÜÁÆó„Çπ„ÉÜ„ÉÉ„Éó„ÇíÈÄ≤„ÇÅ„Çã
        function advanceWrittenStep(stepNum) {
            document.querySelectorAll('.calc-step').forEach((step, index) => {
                step.classList.remove('current', 'completed', 'pending');
                if (index < stepNum) {
                    step.classList.add('completed');
                } else if (index === stepNum) {
                    step.classList.add('current');
                } else {
                    step.classList.add('pending');
                }
            });
        }

        // ÁèæÂú®„ÅÆÊ¶ÇÊï∞Ë®àÁÆóÊñπÊ≥ï
        let currentApproxMethod = 'round'; // 'round', 'floor', 'ceil'

        // Ê¶ÇÊï∞Ë®àÁÆóÊñπÊ≥ï„ÇíË®≠ÂÆö
        function setApproxMethod(method) {
            currentApproxMethod = method;
            document.querySelectorAll('.approx-method-btn').forEach(btn => {
                if (btn.dataset.method === method) {
                    btn.style.background = 'var(--primary)';
                    btn.style.borderColor = 'var(--primary)';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'white';
                    btn.style.borderColor = '#E2E8F0';
                    btn.style.color = 'var(--text)';
                    btn.classList.remove('active');
                }
            });
            updateApproxHint();
        }

        // Ê¶ÇÊï∞„Éí„É≥„ÉàÊõ¥Êñ∞ÔºàÂº∑ÂåñÁâàÔºâ
        function updateApproxHint() {
            const dividendApprox = roundToFirstDigitWithMethod(gameState.dividend, currentApproxMethod);
            const divisorApprox = roundToFirstDigitWithMethod(gameState.divisor, currentApproxMethod);
            const approxAnswer = Math.floor(dividendApprox / divisorApprox);

            document.getElementById('dividendRounded').textContent = gameState.dividend;
            document.getElementById('dividendApprox').textContent = dividendApprox;
            document.getElementById('divisorRounded').textContent = gameState.divisor;
            document.getElementById('divisorApprox').textContent = divisorApprox;

            const methodName = currentApproxMethod === 'round' ? 'ÂõõÊç®‰∫îÂÖ•' :
                (currentApproxMethod === 'floor' ? 'Âàá„ÇäÊç®„Å¶' : 'Âàá„Çä‰∏ä„Åí');
            document.getElementById('approxCalc').innerHTML = `<span style="font-size:0.8rem;color:var(--text-light);">(${methodName})</span> Á¥Ñ${dividendApprox} √∑ ${divisorApprox} = <strong style="color:var(--primary);">Á¥Ñ${approxAnswer}</strong>`;
        }

        // Êï∞Áõ¥Á∑öÊõ¥Êñ∞ÔºàÂº∑ÂåñÁâàÔºâ
        function updateNumberLine() {
            const maxValue = Math.ceil(gameState.correctAnswer * 1.5 / 10) * 10;
            const minValue = 0;
            const midValue = Math.floor(maxValue / 2);

            document.getElementById('lineMin').textContent = minValue;
            document.getElementById('lineMid').textContent = midValue;
            document.getElementById('lineMax').textContent = maxValue;

            // „É¶„Éº„Ç∂„Éº„Éû„Éº„Ç´„Éº„Çí„É™„Çª„ÉÉ„Éà
            const userMarker = document.getElementById('userMarker');
            userMarker.textContent = 'Ôºü';
            userMarker.style.left = '50%';
            userMarker.style.opacity = '0.5';
            userMarker.style.display = 'flex';

            // Ê≠£Ëß£„Éû„Éº„Ç´„Éº„ÇíÈùûË°®Á§∫
            const answerMarker = document.getElementById('answerMarker');
            answerMarker.style.display = 'none';
        }

        // „É¶„Éº„Ç∂„Éº„Éû„Éº„Ç´„Éº„ÇíÊõ¥Êñ∞
        function updateUserMarker(value) {
            const maxValue = parseInt(document.getElementById('lineMax').textContent);
            const position = Math.min(100, Math.max(0, (value / maxValue) * 100));

            const userMarker = document.getElementById('userMarker');
            userMarker.textContent = value;
            userMarker.style.left = position + '%';
            userMarker.style.opacity = '1';
        }

        // Ê≠£Ëß£„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫
        function showAnswerMarker() {
            const maxValue = parseInt(document.getElementById('lineMax').textContent);
            const position = Math.min(100, Math.max(0, (gameState.correctAnswer / maxValue) * 100));

            const answerMarker = document.getElementById('answerMarker');
            answerMarker.textContent = gameState.correctAnswer;
            answerMarker.style.left = position + '%';
            answerMarker.style.display = 'flex';
        }

        // ‰∏ä„Åã„Çâ1Ê°Å„Å´‰∏∏„ÇÅ„ÇãÔºàÊñπÂºèÈÅ∏ÊäûÂèØËÉΩÔºâ
        function roundToFirstDigitWithMethod(num, method) {
            if (num < 10) return num;
            const digits = num.toString().length;
            const divisor = Math.pow(10, digits - 1);

            switch (method) {
                case 'floor':
                    return Math.floor(num / divisor) * divisor;
                case 'ceil':
                    return Math.ceil(num / divisor) * divisor;
                case 'round':
                default:
                    return Math.round(num / divisor) * divisor;
            }
        }

        // ‰∏ä„Åã„Çâ1Ê°Å„Å´‰∏∏„ÇÅ„ÇãÔºà„Éá„Éï„Ç©„É´„Éà: ÂõõÊç®‰∫îÂÖ•Ôºâ
        function roundToFirstDigit(num) {
            return roundToFirstDigitWithMethod(num, 'round');
        }

        // „É©„É≥„ÉÄ„É†Êï¥Êï∞
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }


        // 3ÊäûÁîüÊàê
        function generateChoices() {
            const correct = gameState.correctAnswer;
            const choices = [correct];

            while (choices.length < 3) {
                const offset = randomInt(-5, 5);
                if (offset === 0) continue;
                const choice = correct + offset;
                if (choice > 0 && !choices.includes(choice)) {
                    choices.push(choice);
                }
            }

            choices.sort(() => Math.random() - 0.5);

            const container = document.getElementById('choiceButtons');
            container.innerHTML = '';
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice;
                btn.onclick = () => selectChoice(btn, choice);
                container.appendChild(btn);
            });
        }

        // ÈÅ∏ÊäûËÇ¢ÈÅ∏Êäû
        function selectChoice(btn, value) {
            document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            gameState.userAnswer = value;

            // Êï∞Áõ¥Á∑ö„ÅÆ„É¶„Éº„Ç∂„Éº„Éû„Éº„Ç´„Éº„ÇíÊõ¥Êñ∞
            updateUserMarker(value);
        }

        // „Éí„É≥„ÉàË°®Á§∫ÔºàÊîπËâØÁâàÔºâ
        function showHint(level) {
            const hintDisplay = document.getElementById('hintDisplay');
            const hintContent = document.getElementById('hintContent');
            const hintTitle = document.getElementById('hintTitle');

            // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆÊ¶ÇÊï∞Ë®àÁÆóÊñπÊ≥ï„Çí‰ΩøÁî®
            const dividendApprox = roundToFirstDigitWithMethod(gameState.dividend, currentApproxMethod);
            const divisorApprox = roundToFirstDigitWithMethod(gameState.divisor, currentApproxMethod);
            const approxAnswer = Math.floor(dividendApprox / divisorApprox);

            const methodName = currentApproxMethod === 'round' ? 'ÂõõÊç®‰∫îÂÖ•' :
                (currentApproxMethod === 'floor' ? 'Âàá„ÇäÊç®„Å¶' : 'Âàá„Çä‰∏ä„Åí');

            let content = '';
            let icon = '';
            switch (level) {
                case 1:
                    icon = 'üîç';
                    content = `<strong>ËÄÉ„ÅàÊñπ„ÅÆ„Ç≥„ÉÑ</strong><br>
                        ‰∏ä„Åã„Çâ1„Åë„Åü„ÅÆÊ¶ÇÊï∞Ôºà„Åå„ÅÑ„Åô„ÅÜÔºâ„Å´„Åó„Å¶ËÄÉ„Åà„Å¶„Åø„Çà„ÅÜÔºÅ<br>
                        <small style="color:var(--text-light);">‰æã: 234 ‚Üí Á¥Ñ200„ÄÅ47 ‚Üí Á¥Ñ50</small>`;
                    break;
                case 2:
                    icon = 'üìù';
                    content = `<strong>${methodName}„ÅßÊ¶ÇÊï∞„Å´„Åô„Çã„Å®...</strong><br>
                        ${gameState.dividend} ‚Üí <strong style="color:var(--primary);">Á¥Ñ${dividendApprox}</strong><br>
                        ${gameState.divisor} ‚Üí <strong style="color:var(--primary);">Á¥Ñ${divisorApprox}</strong><br>
                        <small style="color:var(--text-light);">„Åì„ÅÆ2„Å§„ÅÆÊï∞„ÅßË®àÁÆó„Åó„Å¶„Åø„Çà„ÅÜÔºÅ</small>`;
                    break;
                case 3:
                    icon = 'üéØ';
                    content = `<strong>Ë¶ãÂΩì„Åå„Å§„ÅÑ„Åü„ÇàÔºÅ</strong><br>
                        Á¥Ñ${dividendApprox} √∑ ${divisorApprox} = <strong style="color:var(--accent);font-size:1.2em;">Á¥Ñ${approxAnswer}</strong><br>
                        Á≠î„Åà„ÅØ <strong>${approxAnswer}</strong> „Å´Ëøë„ÅÑÊï∞„Å´„Å™„Çã„ÅØ„ÅöÔºÅ<br>
                        <small style="color:var(--text-light);">‚úì „Åì„Çå„Çà„ÇäÂ∞ë„ÅóÂ§ß„Åç„ÅÑ„ÅãÂ∞è„Åï„ÅÑ„Åã„ÇÇÁ¢∫Ë™ç„Åó„Çà„ÅÜ</small>`;
                    break;
            }

            hintTitle.innerHTML = `${icon} „Éí„É≥„Éà ${level}`;
            hintContent.innerHTML = content;
            hintDisplay.classList.add('show');

            // „Éí„É≥„Éà‰ΩøÁî®Ê∏à„Åø„Å´„Åô„Çã
            for (let i = 1; i <= level; i++) {
                document.getElementById(`hintBtn${i}`).disabled = true;
            }
            gameState.hintsUsed = Math.max(gameState.hintsUsed, level);
        }

        // „Éí„É≥„Éà„É™„Çª„ÉÉ„Éà
        function resetHints() {
            document.getElementById('hintDisplay').classList.remove('show');
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`hintBtn${i}`).disabled = false;
            }
            gameState.hintsUsed = 0;
        }

        // ÂõûÁ≠î„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAnswer() {
            if (gameSettings.inputMode === 'number') {
                gameState.userAnswer = parseInt(document.getElementById('answerInput').value);
            }

            if (!gameState.userAnswer || gameState.userAnswer < 1) {
                alert('Á≠î„Åà„ÇíÈÅ∏„Çì„Åß„Å≠ÔºÅ');
                return;
            }

            gameState.totalCount++;
            const isCorrect = gameState.userAnswer === gameState.correctAnswer;
            const diff = Math.abs(gameState.userAnswer - gameState.correctAnswer);

            let icon, title, message, titleClass;

            if (isCorrect) {
                icon = 'üéâ';
                title = '‚óé ÂÆåÁíßÔºÅ';
                message = '„Åô„Å∞„Çâ„Åó„ÅÑÔºÅÊ≠£Á¢∫„Å´Ë®àÁÆó„Åß„Åç„Åü„Å≠ÔºÅ';
                titleClass = 'perfect';
                gameState.correctCount++;
                gameState.combo++;
                gameState.calcSkill = Math.min(100, gameState.calcSkill + 5);
            } else if (diff <= 2) {
                icon = 'üëç';
                title = '‚óã „Åä„Åó„ÅÑÔºÅ';
                message = '„ÅÑ„ÅÑÊÑü„ÅòÔºÅ„ÇÇ„ÅÜÂ∞ë„Åó„ÅßÊ≠£Ëß£„Å†„Å£„Åü„Å≠ÔºÅ';
                titleClass = 'good';
                gameState.combo = 0;
                gameState.approxSkill = Math.min(100, gameState.approxSkill + 3);
            } else {
                icon = 'üí°';
                title = '‚ñ≥ „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÔºÅ';
                message = 'Ê¶ÇÊï∞„Çí‰Ωø„Å£„Å¶Ë¶ãÂΩì„Çí„Å§„Åë„Å¶„Åø„Çà„ÅÜÔºÅ';
                titleClass = 'ok';
                gameState.combo = 0;
            }

            // Ê¶ÇÊï∞‰ΩøÁî®„Åß„Éú„Éº„Éä„Çπ
            if (gameState.hintsUsed > 0 && isCorrect) {
                gameState.approxSkill = Math.min(100, gameState.approxSkill + 3);
            }

            // „Éê„Éà„É´„É¢„Éº„Éâ„ÅÆÂá¶ÁêÜ
            if (gameSettings.mode === 'battle') {
                processBattleResult(isCorrect);
            }

            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
            document.getElementById('feedbackIcon').textContent = icon;
            document.getElementById('feedbackTitle').textContent = title;
            document.getElementById('feedbackTitle').className = 'feedback-title ' + titleClass;
            document.getElementById('feedbackMessage').textContent = message;

            // „É¢„Éº„Éâ„Å´Âøú„Åò„ÅüÂçò‰ΩçË°®Á§∫
            const unitText = (gameSettings.mode === 'story' && gameState.currentScenario) ? gameState.currentScenario.unit : '';

            // „Å§„Åæ„Åö„ÅçÂØæÂøú„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            let stumbleAdvice = '';
            if (!isCorrect) {
                if (diff <= 3) {
                    stumbleAdvice = `<div style="background:#FEF3C7;padding:10px;border-radius:8px;margin-top:10px;">
                        <strong>üí≠ „Éí„É≥„ÉàÔºö</strong>Ê¶ÇÊï∞„ÅßË¶ãÂΩì„Çí„Å§„Åë„Çã„Å®„Åç„ÄÅË¢´Èô§Êï∞„Å®Èô§Êï∞„Çí‰∏ä„Åã„Çâ1„Åë„Åü„ÅÆÊ¶ÇÊï∞„Å´„Åó„Å¶ËÄÉ„Åà„Å¶„Åø„Çà„ÅÜÔºÅ
                    </div>`;
                } else {
                    stumbleAdvice = `<div style="background:#FEE2E2;padding:10px;border-radius:8px;margin-top:10px;">
                        <strong>üìö Âæ©ÁøíÔºö</strong>${gameState.dividend}„Çí${gameState.divisor}„ÅßÂâ≤„Çã„Å®„Åç„ÄÅ„Åæ„Åö„Äå${gameState.divisor}„Åå‰ΩïÂõûÂÖ•„Çã„Åã„Äç„ÇíËÄÉ„Åà„Çà„ÅÜ„ÄÇ
                        <br>‰æã: ${roundToFirstDigit(gameState.dividend)} √∑ ${roundToFirstDigit(gameState.divisor)} = Á¥Ñ${Math.floor(roundToFirstDigit(gameState.dividend) / roundToFirstDigit(gameState.divisor))} „Å®Ë¶ãÂΩì„Åå„Å§„Åè„ÇàÔºÅ
                    </div>`;
                }
            }

            // Ëß£Ë™¨
            const explanation = `
                <strong>Ê≠£Ëß£: ${gameState.correctAnswer}${unitText}</strong><br><br>
                ${gameState.dividend} √∑ ${gameState.divisor} = ${gameState.correctAnswer}${gameState.remainder > 0 ? ' ‰Ωô„Çä ' + gameState.remainder : ''}<br><br>
                üí° <strong>ËÄÉ„ÅàÊñπ:</strong><br>
                ${getRoundingHint()}
                ${stumbleAdvice}
            `;
            document.getElementById('feedbackExplanation').innerHTML = explanation;

            // ‰Ωô„Çä„ÉÅ„Çß„ÉÉ„ÇØ
            const remainderCheck = document.getElementById('remainderCheck');
            const remainderContent = document.getElementById('remainderContent');
            if (gameState.remainder > 0) {
                remainderCheck.style.display = 'block';
                const isRemainderCorrect = gameState.remainder < gameState.divisor;
                remainderContent.innerHTML = `
                    ‰Ωô„Çä (${gameState.remainder}) ${isRemainderCorrect ? '<' : '‚â•'} Ââ≤„ÇãÊï∞ (${gameState.divisor}) 
                    ${isRemainderCorrect ? '<span class="remainder-ok">‚úì OKÔºÅ</span>' : '<span class="remainder-ng">‚úó Á¢∫Ë™ç„Åó„Çà„ÅÜ</span>'}
                    <br><small>üí° ‰Ωô„Çä„ÅØÂâ≤„ÇãÊï∞„Çà„ÇäÂ∞è„Åï„Åè„Å™„Çã„ÇàÔºÅ</small>
                `;
                if (isRemainderCorrect) {
                    gameState.remainderSkill = Math.min(100, gameState.remainderSkill + 2);
                }
            } else {
                remainderCheck.style.display = 'none';
            }

            // Êï∞Áõ¥Á∑öÊõ¥Êñ∞
            updateNumberLineWithAnswer();

            document.getElementById('feedback').classList.add('show');
            document.getElementById('submitButton').disabled = true;

            updateScore();
            updateGrowth();
            saveProgress();
        }

        // ‰∏∏„ÇÅÊñπ„ÅÆ„Éí„É≥„Éà
        function getRoundingHint() {
            const dividendApprox = roundToFirstDigit(gameState.dividend);
            const divisorApprox = roundToFirstDigit(gameState.divisor);
            const approxAnswer = Math.floor(dividendApprox / divisorApprox);

            return `${gameState.dividend} ‚Üí Á¥Ñ${dividendApprox}„ÄÅ${gameState.divisor} ‚Üí Á¥Ñ${divisorApprox} „Å®ËÄÉ„Åà„Çã„Å®<br>
                    Á¥Ñ${dividendApprox} √∑ ${divisorApprox} = Á¥Ñ${approxAnswer} „Å®Ë¶ãÂΩì„Åå„Å§„Åè„ÇàÔºÅ`;
        }

        // Êï∞Áõ¥Á∑ö„Å´Á≠î„ÅàË°®Á§∫
        function updateNumberLineWithAnswer() {
            // Ê≠£Ëß£„Éû„Éº„Ç´„Éº„ÇíË°®Á§∫
            showAnswerMarker();
        }

        // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞
        function updateScore() {
            document.getElementById('totalCount').textContent = gameState.totalCount;
            document.getElementById('correctCount').textContent = gameState.correctCount;
            document.getElementById('comboCount').textContent = gameState.combo;

            const accuracy = gameState.totalCount > 0 ? Math.round((gameState.correctCount / gameState.totalCount) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // ÊàêÈï∑„Ç∞„É©„ÉïÊõ¥Êñ∞
        function updateGrowth() {
            document.getElementById('approxBar').style.width = gameState.approxSkill + '%';
            document.getElementById('approxPercent').textContent = gameState.approxSkill + '%';

            document.getElementById('calcBar').style.width = gameState.calcSkill + '%';
            document.getElementById('calcPercent').textContent = gameState.calcSkill + '%';

            document.getElementById('remainderBar').style.width = gameState.remainderSkill + '%';
            document.getElementById('remainderPercent').textContent = gameState.remainderSkill + '%';
        }

        // Ê¨°„ÅÆÂïèÈ°å
        function nextProblem() {
            generateProblem();
        }

        // „Çø„Ç§„Éà„É´„Å´Êàª„Çã
        function backToTitle() {
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('titleScreen').classList.remove('hidden');
        }

        // ÈÄ≤Êçó‰øùÂ≠ò
        function saveProgress() {
            localStorage.setItem('divisionMaster', JSON.stringify({
                approxSkill: gameState.approxSkill,
                calcSkill: gameState.calcSkill,
                remainderSkill: gameState.remainderSkill,
                totalCount: gameState.totalCount,
                correctCount: gameState.correctCount
            }));
        }

        // ÈÄ≤ÊçóË™≠„ÅøËæº„Åø
        function loadProgress() {
            const saved = localStorage.getItem('divisionMaster');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.approxSkill = data.approxSkill || 0;
                gameState.calcSkill = data.calcSkill || 0;
                gameState.remainderSkill = data.remainderSkill || 0;
            }
            updateGrowth();
        }

        // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•Âäõ
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('answerInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') checkAnswer();
            });
        });
    </script>
</body>

</html>