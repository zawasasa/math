<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂïÜ„ÅÆË¶ãÁ´ã„Å¶„Éê„Éà„É´ - „Åï„Åï„Å£„Å®ÁÆóÊï∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@500&family=M+PLUS+Rounded+1c:wght@800&display=swap" rel="stylesheet">
    <style>
        :root {
            --orange: #FF9AA2;
            --yellow: #FFDAC1;
            --light-green: #E2F0CB;
            --light-blue: #B5EAD7;
            --text: #6B5B95;
            --white: #FFFFF0;
            --font-main: 'M PLUS Rounded 1c', sans-serif;
            --font-title: 'Kiwi Maru', serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--light-green) 0%, var(--light-blue) 100%);
            background-image:
                radial-gradient(rgba(255,255,255,0.3) 15%, transparent 16%),
                radial-gradient(rgba(255,255,255,0.3) 15%, transparent 16%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* „Çø„Ç§„Éà„É´ÁîªÈù¢ */
        .title-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .game-title {
            font-family: var(--font-title);
            font-size: 3rem;
            color: var(--text);
            text-shadow: 3px 3px 0 var(--white);
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .game-subtitle {
            font-size: 1.3rem;
            color: var(--text);
            margin-bottom: 40px;
            line-height: 1.8;
        }

        /* Ë®≠ÂÆö„Éë„Éç„É´ */
        .settings-panel {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin: 30px auto;
            max-width: 600px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-label {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text);
            margin-bottom: 15px;
            display: block;
        }

        .option-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .option-btn {
            background: white;
            border: 3px solid var(--text);
            color: var(--text);
            font-size: 1.1rem;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .option-btn.active {
            background: var(--orange);
            border-color: var(--orange);
            color: white;
        }

        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #CCC;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .switch.active {
            background: var(--light-blue);
        }

        .switch-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .switch.active .switch-knob {
            transform: translateX(30px);
        }

        .start-button, .next-button, .back-button {
            background: linear-gradient(135deg, var(--orange) 0%, #FF8A95 100%);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 20px 60px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #E07A86;
            transition: all 0.2s;
            margin: 10px;
        }

        .start-button:hover, .next-button:hover, .back-button:hover {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #E07A86;
        }

        .start-button:active, .next-button:active, .back-button:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        .back-button {
            background: linear-gradient(135deg, var(--light-blue) 0%, #A0D9C4 100%);
            box-shadow: 0 6px 0 #8AC4AF;
            font-size: 1.2rem;
            padding: 15px 40px;
        }

        .back-button:hover {
            box-shadow: 0 3px 0 #8AC4AF;
        }

        /* „Ç≤„Éº„É†ÁîªÈù¢ */
        .game-screen {
            display: none;
        }

        /* „Çø„Éñ„É¨„ÉÉ„Éà‰ª•‰∏ä„Åß2„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„Éà */
        @media (min-width: 768px) {
            .game-screen {
                display: none; /* „Éá„Éï„Ç©„É´„Éà„ÅØÈùûË°®Á§∫ */
            }

            .game-screen.active {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                max-height: 100vh;
                overflow: hidden;
            }

            .score-board {
                grid-column: 1 / -1;
                padding: 10px;
                margin-bottom: 10px;
            }

            .badges-area {
                grid-column: 1 / -1;
                padding: 10px;
                margin-bottom: 10px;
            }

            .battle-area {
                grid-column: 1 / 2;
                margin-bottom: 10px;
            }

            .input-area {
                grid-column: 2 / 3;
                margin-bottom: 10px;
            }

            .feedback, #gameOverScreen {
                grid-column: 1 / -1;
            }
        }

        .score-board {
            background: var(--white);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.75rem;
            color: var(--text);
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .score-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text);
        }

        /* „Éê„ÉÉ„Ç∏„Ç®„É™„Ç¢ */
        .badges-area {
            background: var(--yellow);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .badges-title {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text);
        }

        .badges-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .badge {
            background: white;
            border-radius: 10px;
            padding: 8px;
            min-width: 60px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            opacity: 0.3;
            transition: all 0.3s;
        }

        .badge.unlocked {
            opacity: 1;
            transform: scale(1.05);
            animation: badgeUnlock 0.5s ease-out;
        }

        @keyframes badgeUnlock {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1.05) rotate(0deg); opacity: 1; }
        }

        .badge-icon {
            font-size: 1.5rem;
            margin-bottom: 3px;
        }

        .badge-name {
            font-size: 0.65rem;
            color: var(--text);
            font-weight: bold;
        }

        /* „Éê„Éà„É´ÁîªÈù¢ */
        .battle-area {
            background: var(--white);
            border-radius: 15px;
            padding: 20px 15px;
            margin-bottom: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .monster {
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .monster-icon {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .hp-label {
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 5px;
        }

        .hp-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--orange);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }

        /* HP„Éê„Éº */
        .hp-bar-container {
            width: 80%;
            max-width: 300px;
            height: 20px;
            background: #DDD;
            border-radius: 10px;
            margin: 10px auto;
            overflow: hidden;
            border: 2px solid var(--text);
            position: relative;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 50%, #CDDC39 100%);
            width: 100%;
            transition: width 0.8s ease-out, background 0.5s;
            border-radius: 8px;
        }

        .hp-bar.low {
            background: linear-gradient(90deg, #FF9800 0%, #FFC107 100%);
        }

        .hp-bar.critical {
            background: linear-gradient(90deg, #F44336 0%, #FF5252 100%);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* „ÉÄ„É°„Éº„Ç∏Êï∞ÂÄ§ */
        .damage-number {
            position: absolute;
            font-size: 3rem;
            font-weight: bold;
            color: #FF6B6B;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            pointer-events: none;
            animation: damageFloat 1s ease-out forwards;
            z-index: 1000;
        }

        @keyframes damageFloat {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 1;
            }
            50% {
                transform: translateY(-50px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }

        /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */
        .particle {
            position: absolute;
            font-size: 2rem;
            pointer-events: none;
            animation: particleFloat 1.5s ease-out forwards;
            z-index: 999;
        }

        @keyframes particleFloat {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) rotate(720deg) scale(0);
                opacity: 0;
            }
        }

        /* ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        /* „É¢„É≥„Çπ„Çø„ÉºË¢´„ÉÄ„É°„Éº„Ç∏ */
        .monster.damaged {
            animation: monsterDamage 0.5s;
        }

        @keyframes monsterDamage {
            0%, 100% { transform: translateY(0) scale(1); filter: brightness(1); }
            25% { transform: translateY(-10px) scale(1.1); filter: brightness(1.5); }
            50% { transform: translateY(5px) scale(0.95); filter: brightness(0.8); }
            75% { transform: translateY(-5px) scale(1.05); filter: brightness(1.2); }
        }

        /* „Ç≥„É≥„ÉúÁÇé„Ç®„Éï„Çß„ÇØ„Éà */
        .combo-fire {
            position: relative;
        }

        .combo-fire::before {
            content: 'üî•';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            animation: fireFlicker 0.3s infinite;
        }

        @keyframes fireFlicker {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 0.8; }
        }

        /* Á¥ôÂêπÈõ™ */
        .confetti {
            position: absolute;
            font-size: 1.5rem;
            pointer-events: none;
            animation: confettiFall 3s ease-out forwards;
            z-index: 1001;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(500px) rotate(720deg);
                opacity: 0;
            }
        }

        /* „É¢„É≥„Çπ„Çø„ÉºÊíÉÁ†¥ÊºîÂá∫ */
        .monster.defeated {
            animation: monsterDefeat 1s forwards;
        }

        @keyframes monsterDefeat {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 0.5;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }

        /* ÁàÜÁô∫„Ç®„Éï„Çß„ÇØ„Éà */
        .explosion {
            position: absolute;
            font-size: 5rem;
            pointer-events: none;
            animation: explode 1s ease-out forwards;
            z-index: 1002;
        }

        @keyframes explode {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        /* ËÉåÊôØ„Éï„É©„ÉÉ„Ç∑„É• */
        .flash-gold {
            animation: flashGold 0.5s;
        }

        @keyframes flashGold {
            0%, 100% { background: var(--white); }
            50% { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        }

        .flash-silver {
            animation: flashSilver 0.5s;
        }

        @keyframes flashSilver {
            0%, 100% { background: var(--white); }
            50% { background: linear-gradient(135deg, #C0C0C0 0%, #E8E8E8 100%); }
        }

        /* Ë∂Ö„Ç≥„É≥„Éú„Ç®„Éï„Çß„ÇØ„Éà */
        .super-combo {
            position: relative;
        }

        .super-combo::after {
            content: '‚ö°';
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            animation: lightning 0.2s infinite;
        }

        @keyframes lightning {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.5; transform: translateX(-50%) scale(1.3); }
        }

        .mega-combo {
            position: relative;
        }

        .mega-combo::after {
            content: 'üåà';
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            animation: rainbow 1s infinite;
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* „Éú„Çø„É≥„Ç®„Éï„Çß„ÇØ„ÉàÂº∑Âåñ */
        .submit-button {
            position: relative;
            overflow: hidden;
        }

        .submit-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .submit-button:active::before {
            width: 300px;
            height: 300px;
        }

        .vs-divider {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text);
            margin: 15px 0;
        }

        .attack-section {
            margin-bottom: 15px;
        }

        .attack-label {
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 5px;
        }

        .attack-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--light-blue);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }

        /* ÂÖ•Âäõ„Ç®„É™„Ç¢ */
        .input-area {
            background: var(--yellow);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .input-label {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text);
            margin-bottom: 12px;
            text-align: center;
        }

        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .answer-input {
            font-family: var(--font-main);
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            width: 150px;
            padding: 10px;
            border: 3px solid var(--text);
            border-radius: 12px;
            background: white;
            color: var(--text);
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 4px rgba(255, 154, 162, 0.3);
        }

        /* 3Êäû„É¢„Éº„Éâ */
        .choice-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .choice-btn {
            background: white;
            border: 4px solid var(--text);
            color: var(--text);
            font-size: 2.5rem;
            font-weight: bold;
            padding: 20px 40px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }

        .choice-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .choice-btn.selected {
            background: var(--orange);
            border-color: var(--orange);
            color: white;
        }

        /* „Çπ„É©„Ç§„ÉÄ„Éº„É¢„Éº„Éâ */
        .slider-container {
            margin-bottom: 30px;
        }

        .slider-value {
            font-size: 3rem;
            font-weight: bold;
            color: var(--text);
            margin-bottom: 20px;
            text-align: center;
        }

        .slider {
            width: 100%;
            height: 15px;
            border-radius: 10px;
            background: #DDD;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 10px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--orange);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .slider::-moz-range-thumb {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--orange);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text);
            opacity: 0.7;
        }

        .times-label {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text);
        }

        /* ‰Ωç„Åî„Å®ÂÖ•Âäõ„É¢„Éº„Éâ */
        .digit-input-container {
            text-align: center;
        }

        .digit-step-label {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--orange);
            margin-bottom: 20px;
            animation: pulse-text 1.5s infinite;
        }

        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .digit-answer-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .digit-box {
            display: inline-block;
            width: 50px;
            height: 60px;
            line-height: 60px;
            font-size: 2rem;
            font-weight: bold;
            color: var(--text);
            background: white;
            border: 3px solid var(--text);
            border-radius: 12px;
            text-align: center;
        }

        .digit-box.active {
            border-color: var(--orange);
            background: #FFF5F5;
            animation: box-highlight 1s infinite;
        }

        @keyframes box-highlight {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .digit-box.filled {
            background: var(--light-green);
            border-color: #4CAF50;
        }

        .digit-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .digit-btn {
            background: white;
            border: 3px solid var(--text);
            color: var(--text);
            font-size: 1.5rem;
            font-weight: bold;
            padding: 10px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 55px;
        }

        .digit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            background: var(--light-blue);
        }

        .digit-btn:active {
            transform: translateY(0);
        }

        .submit-button {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%);
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 0 #D84343;
            transition: all 0.2s;
            display: block;
            margin: 0 auto;
        }

        .submit-button:hover {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #D84343;
        }

        .submit-button:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        .submit-button:disabled {
            background: #CCC;
            box-shadow: 0 6px 0 #AAA;
            cursor: not-allowed;
        }

        /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .feedback {
            display: none;
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback.show {
            display: block;
        }

        .feedback-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .feedback-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .feedback-message {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .feedback-explanation {
            background: var(--light-green);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            line-height: 1.8;
        }

        .feedback-perfect {
            color: #FF6B6B;
        }

        .feedback-good {
            color: #FFA500;
        }

        .feedback-ok {
            color: #4CAF50;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }

            .monster-icon {
                font-size: 4rem;
            }

            .hp-value {
                font-size: 3rem;
            }

            .attack-value {
                font-size: 2rem;
            }

            .answer-input {
                font-size: 2rem;
                width: 150px;
            }

            .choice-btn {
                font-size: 2rem;
                padding: 15px 30px;
                min-width: 100px;
            }

            .submit-button {
                font-size: 1.5rem;
                padding: 15px 40px;
            }
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 1.5rem;
            }

            .answer-input {
                font-size: 1.8rem;
                width: 120px;
            }

            .choice-btn {
                font-size: 1.8rem;
                padding: 12px 25px;
            }

            .score-board {
                flex-direction: column;
            }

            .option-buttons {
                flex-direction: column;
            }

            .option-btn {
                width: 100%;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
        <div class="title-screen" id="titleScreen">
            <h1 class="game-title">‚öîÔ∏è ÂïÜ„ÅÆË¶ãÁ´ã„Å¶„Éê„Éà„É´ ‚öîÔ∏è</h1>
            <p class="game-subtitle">
                „É¢„É≥„Çπ„Çø„Éº„ÅÆHP„ÇíË¶ã„Å¶„ÄÅ<br>
                ‰ΩïÂõûÊîªÊíÉ„Åô„Çå„Å∞ÂÄí„Åõ„Çã„ÅãË¶ãÁ´ã„Å¶„Çà„ÅÜÔºÅ<br>
                <strong>„Äå„Å†„ÅÑ„Åü„ÅÑ‰ΩïÂÄç„Åã„Äç</strong>„ÇíÊÑüË¶ö„ÅßÊé¥„ÇÄÁ∑¥Áøí„Å†„ÇàüéØ
            </p>

            <!-- Ë®≠ÂÆö„Éë„Éç„É´ -->
            <div class="settings-panel">
                <div class="setting-group">
                    <label class="setting-label">„Ç≤„Éº„É†„É¢„Éº„Éâ</label>
                    <div class="option-buttons">
                        <button class="option-btn active" data-gamemode="endless" onclick="setGameMode('endless')">
                            ‚ôæÔ∏è „Ç®„É≥„Éâ„É¨„Çπ<br><small>(Ëá™Áî±Á∑¥Áøí)</small>
                        </button>
                        <button class="option-btn" data-gamemode="timeattack" onclick="setGameMode('timeattack')">
                            ‚è±Ô∏è „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ<br><small>(60Áßí)</small>
                        </button>
                        <button class="option-btn" data-gamemode="survival" onclick="setGameMode('survival')">
                            ‚ù§Ô∏è „Çµ„Éê„Ç§„Éê„É´<br><small>(„Éü„Çπ3Âõû)</small>
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">Èõ£ÊòìÂ∫¶</label>
                    <div class="option-buttons">
                        <button class="option-btn active" data-difficulty="easy" onclick="setDifficulty('easy')">
                            üòä Á∞°Âçò<br><small>(2Ê°Å√∑2Ê°Å)</small>
                        </button>
                        <button class="option-btn" data-difficulty="normal" onclick="setDifficulty('normal')">
                            üòé ÊôÆÈÄö<br><small>(3Ê°Å√∑2Ê°Å)</small>
                        </button>
                        <button class="option-btn" data-difficulty="hard" onclick="setDifficulty('hard')">
                            üò§ Èõ£„Åó„ÅÑ<br><small>(4Ê°Å√∑3Ê°Å)</small>
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">ÂÖ•Âäõ„É¢„Éº„Éâ</label>
                    <div class="option-buttons">
                        <button class="option-btn" data-mode="digit" onclick="setInputMode('digit')">
                            üéØ ‰Ωç„Åî„Å®ÂÖ•Âäõ<br><small>(„Åä„Åô„Åô„ÇÅÔºÅ)</small>
                        </button>
                        <button class="option-btn" data-mode="number" onclick="setInputMode('number')">
                            üî¢ Êï∞Â≠óÂÖ•Âäõ
                        </button>
                        <button class="option-btn" data-mode="choice" onclick="setInputMode('choice')">
                            ‚úã 3Êäû
                        </button>
                        <button class="option-btn" data-mode="slider" onclick="setInputMode('slider')">
                            üéöÔ∏è „Çπ„É©„Ç§„ÉÄ„Éº
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">„Çµ„Ç¶„É≥„Éâ</label>
                    <div class="toggle-switch">
                        <span>üîá OFF</span>
                        <div class="switch active" onclick="toggleSound()">
                            <div class="switch-knob"></div>
                        </div>
                        <span>üîä ON</span>
                    </div>
                </div>
            </div>

            <button class="start-button" onclick="startGame()">‚öîÔ∏è „Éê„Éà„É´ÈñãÂßãÔºÅ</button>
            <br>
            <button class="back-button" onclick="location.href='index.html'">üè† „Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
        </div>

        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div class="game-screen" id="gameScreen">
            <!-- „Çπ„Ç≥„Ç¢„Éú„Éº„Éâ -->
            <div class="score-board">
                <!-- „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ„É¢„Éº„ÉâÁî®„Çø„Ç§„Éû„Éº -->
                <div class="score-item" id="timerDisplay" style="display: none;">
                    <div class="score-label">‚è±Ô∏è ÊÆã„ÇäÊôÇÈñì</div>
                    <div class="score-value" id="timerValue">60</div>
                </div>
                <!-- „Çµ„Éê„Ç§„Éê„É´„É¢„Éº„ÉâÁî®„É©„Ç§„Éï -->
                <div class="score-item" id="livesDisplay" style="display: none;">
                    <div class="score-label">‚ù§Ô∏è ÊÆã„Çä„É©„Ç§„Éï</div>
                    <div class="score-value" id="livesValue">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                </div>
                <div class="score-item">
                    <div class="score-label">ÈÄ£Á∂öÊ≠£Ëß£</div>
                    <div class="score-value" id="comboCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">ÊíÉÁ†¥Êï∞</div>
                    <div class="score-value" id="defeatCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">‚óéÂà§ÂÆö</div>
                    <div class="score-value" id="perfectCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">‚óãÂà§ÂÆö</div>
                    <div class="score-value" id="goodCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">ÂïèÈ°åÊï∞</div>
                    <div class="score-value" id="totalCount">0</div>
                </div>
            </div>

            <!-- „Éê„ÉÉ„Ç∏„Ç®„É™„Ç¢ -->
            <div class="badges-area">
                <div class="badges-title">üèÜ Áç≤Âæó„Éê„ÉÉ„Ç∏</div>
                <div class="badges-list" id="badgesList">
                    <div class="badge" data-badge="perfect10">
                        <div class="badge-icon">ü•â</div>
                        <div class="badge-name">‚óé10Âõû</div>
                    </div>
                    <div class="badge" data-badge="perfect30">
                        <div class="badge-icon">ü•à</div>
                        <div class="badge-name">‚óé30Âõû</div>
                    </div>
                    <div class="badge" data-badge="perfect50">
                        <div class="badge-icon">ü•á</div>
                        <div class="badge-name">‚óé50Âõû</div>
                    </div>
                    <div class="badge" data-badge="combo5">
                        <div class="badge-icon">üî•</div>
                        <div class="badge-name">ÈÄ£Á∂ö5Âõû</div>
                    </div>
                    <div class="badge" data-badge="total100">
                        <div class="badge-icon">üìö</div>
                        <div class="badge-name">100ÂïèÈÅîÊàê</div>
                    </div>
                </div>
            </div>

            <!-- „Éê„Éà„É´„Ç®„É™„Ç¢ -->
            <div class="battle-area" id="battleArea">
                <div class="monster" id="monsterElement">
                    <div class="monster-icon" id="monsterIcon">üëæ</div>
                    <div class="hp-label">„É¢„É≥„Çπ„Çø„ÉºHP</div>
                    <div class="hp-value" id="hpValue">1234</div>

                    <!-- HP„Éê„Éº -->
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="hpBar"></div>
                    </div>
                </div>

                <div class="vs-divider">√∑</div>

                <div class="attack-section">
                    <div class="attack-label">„ÅÇ„Å™„Åü„ÅÆÊîªÊíÉÂäõ</div>
                    <div class="attack-value" id="attackValue">56</div>
                </div>
            </div>

            <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
            <div class="input-area">
                <div class="input-label">‰ΩïÂõûÊîªÊíÉ„Åô„Çå„Å∞ÂÄí„Åõ„ÇãÔºü</div>

                <!-- Êï∞Â≠óÂÖ•Âäõ„É¢„Éº„Éâ -->
                <div id="numberInputMode" class="input-mode">
                    <div class="input-group">
                        <input type="number" class="answer-input" id="answerInput" placeholder="?" min="1" max="999">
                        <span class="times-label">Âõû</span>
                    </div>
                </div>

                <!-- 3Êäû„É¢„Éº„Éâ -->
                <div id="choiceInputMode" class="input-mode hidden">
                    <div class="choice-buttons" id="choiceButtons">
                        <!-- ÂãïÁöÑÁîüÊàê -->
                    </div>
                </div>

                <!-- „Çπ„É©„Ç§„ÉÄ„Éº„É¢„Éº„Éâ -->
                <div id="sliderInputMode" class="input-mode hidden">
                    <div class="slider-container">
                        <div class="slider-value"><span id="sliderValue">50</span> Âõû</div>
                        <input type="range" class="slider" id="answerSlider" min="1" max="100" value="50">
                        <div class="slider-labels">
                            <span id="sliderMin">1</span>
                            <span id="sliderMax">100</span>
                        </div>
                    </div>
                </div>

                <!-- ‰Ωç„Åî„Å®ÂÖ•Âäõ„É¢„Éº„Éâ -->
                <div id="digitInputMode" class="input-mode hidden">
                    <div class="digit-input-container">
                        <div class="digit-step-label" id="digitStepLabel">Áôæ„ÅÆ‰Ωç„ÇíË¶ãÁ´ã„Å¶„Çà„ÅÜ</div>
                        <div class="digit-answer-display">
                            <span class="digit-box" id="digit100">_</span>
                            <span class="digit-box" id="digit10">_</span>
                            <span class="digit-box" id="digit1">_</span>
                            <span class="times-label">Âõû</span>
                        </div>
                        <div class="digit-buttons" id="digitButtons">
                            <!-- ÂãïÁöÑÁîüÊàê -->
                        </div>
                    </div>
                </div>

                <button class="submit-button" id="submitButton" onclick="checkAnswer()">‚öîÔ∏è ÊîªÊíÉ„Åô„ÇãÔºÅ</button>
            </div>

            <!-- „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ -->
            <div class="feedback" id="feedback">
                <div class="feedback-icon" id="feedbackIcon">üéâ</div>
                <div class="feedback-title" id="feedbackTitle">ÂÆåÁíß„Å™Ë¶ãÁ´ã„Å¶ÔºÅ</div>
                <div class="feedback-message" id="feedbackMessage">Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ</div>
                <div class="feedback-explanation" id="feedbackExplanation"></div>
                <button class="next-button" onclick="nextProblem()">Ê¨°„ÅÆÂïèÈ°å„Å∏ ‚ñ∂</button>
            </div>

            <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ -->
            <div class="feedback" id="gameOverScreen" style="display: none;">
                <div class="feedback-icon" id="gameOverIcon">üèÅ</div>
                <div class="feedback-title" id="gameOverTitle">„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ</div>
                <div class="feedback-message" id="gameOverMessage">„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ</div>
                <div class="feedback-explanation" id="gameOverStats"></div>
                <button class="next-button" onclick="restartGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶ üîÑ</button>
                <button class="back-button" onclick="backToTitle()">„Çø„Ç§„Éà„É´„Å´Êàª„Çã üè†</button>
            </div>
        </div>
    </div>

    <script>
        // „Ç≤„Éº„É†Ë®≠ÂÆö
        let gameSettings = {
            difficulty: 'easy',    // easy, normal, hard
            inputMode: 'digit',    // digit, number, choice, slider
            soundEnabled: true,
            gameMode: 'endless',   // endless, timeattack, survival
        };

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = {
            dividend: 0,
            divisor: 0,
            correctAnswer: 0,
            userAnswer: 0,
            combo: 0,
            perfectCount: 0,
            goodCount: 0,
            totalCount: 0,
            defeatCount: 0,  // ÊíÉÁ†¥Êï∞
            currentHP: 100,  // ÁèæÂú®„ÅÆHPÔºà‰ªÆÊÉ≥Ôºâ
            timeRemaining: 60,  // „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ„É¢„Éº„ÉâÁî®ÔºàÁßíÔºâ
            livesRemaining: 3,  // „Çµ„Éê„Ç§„Éê„É´„É¢„Éº„ÉâÁî®
            // ‰Ωç„Åî„Å®ÂÖ•Âäõ„É¢„Éº„ÉâÁî®
            digitStep: 0,      // ÁèæÂú®„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó (0=Áôæ„ÅÆ‰Ωç, 1=ÂçÅ„ÅÆ‰Ωç, 2=‰∏Ä„ÅÆ‰Ωç)
            digitInputs: [],   // ÂêÑÊ°Å„ÅÆÂÖ•ÂäõÂÄ§
            quotientDigits: [], // ÂïÜ„ÅÆÂêÑÊ°ÅÔºàÊ≠£Ëß£Ôºâ
            badges: {
                perfect10: false,
                perfect30: false,
                perfect50: false,
                combo5: false,
                total100: false,
            }
        };

        // „Çø„Ç§„Éû„ÉºÁî®
        let timerInterval = null;

        // „É¢„É≥„Çπ„Çø„Éº„ÅÆÁµµÊñáÂ≠ó„É™„Çπ„Éà
        const monsters = ['üëæ', 'üëπ', 'üë∫', 'üêâ', 'ü¶ñ', 'ü¶ï', 'üê≤', 'üßü', 'üßõ'];

        // AudioContext for sound
        let audioContext;

        // „Ç≤„Éº„É†„É¢„Éº„ÉâË®≠ÂÆö
        function setGameMode(mode) {
            gameSettings.gameMode = mode;
            document.querySelectorAll('[data-gamemode]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.gamemode === mode);
            });
        }

        // Èõ£ÊòìÂ∫¶Ë®≠ÂÆö
        function setDifficulty(level) {
            gameSettings.difficulty = level;
            document.querySelectorAll('[data-difficulty]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.difficulty === level);
            });
        }

        // ÂÖ•Âäõ„É¢„Éº„ÉâË®≠ÂÆö
        function setInputMode(mode) {
            gameSettings.inputMode = mode;
            document.querySelectorAll('[data-mode]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        // „Çµ„Ç¶„É≥„ÉâÂàáÊõø
        function toggleSound() {
            gameSettings.soundEnabled = !gameSettings.soundEnabled;
            const switchEl = document.querySelector('.switch');
            switchEl.classList.toggle('active', gameSettings.soundEnabled);
        }

        // „Çµ„Ç¶„É≥„ÉâÂÜçÁîü
        function playSound(type) {
            if (!gameSettings.soundEnabled) return;

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'perfect') {
                // ÂÆåÁíß„Å™Ë¶ãÁ´ã„Å¶: È´ò„ÅÑÈü≥
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'good') {
                // „ÅÑ„ÅÑË¶ãÁ´ã„Å¶: ‰∏≠Èü≥
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } else if (type === 'ok') {
                // „ÇÇ„ÅÜ‰∏ÄÊÅØ: ‰Ωé„ÅÑÈü≥
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            }
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            document.getElementById('titleScreen').classList.add('hidden');
            const gameScreen = document.getElementById('gameScreen');
            gameScreen.style.display = 'block';
            gameScreen.classList.add('active');
            document.getElementById('gameOverScreen').style.display = 'none';

            // „É¢„Éº„Éâ„Å´Âøú„Åò„Å¶ÂàùÊúüÂåñ
            if (gameSettings.gameMode === 'timeattack') {
                gameState.timeRemaining = 60;
                document.getElementById('timerDisplay').style.display = 'block';
                document.getElementById('livesDisplay').style.display = 'none';
                startTimer();
            } else if (gameSettings.gameMode === 'survival') {
                gameState.livesRemaining = 3;
                document.getElementById('livesDisplay').style.display = 'block';
                document.getElementById('timerDisplay').style.display = 'none';
                updateLivesDisplay();
            } else {
                // „Ç®„É≥„Éâ„É¨„Çπ„É¢„Éº„Éâ
                document.getElementById('timerDisplay').style.display = 'none';
                document.getElementById('livesDisplay').style.display = 'none';
            }

            loadProgress();
            updateBadges();
            generateProblem();
        }

        // „Çø„Ç§„Éû„ÉºÈñãÂßã
        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                document.getElementById('timerValue').textContent = gameState.timeRemaining;

                // 10Áßí‰ª•‰∏ã„ÅßË≠¶ÂëäËâ≤
                if (gameState.timeRemaining <= 10) {
                    document.getElementById('timerValue').style.color = '#FF6B6B';
                }

                // ÊôÇÈñìÂàá„Çå
                if (gameState.timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    gameOver('timeup');
                }
            }, 1000);
        }

        // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // „É©„Ç§„ÉïË°®Á§∫Êõ¥Êñ∞
        function updateLivesDisplay() {
            const hearts = '‚ù§Ô∏è'.repeat(gameState.livesRemaining);
            const brokenHearts = 'üñ§'.repeat(3 - gameState.livesRemaining);
            document.getElementById('livesValue').textContent = hearts + brokenHearts;
        }

        // „É©„Ç§„ÉïÊ∏õÂ∞ë
        function loseLife() {
            gameState.livesRemaining--;
            updateLivesDisplay();

            if (gameState.livesRemaining <= 0) {
                gameOver('nolives');
            }
        }

        // ÂïÜ„ÅÆÂêÑÊ°Å„ÇíË®àÁÆó
        function calculateQuotientDigits(quotient) {
            const digits = [];
            const quotientStr = quotient.toString();

            // 3Ê°ÅÂØæÂøú: Áôæ„ÅÆ‰Ωç„ÄÅÂçÅ„ÅÆ‰Ωç„ÄÅ‰∏Ä„ÅÆ‰Ωç
            if (quotient >= 100) {
                digits.push(Math.floor(quotient / 100));
                digits.push(Math.floor((quotient % 100) / 10));
                digits.push(quotient % 10);
            } else if (quotient >= 10) {
                digits.push(0); // Áôæ„ÅÆ‰Ωç„Å™„Åó
                digits.push(Math.floor(quotient / 10));
                digits.push(quotient % 10);
            } else {
                digits.push(0); // Áôæ„ÅÆ‰Ωç„Å™„Åó
                digits.push(0); // ÂçÅ„ÅÆ‰Ωç„Å™„Åó
                digits.push(quotient);
            }

            return digits;
        }

        // ÂïèÈ°åÁîüÊàê
        function generateProblem() {
            const types = {
                easy: [{ dividendDigits: 2, divisorDigits: 2 }],
                normal: [
                    { dividendDigits: 2, divisorDigits: 2 },
                    { dividendDigits: 3, divisorDigits: 2 }
                ],
                hard: [
                    { dividendDigits: 2, divisorDigits: 2 },
                    { dividendDigits: 3, divisorDigits: 2 },
                    { dividendDigits: 4, divisorDigits: 3 }
                ]
            };

            const availableTypes = types[gameSettings.difficulty];
            const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];

            gameState.divisor = randomNumber(type.divisorDigits);
            const quotient = Math.floor(Math.random() * 98) + 2;
            const remainder = Math.floor(Math.random() * gameState.divisor);
            gameState.dividend = quotient * gameState.divisor + remainder;
            gameState.correctAnswer = quotient;

            // ÂïÜ„ÅÆÂêÑÊ°Å„ÇíË®àÁÆó
            gameState.quotientDigits = calculateQuotientDigits(quotient);

            // ‰Ωç„Åî„Å®ÂÖ•Âäõ„É¢„Éº„Éâ„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            gameState.digitStep = 0;
            gameState.digitInputs = [];

            // UIÊõ¥Êñ∞
            document.getElementById('hpValue').textContent = gameState.dividend;
            document.getElementById('attackValue').textContent = gameState.divisor;
            document.getElementById('monsterIcon').textContent = monsters[Math.floor(Math.random() * monsters.length)];
            document.getElementById('feedback').classList.remove('show');

            // HP „Çí„É™„Çª„ÉÉ„Éà
            gameState.currentHP = 100;

            // HP„Éê„ÉºÊõ¥Êñ∞
            updateHPBar();

            // ÂÖ•Âäõ„É¢„Éº„ÉâÂàáÊõø
            switchInputMode();
        }

        // ÂÖ•Âäõ„É¢„Éº„ÉâÂàáÊõø
        function switchInputMode() {
            const modes = ['numberInputMode', 'choiceInputMode', 'sliderInputMode', 'digitInputMode'];
            modes.forEach(mode => {
                document.getElementById(mode).classList.add('hidden');
            });

            const submitButton = document.getElementById('submitButton');

            if (gameSettings.inputMode === 'digit') {
                document.getElementById('digitInputMode').classList.remove('hidden');
                submitButton.style.display = 'none'; // ‰Ωç„Åî„Å®ÂÖ•Âäõ„É¢„Éº„Éâ„Åß„ÅØ„Éú„Çø„É≥ÈùûË°®Á§∫
                setupDigitInput();
            } else {
                submitButton.style.display = 'block'; // ‰ªñ„ÅÆ„É¢„Éº„Éâ„Åß„ÅØ„Éú„Çø„É≥Ë°®Á§∫

                if (gameSettings.inputMode === 'number') {
                    document.getElementById('numberInputMode').classList.remove('hidden');
                    document.getElementById('answerInput').value = '';
                    document.getElementById('answerInput').focus();
                } else if (gameSettings.inputMode === 'choice') {
                    document.getElementById('choiceInputMode').classList.remove('hidden');
                    generateChoices();
                } else if (gameSettings.inputMode === 'slider') {
                    document.getElementById('sliderInputMode').classList.remove('hidden');
                    setupSlider();
                }
            }
        }

        // 3ÊäûÁîüÊàê
        function generateChoices() {
            const correct = gameState.correctAnswer;
            const choices = [correct];

            // 2„Å§„ÅÆ‰∏çÊ≠£Ëß£„ÇíÁîüÊàê
            while (choices.length < 3) {
                const offset = Math.floor(Math.random() * 10) - 5; // -5„Äú+5
                const choice = correct + offset;
                if (choice > 0 && !choices.includes(choice)) {
                    choices.push(choice);
                }
            }

            // „Ç∑„É£„ÉÉ„Éï„É´
            choices.sort(() => Math.random() - 0.5);

            // „Éú„Çø„É≥ÁîüÊàê
            const container = document.getElementById('choiceButtons');
            container.innerHTML = '';
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice;
                btn.onclick = () => selectChoice(btn, choice);
                container.appendChild(btn);
            });
        }

        // ÈÅ∏ÊäûËÇ¢ÈÅ∏Êäû
        function selectChoice(btn, value) {
            document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            gameState.userAnswer = value;
        }

        // „Çπ„É©„Ç§„ÉÄ„ÉºË®≠ÂÆö
        function setupSlider() {
            const slider = document.getElementById('answerSlider');
            const min = Math.max(1, gameState.correctAnswer - 20);
            const max = gameState.correctAnswer + 20;
            const mid = Math.floor((min + max) / 2);

            slider.min = min;
            slider.max = max;
            slider.value = mid;

            document.getElementById('sliderMin').textContent = min;
            document.getElementById('sliderMax').textContent = max;
            document.getElementById('sliderValue').textContent = mid;

            slider.oninput = function() {
                document.getElementById('sliderValue').textContent = this.value;
                gameState.userAnswer = parseInt(this.value);
            };
        }

        // ‰Ωç„Åî„Å®ÂÖ•Âäõ„É¢„Éº„ÉâË®≠ÂÆö
        function setupDigitInput() {
            updateDigitDisplay();
            generateDigitButtons();
        }

        // ‰Ωç„Åî„Å®Ë°®Á§∫Êõ¥Êñ∞
        function updateDigitDisplay() {
            // ÂïÜ„ÅÆÊ°ÅÊï∞„ÇíÂà§ÂÆö
            const quotient = gameState.correctAnswer;
            let numDigits = 1;
            let startDigit = 2; // 0=Áôæ„ÅÆ‰Ωç, 1=ÂçÅ„ÅÆ‰Ωç, 2=‰∏Ä„ÅÆ‰Ωç

            if (quotient >= 100) {
                numDigits = 3;
                startDigit = 0;
            } else if (quotient >= 10) {
                numDigits = 2;
                startDigit = 1;
            }

            // „Çπ„ÉÜ„ÉÉ„Éó„É©„Éô„É´ÔºàÂÆüÈöõ„ÅÆÊ°Å„Å´Âøú„Åò„Å¶Ôºâ
            const allLabels = ['Áôæ„ÅÆ‰Ωç„ÇíË¶ãÁ´ã„Å¶„Çà„ÅÜ', 'ÂçÅ„ÅÆ‰Ωç„ÇíË¶ãÁ´ã„Å¶„Çà„ÅÜ', '‰∏Ä„ÅÆ‰Ωç„ÇíË¶ãÁ´ã„Å¶„Çà„ÅÜ'];
            const actualStep = startDigit + gameState.digitStep;
            document.getElementById('digitStepLabel').textContent = allLabels[actualStep];

            // Ê°Å„Éú„ÉÉ„ÇØ„Çπ„ÅÆË°®Á§∫Êõ¥Êñ∞
            const boxes = ['digit100', 'digit10', 'digit1'];
            boxes.forEach((boxId, index) => {
                const box = document.getElementById(boxId);
                box.classList.remove('active', 'filled');

                if (index < startDigit) {
                    // „Åì„ÅÆÊ°Å„ÅØ‰Ωø„Çè„Å™„ÅÑÔºàÈùûË°®Á§∫„Åæ„Åü„ÅØËñÑ„ÅèÔºâ
                    box.style.opacity = '0.2';
                    box.textContent = '‚Äî';
                } else {
                    box.style.opacity = '1';
                    const relativeIndex = index - startDigit;

                    if (relativeIndex < gameState.digitStep) {
                        // ÂÖ•ÂäõÊ∏à„Åø
                        box.textContent = gameState.digitInputs[relativeIndex];
                        box.classList.add('filled');
                    } else if (relativeIndex === gameState.digitStep) {
                        // ÁèæÂú®ÂÖ•Âäõ‰∏≠
                        box.textContent = '_';
                        box.classList.add('active');
                    } else {
                        // Êú™ÂÖ•Âäõ
                        box.textContent = '_';
                    }
                }
            });
        }

        // ‰Ωç„Åî„Å®„Éú„Çø„É≥ÁîüÊàê
        function generateDigitButtons() {
            const container = document.getElementById('digitButtons');
            container.innerHTML = '';

            // Áôæ„ÅÆ‰Ωç„ÅÆÂ†¥Âêà„ÄÅÊúÄÂ§ßÂÄ§„ÇíÂà∂ÈôêÔºàÈÄöÂ∏∏0„Äú2Á®ãÂ∫¶Ôºâ
            let maxDigit = 9;
            if (gameState.digitStep === 0) {
                // ÂïÜ„ÅÆÊúÄÂ§ßÂÄ§„Åã„ÇâÁôæ„ÅÆ‰Ωç„ÅÆÊúÄÂ§ß„ÇíÊé®ÂÆö
                maxDigit = Math.min(2, Math.floor(gameState.correctAnswer / 100) + 1);
            }

            for (let i = 0; i <= maxDigit; i++) {
                const btn = document.createElement('button');
                btn.className = 'digit-btn';
                btn.textContent = i;
                btn.onclick = () => selectDigit(i);
                container.appendChild(btn);
            }
        }

        // Ê°ÅÈÅ∏Êäû
        function selectDigit(digit) {
            gameState.digitInputs[gameState.digitStep] = digit;
            playSound('good');

            // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å∏
            gameState.digitStep++;

            // ÂïÜ„ÅÆÊ°ÅÊï∞„ÇíÂà§ÂÆö
            const quotient = gameState.correctAnswer;
            let numDigits = 1;
            if (quotient >= 100) {
                numDigits = 3;
            } else if (quotient >= 10) {
                numDigits = 2;
            }

            if (gameState.digitStep >= numDigits) {
                // ÂÖ®Ê°ÅÂÖ•ÂäõÂÆå‰∫Ü
                updateDigitDisplay();
                // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂà§ÂÆö
                setTimeout(() => {
                    checkDigitAnswer();
                }, 500);
            } else {
                // Ê¨°„ÅÆÊ°Å„Å∏
                updateDigitDisplay();
                generateDigitButtons();
            }
        }

        // ‰Ωç„Åî„Å®ÂÖ•Âäõ„ÅÆÂà§ÂÆö
        function checkDigitAnswer() {
            // ÂïÜ„ÅÆÊ°ÅÊï∞„ÇíÂà§ÂÆö
            const quotient = gameState.correctAnswer;
            let startDigit = 2; // 0=Áôæ„ÅÆ‰Ωç, 1=ÂçÅ„ÅÆ‰Ωç, 2=‰∏Ä„ÅÆ‰Ωç

            if (quotient >= 100) {
                startDigit = 0;
            } else if (quotient >= 10) {
                startDigit = 1;
            }

            // ÂÖ•Âäõ„Åã„ÇâÂïÜ„ÇíË®àÁÆó
            let answer = 0;
            for (let i = 0; i < gameState.digitInputs.length; i++) {
                const digitPlace = startDigit + i;
                if (digitPlace === 0) {
                    answer += gameState.digitInputs[i] * 100;
                } else if (digitPlace === 1) {
                    answer += gameState.digitInputs[i] * 10;
                } else {
                    answer += gameState.digitInputs[i];
                }
            }

            gameState.userAnswer = answer;

            // ÈÄöÂ∏∏„ÅÆÂà§ÂÆöÂá¶ÁêÜ„Å∏
            checkAnswer();
        }

        // ÊåáÂÆöÊ°ÅÊï∞„ÅÆ„É©„É≥„ÉÄ„É†„Å™Êï∞„ÇíÁîüÊàê
        function randomNumber(digits) {
            const min = Math.pow(10, digits - 1);
            const max = Math.pow(10, digits) - 1;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // === „Éì„Ç∏„É•„Ç¢„É´„Ç®„Éï„Çß„ÇØ„ÉàÈñ¢Êï∞ ===

        // HP„Éê„ÉºÊõ¥Êñ∞
        function updateHPBar() {
            const hpBar = document.getElementById('hpBar');
            const maxHP = gameState.divisor * 100; // ÊúÄÂ§ßHP„ÅÆÊ¶ÇÁÆó
            const currentHP = gameState.dividend;
            const percentage = Math.min(100, (currentHP / maxHP) * 100);

            hpBar.style.width = percentage + '%';

            // HPÊÆãÈáè„ÅßËâ≤„ÇíÂ§âÊõ¥
            if (percentage < 30) {
                hpBar.className = 'hp-bar critical';
            } else if (percentage < 60) {
                hpBar.className = 'hp-bar low';
            } else {
                hpBar.className = 'hp-bar';
            }
        }

        // „ÉÄ„É°„Éº„Ç∏Êï∞ÂÄ§Ë°®Á§∫
        function showDamageNumber(damage) {
            const battleArea = document.getElementById('battleArea');
            const monster = document.getElementById('monsterElement');
            const rect = monster.getBoundingClientRect();
            const battleRect = battleArea.getBoundingClientRect();

            const damageEl = document.createElement('div');
            damageEl.className = 'damage-number';
            damageEl.textContent = `-${damage}`;
            damageEl.style.left = (rect.left - battleRect.left + rect.width / 2) + 'px';
            damageEl.style.top = (rect.top - battleRect.top + rect.height / 2) + 'px';

            battleArea.appendChild(damageEl);

            setTimeout(() => {
                damageEl.remove();
            }, 1000);
        }

        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁîüÊàê
        function createParticles(x, y, count, emoji) {
            const battleArea = document.getElementById('battleArea');

            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = emoji;

                const angle = (Math.PI * 2 * i) / count;
                const distance = 100 + Math.random() * 100;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;

                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');

                battleArea.appendChild(particle);

                setTimeout(() => {
                    particle.remove();
                }, 1500);
            }
        }

        // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ
        function shakeScreen() {
            const battleArea = document.getElementById('battleArea');
            battleArea.classList.add('shake');
            setTimeout(() => {
                battleArea.classList.remove('shake');
            }, 500);
        }

        // „É¢„É≥„Çπ„Çø„ÉºË¢´„ÉÄ„É°„Éº„Ç∏„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function monsterDamage() {
            const monster = document.getElementById('monsterElement');
            monster.classList.add('damaged');
            setTimeout(() => {
                monster.classList.remove('damaged');
            }, 500);
        }

        // Á¥ôÂêπÈõ™„Ç®„Éï„Çß„ÇØ„Éà
        function createConfetti() {
            const battleArea = document.getElementById('battleArea');
            const confettiEmojis = ['üéâ', '‚ú®', '‚≠ê', 'üåü', 'üí´', 'üéä'];

            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = confettiEmojis[Math.floor(Math.random() * confettiEmojis.length)];
                confetti.style.left = Math.random() * 600 + 'px';
                confetti.style.top = '0px';
                confetti.style.animationDelay = (Math.random() * 0.5) + 's';

                battleArea.appendChild(confetti);

                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }

        // „Ç≥„É≥„ÉúÁÇé„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
        function addComboFire() {
            const comboElement = document.getElementById('comboCount');
            const parent = comboElement.parentElement;

            // Êó¢Â≠ò„ÅÆ„ÇØ„É©„Çπ„ÇíÂÖ®ÂâäÈô§
            parent.classList.remove('combo-fire', 'super-combo', 'mega-combo');

            // „Ç≥„É≥„ÉúÊï∞„Å´Âøú„Åò„Å¶„Ç®„Éï„Çß„ÇØ„Éà„ÇíËøΩÂä†
            if (gameState.combo >= 10) {
                parent.classList.add('mega-combo');  // 10„Ç≥„É≥„Éú‰ª•‰∏äÔºöËôπ
            } else if (gameState.combo >= 5) {
                parent.classList.add('super-combo');  // 5„Ç≥„É≥„Éú‰ª•‰∏äÔºöÁ®≤Â¶ª
            } else if (gameState.combo >= 3) {
                parent.classList.add('combo-fire');   // 3„Ç≥„É≥„Éú‰ª•‰∏äÔºöÁÇé
            }
        }

        // „É¢„É≥„Çπ„Çø„ÉºÊíÉÁ†¥ÊºîÂá∫
        function defeatMonster() {
            const monster = document.getElementById('monsterElement');
            const battleArea = document.getElementById('battleArea');
            const rect = monster.getBoundingClientRect();
            const battleRect = battleArea.getBoundingClientRect();

            // ÁàÜÁô∫„Ç®„Éï„Çß„ÇØ„Éà
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = 'üí•';
            explosion.style.left = (rect.left - battleRect.left + rect.width / 2) + 'px';
            explosion.style.top = (rect.top - battleRect.top + rect.height / 2) + 'px';
            battleArea.appendChild(explosion);

            setTimeout(() => {
                explosion.remove();
            }, 1000);

            // „É¢„É≥„Çπ„Çø„ÉºÊ∂àÊªÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            monster.classList.add('defeated');
            setTimeout(() => {
                monster.classList.remove('defeated');
                gameState.defeatCount++;
                updateScore();
                // Êñ∞„Åó„ÅÑ„É¢„É≥„Çπ„Çø„ÉºÂá∫ÁèæÔºàÊ¨°„ÅÆÂïèÈ°åÁîüÊàêÔºâ
                nextProblem();
            }, 1000);
        }

        // ËÉåÊôØ„Éï„É©„ÉÉ„Ç∑„É•
        function flashBackground(type) {
            const battleArea = document.getElementById('battleArea');
            if (type === 'gold') {
                battleArea.classList.add('flash-gold');
                setTimeout(() => {
                    battleArea.classList.remove('flash-gold');
                }, 500);
            } else if (type === 'silver') {
                battleArea.classList.add('flash-silver');
                setTimeout(() => {
                    battleArea.classList.remove('flash-silver');
                }, 500);
            }
        }

        // HPÊ∏õÂ∞ëÂá¶ÁêÜ
        function damageHP(damagePercent) {
            gameState.currentHP -= damagePercent;
            if (gameState.currentHP <= 0) {
                gameState.currentHP = 0;
                // „É¢„É≥„Çπ„Çø„ÉºÊíÉÁ†¥
                setTimeout(() => {
                    defeatMonster();
                }, 1500);  // „Ç®„Éï„Çß„ÇØ„ÉàÂæå„Å´ÊíÉÁ†¥
            }
        }

        // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÂá¶ÁêÜ
        function gameOver(reason) {
            // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
            stopTimer();

            // ÂÖ•Âäõ„ÇíÁÑ°ÂäπÂåñ
            document.getElementById('submitButton').disabled = true;

            // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢„ÇíË°®Á§∫
            let icon = 'üèÅ';
            let title = '„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ';
            let message = '';

            if (reason === 'timeup') {
                icon = '‚è∞';
                title = '„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºÅ';
                message = '60ÁßíÈñì„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ';
            } else if (reason === 'nolives') {
                icon = 'üíî';
                title = '„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ';
                message = '„É©„Ç§„Éï„Åå„Å™„Åè„Å™„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü...';
            }

            document.getElementById('gameOverIcon').textContent = icon;
            document.getElementById('gameOverTitle').textContent = title;
            document.getElementById('gameOverMessage').textContent = message;

            const stats = `
                <strong>üìä „ÅÇ„Å™„Åü„ÅÆÊàêÁ∏æ</strong><br><br>
                ÊíÉÁ†¥Êï∞Ôºö${gameState.defeatCount} ‰Ωì<br>
                ‚óéÂà§ÂÆöÔºö${gameState.perfectCount} Âõû<br>
                ‚óãÂà§ÂÆöÔºö${gameState.goodCount} Âõû<br>
                ÂïèÈ°åÊï∞Ôºö${gameState.totalCount} Âïè<br>
                ÊúÄÈ´òÈÄ£Á∂öÊ≠£Ëß£Ôºö${gameState.combo} Âõû<br>
            `;
            document.getElementById('gameOverStats').innerHTML = stats;

            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÈùûË°®Á§∫
            document.getElementById('feedback').classList.remove('show');

            // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢„ÇíË°®Á§∫
            setTimeout(() => {
                document.getElementById('gameOverScreen').style.display = 'block';
            }, 500);
        }

        // „Ç≤„Éº„É†ÂÜçÈñã
        function restartGame() {
            // „Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„ÉàÔºà„Éê„ÉÉ„Ç∏„Å®Á¥ØË®à„ÅØ‰øùÊåÅÔºâ
            const savedPerfectCount = gameState.perfectCount;
            const savedGoodCount = gameState.goodCount;
            const savedTotalCount = gameState.totalCount;
            const savedBadges = gameState.badges;

            gameState.combo = 0;
            gameState.defeatCount = 0;
            gameState.currentHP = 100;
            gameState.timeRemaining = 60;
            gameState.livesRemaining = 3;

            // „Éê„ÉÉ„Ç∏„Å®Á¥ØË®à„ÅØÂæ©ÂÖÉ
            gameState.perfectCount = savedPerfectCount;
            gameState.goodCount = savedGoodCount;
            gameState.totalCount = savedTotalCount;
            gameState.badges = savedBadges;

            // ÂÖ•Âäõ„ÇíÊúâÂäπÂåñ
            document.getElementById('submitButton').disabled = false;

            // ÁîªÈù¢„É™„Çª„ÉÉ„Éà
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('timerValue').style.color = '';

            startGame();
        }

        // „Çø„Ç§„Éà„É´„Å´Êàª„Çã
        function backToTitle() {
            stopTimer();
            const gameScreen = document.getElementById('gameScreen');
            gameScreen.style.display = 'none';
            gameScreen.classList.remove('active');
            document.getElementById('titleScreen').classList.remove('hidden');
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('submitButton').disabled = false;
        }

        // ÂõûÁ≠î„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAnswer() {
            // ÂÖ•ÂäõÂÄ§ÂèñÂæó
            if (gameSettings.inputMode === 'number') {
                const input = document.getElementById('answerInput');
                gameState.userAnswer = parseInt(input.value);
            } else if (gameSettings.inputMode === 'choice') {
                if (!gameState.userAnswer) {
                    alert('ÈÅ∏ÊäûËÇ¢„ÇíÈÅ∏„Çì„Åß„Å≠ÔºÅ');
                    return;
                }
            } else if (gameSettings.inputMode === 'slider') {
                // slider„ÅØÂ∏∏„Å´userAnswer„Å´ÂÄ§„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã
            }

            if (isNaN(gameState.userAnswer) || gameState.userAnswer < 1) {
                alert('Êï∞Â≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠ÔºÅ');
                return;
            }

            const diff = Math.abs(gameState.userAnswer - gameState.correctAnswer);

            let rank = '';
            let icon = '';
            let title = '';
            let message = '';
            let color = '';

            if (diff <= 1) {
                rank = 'perfect';
                icon = 'üéâ';
                title = '‚óé ÂÆåÁíß„Å™Ë¶ãÁ´ã„Å¶ÔºÅ';
                message = '„Åô„Åî„ÅÑÔºÅ„Åª„ÅºÊ≠£Á¢∫„Å´Ë¶ãÁ´ã„Å¶„Çâ„Çå„Åü„Å≠ÔºÅ';
                color = 'feedback-perfect';
                gameState.perfectCount++;
                gameState.combo++;
                playSound('perfect');

                // „Ç®„Éï„Çß„ÇØ„ÉàÁô∫Âãï
                shakeScreen();
                flashBackground('gold');
                createConfetti();
                monsterDamage();
                showDamageNumber(gameState.divisor);
                const monster = document.getElementById('monsterElement');
                const rect = monster.getBoundingClientRect();
                const battleArea = document.getElementById('battleArea');
                const battleRect = battleArea.getBoundingClientRect();
                createParticles(rect.left - battleRect.left + rect.width / 2, rect.top - battleRect.top + rect.height / 2, 12, '‚≠ê');
                damageHP(40);  // HP„Çí40%Ê∏õÂ∞ë
            } else if (diff <= 2) {
                rank = 'good';
                icon = 'üëç';
                title = '‚óã „ÅÑ„ÅÑË¶ãÁ´ã„Å¶ÔºÅ';
                message = '„ÅÑ„ÅÑÊÑü„ÅòÔºÅ„ÇÇ„ÅÜÂ∞ë„Åó„ÅßÂÆåÁíß„Å†„ÇàÔºÅ';
                color = 'feedback-good';
                gameState.goodCount++;
                gameState.combo++;
                playSound('good');

                // „Ç®„Éï„Çß„ÇØ„ÉàÁô∫Âãï
                flashBackground('silver');
                monsterDamage();
                showDamageNumber(Math.floor(gameState.divisor * 0.7));
                const monster = document.getElementById('monsterElement');
                const rect = monster.getBoundingClientRect();
                const battleArea = document.getElementById('battleArea');
                const battleRect = battleArea.getBoundingClientRect();
                createParticles(rect.left - battleRect.left + rect.width / 2, rect.top - battleRect.top + rect.height / 2, 8, '‚ú®');
                damageHP(25);  // HP„Çí25%Ê∏õÂ∞ë
            } else {
                rank = 'ok';
                icon = 'üí°';
                title = '‚ñ≥ „ÇÇ„ÅÜ‰∏ÄÊÅØÔºÅ';
                message = diff > 10 ? 'Â§ß„Åç„ÅèÂ§ñ„Çå„Å°„ÇÉ„Å£„Åü„Å≠„ÄÇ‰∏∏„ÇÅ„Å¶ËÄÉ„Åà„Å¶„Åø„Çà„ÅÜÔºÅ' : '„ÇÇ„ÅÜÂ∞ë„ÅóÊ≠£Á¢∫„Å´Ë¶ãÁ´ã„Å¶„Å¶„Åø„Çà„ÅÜÔºÅ';
                color = 'feedback-ok';
                gameState.combo = 0;
                playSound('ok');

                // ËªΩ„ÅÑ„Ç®„Éï„Çß„ÇØ„Éà„ÅÆ„Åø
                showDamageNumber(Math.floor(gameState.divisor * 0.3));
                damageHP(10);  // HP„Çí10%Ê∏õÂ∞ë

                // „Çµ„Éê„Ç§„Éê„É´„É¢„Éº„Éâ„Åß„É©„Ç§„ÉïÊ∏õÂ∞ë
                if (gameSettings.gameMode === 'survival') {
                    loseLife();
                }
            }

            gameState.totalCount++;

            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
            document.getElementById('feedbackIcon').textContent = icon;
            document.getElementById('feedbackTitle').textContent = title;
            document.getElementById('feedbackTitle').className = `feedback-title ${color}`;
            document.getElementById('feedbackMessage').textContent = message;

            const explanation = `
                <strong>Ê≠£„Åó„ÅÑÂïÜÔºö${gameState.correctAnswer}Âõû</strong><br>
                „ÅÇ„Å™„Åü„ÅÆË¶ãÁ´ã„Å¶Ôºö${gameState.userAnswer}Âõû<br>
                ${gameState.dividend} √∑ ${gameState.divisor} = ${gameState.correctAnswer}„ÅÇ„Åæ„Çä${gameState.dividend % gameState.divisor}<br>
                <br>
                üí° ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„ÉàÔºö<br>
                ${getRoundingHint()}
            `;
            document.getElementById('feedbackExplanation').innerHTML = explanation;
            document.getElementById('feedback').classList.add('show');

            updateScore();
            checkBadges();
            saveProgress();
        }

        // ‰∏∏„ÇÅÊñπ„ÅÆ„Éí„É≥„ÉàÁîüÊàê
        function getRoundingHint() {
            const dividendRounded = roundToFirstDigit(gameState.dividend);
            const divisorRounded = roundToFirstDigit(gameState.divisor);
            const roughAnswer = Math.floor(dividendRounded / divisorRounded);

            return `„Äå${gameState.dividend}„Äç„Çí„Äå${dividendRounded}„Äç„ÄÅ„Äå${gameState.divisor}„Äç„Çí„Äå${divisorRounded}„Äç„Å®ËÄÉ„Åà„Çã„Å®<br>
                    ${dividendRounded} √∑ ${divisorRounded} ‚âí ${roughAnswer}Âõû „Åè„Çâ„ÅÑ„Å®Ë¶ãÁ´ã„Å¶„Çâ„Çå„Çã„ÇàÔºÅ`;
        }

        // ÊúÄ‰∏ä‰ΩçÊ°Å„Å´‰∏∏„ÇÅ„Çã
        function roundToFirstDigit(num) {
            const digits = num.toString().length;
            const divisor = Math.pow(10, digits - 1);
            return Math.round(num / divisor) * divisor;
        }

        // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞
        function updateScore() {
            document.getElementById('comboCount').textContent = gameState.combo;
            document.getElementById('defeatCount').textContent = gameState.defeatCount;
            document.getElementById('perfectCount').textContent = gameState.perfectCount;
            document.getElementById('goodCount').textContent = gameState.goodCount;
            document.getElementById('totalCount').textContent = gameState.totalCount;

            // „Ç≥„É≥„ÉúÁÇé„Ç®„Éï„Çß„ÇØ„Éà
            addComboFire();
        }

        // „Éê„ÉÉ„Ç∏„ÉÅ„Çß„ÉÉ„ÇØ
        function checkBadges() {
            const newBadges = [];

            if (!gameState.badges.perfect10 && gameState.perfectCount >= 10) {
                gameState.badges.perfect10 = true;
                newBadges.push('perfect10');
            }
            if (!gameState.badges.perfect30 && gameState.perfectCount >= 30) {
                gameState.badges.perfect30 = true;
                newBadges.push('perfect30');
            }
            if (!gameState.badges.perfect50 && gameState.perfectCount >= 50) {
                gameState.badges.perfect50 = true;
                newBadges.push('perfect50');
            }
            if (!gameState.badges.combo5 && gameState.combo >= 5) {
                gameState.badges.combo5 = true;
                newBadges.push('combo5');
            }
            if (!gameState.badges.total100 && gameState.totalCount >= 100) {
                gameState.badges.total100 = true;
                newBadges.push('total100');
            }

            if (newBadges.length > 0) {
                updateBadges();
                // „Éê„ÉÉ„Ç∏Áç≤Âæó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                setTimeout(() => {
                    newBadges.forEach(badge => {
                        const el = document.querySelector(`[data-badge="${badge}"]`);
                        if (el) {
                            el.classList.add('unlocked');
                        }
                    });
                }, 500);
            }
        }

        // „Éê„ÉÉ„Ç∏Ë°®Á§∫Êõ¥Êñ∞
        function updateBadges() {
            Object.keys(gameState.badges).forEach(badge => {
                const el = document.querySelector(`[data-badge="${badge}"]`);
                if (el && gameState.badges[badge]) {
                    el.classList.add('unlocked');
                }
            });
        }

        // Ê¨°„ÅÆÂïèÈ°å
        function nextProblem() {
            generateProblem();
        }

        // ÈÄ≤Êçó‰øùÂ≠ò
        function saveProgress() {
            localStorage.setItem('divisionEstimation', JSON.stringify({
                perfectCount: gameState.perfectCount,
                goodCount: gameState.goodCount,
                totalCount: gameState.totalCount,
                badges: gameState.badges,
            }));
        }

        // ÈÄ≤ÊçóË™≠„ÅøËæº„Åø
        function loadProgress() {
            const saved = localStorage.getItem('divisionEstimation');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.perfectCount = data.perfectCount || 0;
                gameState.goodCount = data.goodCount || 0;
                gameState.totalCount = data.totalCount || 0;
                gameState.badges = data.badges || gameState.badges;
                updateScore();
            }
        }

        // Enter„Ç≠„Éº„ÅßÈÄÅ‰ø°
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('answerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });
        });
    </script>
</body>
</html>
