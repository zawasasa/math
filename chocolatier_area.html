<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å›³å½¢ã®é¢ç©ã‚·ãƒ§ã‚³ãƒ©ãƒ†ã‚£ã‚¨ ã€œæƒ…å ±ã®å–æ¨é¸æŠã€œ</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;800&family=Sawarabi+Mincho&display=swap" rel="stylesheet">
    <style>
        :root {
            --choco-dark: #2d1b15;
            --choco-mid: #4e342e;
            --choco-light: #8d6e63;
            --gold: #fbc02d;
            --cream: #fff9c4;
            --white: #ffffff;
            --accent: #e64a19;
            --memo-bg: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; user-select: none; }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: var(--choco-dark);
            color: var(--white);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Screens --- */
        #title-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, var(--choco-mid), var(--choco-dark));
            z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }

        .logo-area { margin-bottom: 30px; }
        .logo-title { font-size: 3rem; font-weight: 800; color: var(--gold); text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .logo-sub { font-size: 1.2rem; letter-spacing: 0.2rem; margin-top: 10px; color: var(--cream); }

        .menu-container {
            background: rgba(0,0,0,0.3); padding: 30px; border-radius: 30px;
            border: 2px solid var(--gold); max-width: 900px; width: 100%;
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }

        @media (max-width: 600px) {
            .menu-container { grid-template-columns: 1fr; overflow-y: auto; max-height: 80vh; }
            .logo-title { font-size: 2rem; }
        }

        .instruction-box {
            text-align: left; background: rgba(255,255,255,0.05); padding: 25px; border-radius: 20px;
            font-size: 0.9rem; line-height: 1.8; color: var(--white);
            border: 1px solid rgba(251, 192, 45, 0.3);
        }
        .instruction-box h3 { color: var(--gold); margin-bottom: 12px; border-bottom: 1px solid var(--gold); display: inline-block; font-size: 1.1rem; }
        .step-label { color: var(--gold); font-weight: 800; margin-right: 5px; }

        .mode-selection { display: flex; flex-direction: column; gap: 12px; }
        .mode-group-label { font-size: 0.85rem; color: var(--cream); margin-top: 10px; margin-bottom: 4px; border-left: 3px solid var(--gold); padding-left: 8px; text-align: left; }
        
        .mode-btn {
            background: var(--choco-light); border: none; padding: 14px; border-radius: 12px;
            color: white; font-weight: 800; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 0 #5d4037; font-size: 0.95rem; text-align: center;
        }
        .mode-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .mode-btn.special { background: var(--accent); box-shadow: 0 4px 0 #bf360c; }
        .mode-btn.alacarte { background: var(--choco-mid); border: 1px solid var(--gold); }

        /* --- Main Game Layout --- */
        header {
            background: linear-gradient(to bottom, #3e2723, #2d1b15);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--gold);
            z-index: 100;
        }

        .badges { display: flex; gap: 8px; margin-left: 15px; }
        .badge { width: 34px; height: 34px; background: radial-gradient(circle, #ffd700, #b8860b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.4); }

        .stats { font-size: 1rem; color: var(--gold); display: flex; gap: 20px; align-items: center; }
        .score-val { font-size: 1.4rem; font-weight: 800; }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 15px;
            padding: 15px;
            position: relative;
        }

        @media (max-width: 900px) {
            main { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
        }

        #canvas-section {
            position: relative;
            background: #1e120e;
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            overflow: hidden;
            border: 3px solid var(--choco-mid);
        }

        #game-canvas { width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        #memo-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #memo-layer.active { pointer-events: auto; cursor: crosshair; }

        .garcon-container {
            position: absolute;
            bottom: 25px;
            left: 25px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            z-index: 50;
            pointer-events: none;
        }
        .speech-bubble {
            background: white;
            color: var(--choco-dark);
            padding: 12px 18px;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 800;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            width: 450px;
            max-width: 60vw;
            border: 3px solid var(--gold);
            line-height: 1.4;
            position: relative;
        }

        .input-section {
            background: rgba(30, 20, 15, 0.9);
            border-radius: 25px;
            padding: 20px;
            border: 2px solid var(--choco-light);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 20;
            overflow-y: auto;
        }

        .display-zone {
            min-height: 60px;
            background: #000;
            border: 2px solid var(--choco-light);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; color: var(--gold); font-weight: 800;
        }

        .formula-preview {
            font-size: 1.2rem;
            color: var(--cream);
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed var(--gold);
            border-radius: 8px;
            margin-bottom: 5px;
            min-height: 40px;
            display: flex; align-items: center; justify-content: center;
        }

        .bank-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .token { height: 42px; background: var(--gold); color: var(--choco-dark); border-radius: 8px; font-weight: 800; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; box-shadow: 0 3px 0 #b79100; }
        .token.symbol { background: var(--choco-light); color: white; box-shadow: 0 3px 0 #5d4037; }

        .btn { padding: 12px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .btn-check { background: var(--gold); color: #3e2723; box-shadow: 0 4px 0 #b79100; font-size: 1.1rem; }
        .btn-memo-toggle { background: #4e342e; color: white; border: 1px solid var(--gold); }
        .btn-memo-toggle.active { background: #d84315; }

        .hint-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--choco-light);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .hint-btns { display: flex; gap: 5px; }
        .btn-hint-small { flex: 1; padding: 8px; font-size: 0.75rem; background: #673ab7; color: white; border-radius: 8px; border: none; }
        .hint-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            font-size: 0.85rem;
            color: #fff9c4;
            min-height: 60px;
            border-left: 4px solid #673ab7;
            display: none;
            line-height: 1.5;
        }

        #message {
            position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; border-radius: 50px; font-size: 1.8rem; font-weight: 800;
            display: none; z-index: 2000; text-align: center; color: white;
        }
    </style>
</head>
<body>

    <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
    <div id="title-screen">
        <div class="logo-area">
            <h1 class="logo-title">ğŸ« é¢ç©ã‚·ãƒ§ã‚³ãƒ©ãƒ†ã‚£ã‚¨</h1>
            <p class="logo-sub">Area Calculation Gastronomy</p>
        </div>
        
        <div class="menu-container">
            <div class="instruction-box">
                <h3>ğŸ´ å‰ä»˜ã‘ï¼ˆéŠã³æ–¹ã®ã”æ¡ˆå†…ï¼‰</h3>
                <p><span class="step-label">Step 1:</span> å›³å½¢ã®é¢ç©ã‚’æ±‚ã‚ã‚‹ã€Œæ­£ã—ã„å¼ã€ã‚’çµ„ã¿ç«‹ã¦ã¦ãã ã•ã„ã€‚ä¸è¦ãªæ•°å€¤ã¯æ®‹ã™ã®ãŒä¸€æµã®å—œã¿ã§ã™ã€‚</p>
                <p><span class="step-label">Step 2:</span> å¼ãŒèªã‚ã‚‰ã‚ŒãŸã‚‰ã€æ¬¡ã¯ã€Œè¨ˆç®—çµæœã€ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚æ­£ç¢ºãªé¢ç©ãŒæ±‚ã‚ã‚‰ã‚Œã‚Œã°åˆæ ¼ã§ã™ã€‚</p>
                <p><span class="step-label">ğŸ“ ç”»é¢ãƒ¡ãƒ¢:</span> ç”»é¢ã«ç›´æ¥è¨ˆç®—ã‚„è£œåŠ©ç·šã‚’æ›¸ãè¾¼ã‚ã¾ã™ã€‚ãŠå®¢æ§˜ã®æ€è€ƒã®è·¡ã‚’ãŠæ®‹ã—ãã ã•ã„ã€‚</p>
                <p><span class="step-label">ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</span> ã‚®ãƒ£ãƒ«ã‚½ãƒ³ãŒé©åˆ‡ãªåŠ©è¨€ã‚’ã„ãŸã—ã¾ã™ã€‚ã„ã¤ã§ã‚‚ãŠå£°ãŒã‘ã‚’ã€‚</p>
            </div>
            
            <div class="mode-selection">
                <div class="mode-group-label">Recommended</div>
                <button class="mode-btn special" onclick="startGame('all')">æœ¬æ—¥ã®ãŠã¾ã‹ã›å…¨å›³å½¢ã‚³ãƒ¼ã‚¹</button>
                
                <div class="mode-group-label">Ã€ la carteï¼ˆã‚¢ãƒ©ã‚«ãƒ«ãƒˆï¼‰</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="mode-btn alacarte" onclick="startGame('triangle')">ä¸‰è§’å½¢</button>
                    <button class="mode-btn alacarte" onclick="startGame('parallelogram')">å¹³è¡Œå››è¾ºå½¢</button>
                    <button class="mode-btn alacarte" onclick="startGame('rhombus')">ã²ã—å½¢</button>
                    <button class="mode-btn alacarte" onclick="startGame('trapezoid')">å°å½¢</button>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div style="display: flex; align-items: center;">
            <button onclick="exitGame()" style="background:transparent; border:1px solid var(--gold); color:var(--gold); padding:4px 10px; border-radius:10px; cursor:pointer; margin-right:15px; font-size:0.8rem;">â—€ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button>
            <div style="font-weight: 800; color: var(--gold); font-size: 1.2rem;">ğŸ« é¢ç©ã‚·ãƒ§ã‚³ãƒ©ãƒ†ã‚£ã‚¨</div>
            <div class="badges" id="badge-container"></div>
        </div>
        <div class="stats">
            <div id="combo-container" style="display:none; color: #ff5252; font-weight:800;"><span id="combo">0</span> Combo!</div>
            <div>Score: <span id="score" class="score-val">0</span> pts</div>
        </div>
    </header>

    <main>
        <div class="input-section">
            <div id="phase1-ui">
                <p style="font-size: 0.8rem; color: var(--gold); margin-bottom:4px;">Step 1: é¢ç©ã‚’æ±‚ã‚ã‚‹å¼ã‚’ç«‹ã¦ã‚‹</p>
                <div class="display-zone" id="formula-zone"></div>
            </div>
            <div id="phase2-ui" style="display: none;">
                <p style="font-size: 0.8rem; color: var(--gold); margin-bottom:4px;">ç¢ºå®šã—ãŸå¼</p>
                <div class="formula-preview" id="confirmed-formula"></div>
                <p style="font-size: 0.8rem; color: var(--gold); margin-bottom:4px; margin-top: 10px;">Step 2: è¨ˆç®—çµæœã‚’å…¥åŠ›ã™ã‚‹</p>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="display-zone" id="answer-zone" style="flex: 1;"></div>
                    <span style="font-weight:800; color:var(--gold);">cmÂ²</span>
                </div>
            </div>

            <div class="bank-grid" id="token-bank"></div>

            <div style="display: flex; gap: 6px;">
                <button class="btn" style="flex:1; background:#5d4037; color:white; padding:8px;" onclick="popToken()">æˆ»ã™</button>
                <button class="btn" style="flex:1; background:#3e2723; color:white; padding:8px;" onclick="clearCurrentZone()">æ¶ˆã™</button>
            </div>
            <button class="btn btn-check" id="check-btn" onclick="handleCheck()">ã“ã®å¼ã§æ³¨æ–‡ã™ã‚‹</button>
            <button class="btn" id="back-btn" style="display: none; background: transparent; color: #aaa; text-decoration: underline; font-size:0.8rem;" onclick="goBackToStep1()">å¼ã‚’æ›¸ãç›´ã™</button>
            
            <div class="hint-section">
                <div class="hint-btns">
                    <button class="btn-hint-small" onclick="showHint(1)">ğŸ’¡ ãƒ’ãƒ³ãƒˆ1</button>
                    <button class="btn-hint-small" style="background:#4527a0;" onclick="showHint(2)">ğŸ ãƒ’ãƒ³ãƒˆ2</button>
                </div>
                <div id="hint-display" class="hint-box"></div>
            </div>

            <button class="btn btn-memo-toggle active" id="memo-btn" onclick="toggleMemo()" style="margin-top:5px; font-size:0.8rem;">ğŸ“ ç”»é¢ãƒ¡ãƒ¢ï¼šON</button>
        </div>

        <div id="canvas-section">
            <canvas id="game-canvas"></canvas>
            <canvas id="memo-layer" class="active"></canvas>
            
            <div class="garcon-container">
                <div style="display: flex; flex-direction: column; align-items: center; filter: drop-shadow(0(0,0,0,0.5));">
                    <div style="font-size: 45px; line-height: 1;">ğŸ‘¨ğŸ»â€ğŸ’¼</div>
                    <div style="width: 40px; height: 50px; background: #eee; border-radius: 8px; border: 2px solid #333;"></div>
                </div>
                <div class="speech-bubble" id="garcon-text">ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚æœ¬æ—¥ã‚‚é¢ç©ã®ç‰¹å®šã«åŠ±ã‚“ã§ã¾ã„ã‚Šã¾ã—ã‚‡ã†ã€‚</div>
            </div>
            
            <button class="btn" style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; font-size: 0.75rem; z-index: 100;" onclick="clearMemo()">ãƒ¡ãƒ¢ã‚’æ¶ˆã™</button>
        </div>
    </main>

    <div id="message"></div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'correct') {
                osc.frequency.setValueAtTime(523, now); osc.frequency.exponentialRampToValueAtTime(1046, now + 0.3);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(); osc.stop(now + 0.4);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(); osc.stop(now + 0.2);
            }
        }

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const memoCanvas = document.getElementById('memo-layer');
        const mCtx = memoCanvas.getContext('2d');
        
        let state = {
            score: 0,
            combo: 0,
            currentShape: null,
            phase: 1,
            memoActive: true,
            currentInput: [],
            badgesEarned: [],
            currentMode: 'all',
            confirmedFormulaString: ""
        };

        const SHAPES_JA = { 'parallelogram': 'å¹³è¡Œå››è¾ºå½¢', 'triangle': 'ä¸‰è§’å½¢', 'trapezoid': 'å°å½¢', 'rhombus': 'ã²ã—å½¢' };

        function startGame(mode) {
            state.currentMode = mode;
            document.getElementById('title-screen').style.display = 'none';
            state.score = 0;
            state.combo = 0;
            state.badgesEarned = [];
            document.getElementById('score').innerText = '0';
            document.getElementById('badge-container').innerHTML = '';
            newQuestion();
        }

        function exitGame() { document.getElementById('title-screen').style.display = 'flex'; }

        function init() {
            renderBank();
            resize();
            window.addEventListener('resize', resize);
            setupDrawing();
        }

        function renderBank() {
            const bank = document.getElementById('token-bank');
            bank.innerHTML = '';
            [1,2,3,4,5,6,7,8,9,0].forEach(v => bank.appendChild(createBankToken(v)));
            ['.', 'Ã—', 'Ã·', '(', ')', '+'].forEach(s => bank.appendChild(createBankToken(s, true)));
        }

        function createBankToken(val, isSymbol = false) {
            const div = document.createElement('div');
            div.className = 'token' + (isSymbol ? ' symbol' : '');
            div.innerText = val;
            div.onclick = () => { state.currentInput.push(val); updateDisplay(); };
            return div;
        }

        function popToken() { state.currentInput.pop(); updateDisplay(); }
        function clearCurrentZone() { state.currentInput = []; updateDisplay(); }
        function updateDisplay() { document.getElementById(state.phase === 1 ? 'formula-zone' : 'answer-zone').innerText = state.currentInput.join(''); }

        function resize() {
            const container = document.getElementById('canvas-section');
            canvas.width = container.clientWidth; canvas.height = container.clientHeight;
            memoCanvas.width = canvas.width; memoCanvas.height = canvas.height;
            if(state.currentShape) drawShape();
        }

        function toggleMemo() {
            state.memoActive = !state.memoActive;
            const btn = document.getElementById('memo-btn');
            const layer = document.getElementById('memo-layer');
            if(state.memoActive) {
                btn.innerText = "ğŸ“ ç”»é¢ãƒ¡ãƒ¢ï¼šON"; btn.classList.add('active'); layer.classList.add('active');
            } else {
                btn.innerText = "ğŸ“ ç”»é¢ãƒ¡ãƒ¢ï¼šOFF"; btn.classList.remove('active'); layer.classList.remove('active');
            }
        }

        function clearMemo() { mCtx.clearRect(0, 0, memoCanvas.width, memoCanvas.height); }

        function setupDrawing() {
            let drawing = false;
            const getPos = (e) => {
                const rect = memoCanvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
            const start = (e) => { if(!state.memoActive) return; drawing = true; mCtx.beginPath(); const p = getPos(e); mCtx.moveTo(p.x, p.y); };
            const move = (e) => { if(!drawing || !state.memoActive) return; const p = getPos(e); mCtx.lineTo(p.x, p.y); mCtx.strokeStyle = "rgba(255, 255, 255, 0.7)"; mCtx.lineWidth = 4; mCtx.lineCap = "round"; mCtx.stroke(); };
            memoCanvas.addEventListener('mousedown', start);
            memoCanvas.addEventListener('mousemove', move);
            window.addEventListener('mouseup', () => drawing = false);
            memoCanvas.addEventListener('touchstart', (e) => { start(e); e.preventDefault(); }, {passive: false});
            memoCanvas.addEventListener('touchmove', (e) => { move(e); e.preventDefault(); }, {passive: false});
        }

        function newQuestion() {
            state.phase = 1; state.currentInput = []; 
            updateDisplay();
            document.getElementById('phase1-ui').style.display = 'block';
            document.getElementById('phase2-ui').style.display = 'none';
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('check-btn').innerText = "ã“ã®å¼ã§æ³¨æ–‡ã™ã‚‹";
            document.getElementById('hint-display').style.display = 'none';
            
            let type;
            if (state.currentMode === 'all') {
                const keys = Object.keys(SHAPES_JA);
                type = keys[Math.floor(Math.random() * keys.length)];
            } else {
                type = state.currentMode;
            }

            let s = { 
                type: type, 
                rotation: (Math.random() - 0.5) * 0.1, // å›è»¢è§’ã‚’æœ€å°é™ã«ï¼ˆã¯ã¿å‡ºã—é˜²æ­¢ï¼‰
                hasDummy: Math.random() > 0.4 
            };
            const getVal = () => Math.floor(Math.random() * 8) + 4;

            if (type === 'parallelogram') { 
                s.base = getVal(); s.height = getVal(); s.side = s.height + 2; 
                s.ans = s.base * s.height;
            } else if (type === 'triangle') { 
                s.base = getVal(); s.height = getVal(); s.side = s.height + 3;
                s.ans = (s.base * s.height) / 2; s.isOuterHeight = Math.random() > 0.4;
            } else if (type === 'trapezoid') { 
                s.top = getVal(); s.bottom = s.top + 3; s.height = getVal(); s.side = s.height + 1;
                s.ans = ((s.top + s.bottom) * s.height) / 2;
            } else if (type === 'rhombus') { 
                s.d1 = getVal(); s.d2 = Math.floor(getVal()/2)*2; s.edge = Math.floor(getVal() + 5);
                s.ans = (s.d1 * s.d2) / 2;
            }
            
            state.currentShape = s;
            
            // ã‚®ãƒ£ãƒ«ã‚½ãƒ³ã®ã‚»ãƒªãƒ•ç”Ÿæˆ
            let flavorText = `æœ¬æ—¥ã®ã‚¢ãƒ©ã‚«ãƒ«ãƒˆã€Œ${SHAPES_JA[type]}ã€ã§ã”ã–ã„ã¾ã™ã€‚`;
            if (s.type === 'triangle' && s.isOuterHeight) {
                flavorText = `æœ¬æ—¥ã®ãŠå‹§ã‚ã¯ã€é«˜ã•ãŒå¤–å´ã«é£›ã³å‡ºã—ãŸã€Œé‹­ã„ã€ä¸‰è§’å½¢ã§ã”ã–ã„ã¾ã™ã€‚é«˜ã•ã‚’å–ã‚Šé•ãˆã¬ã‚ˆã†ã€ã”æ³¨æ„ãã ã•ã„ã€‚`;
            } else if (s.hasDummy) {
                flavorText = `æœ¬æ—¥ã®${SHAPES_JA[type]}ã«ã¯ã€å°‘ã€…ã€Œé›‘å‘³ï¼ˆä¸è¦ãªæ•°å€¤ï¼‰ã€ãŒæ··ã–ã£ã¦ãŠã‚Šã¾ã™ã€‚ç´”ç²‹ãªé¢ç©ã®ã¿ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚`;
            } else if (s.type === 'rhombus') {
                flavorText = `ç¾ã—ã„ã€Œã²ã—å½¢ã€ãŒå…¥è·ã„ãŸã—ã¾ã—ãŸã€‚å¯¾è§’ç·šã®äº¤ã‚ã‚Šã«ã€çœŸå®ŸãŒéš ã•ã‚Œã¦ãŠã‚Šã¾ã™ã€‚`;
            } else if (s.type === 'trapezoid') {
                flavorText = `äºŒã¤ã®å¹³è¡Œãªè¾ºã‚’æŒã¤ã€Œå°å½¢ã€ã‚’ã”ç”¨æ„ã—ã¾ã—ãŸã€‚ä¸Šã¨ä¸‹ã®èª¿å’Œã‚’ã€å¼ã«è¾¼ã‚ã¦ãã ã•ã„ã€‚`;
            }
            
            document.getElementById('garcon-text').innerText = flavorText;
            drawShape();
        }

        function drawShape() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            const s = state.currentShape;
            
            // å›³å½¢ãŒçµ¶å¯¾ã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«ã€ã‚ˆã‚Šä¿å®ˆçš„ãªã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’é©ç”¨
            // ä½™ç™½ã‚’ååˆ†ã«ç¢ºä¿ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã®ç´„25%ã€œ30%ã‚’æœ€å¤§ã‚µã‚¤ã‚ºã«åˆ¶é™ï¼‰
            const cx = canvas.width / 2;
            const cy = canvas.height * 0.45; // ç¸¦ä½ç½®ã‚’å°‘ã—ä¸‹ã’ã¦ä¸Šéƒ¨ã®ãƒ©ãƒ™ãƒ«ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿
            const minDim = Math.min(canvas.width, canvas.height);
            const sc = minDim / 22; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ã•ã‚‰ã«å°ã•ãèª¿æ•´
            
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(s.rotation);
            ctx.fillStyle = 'rgba(141, 110, 99, 0.4)'; 
            ctx.strokeStyle = '#ffffff'; 
            ctx.lineWidth = 4; ctx.lineJoin = "round";

            let pts = [];
            if (s.type === 'parallelogram') {
                const w = s.base * sc, h = s.height * sc, off = sc * 2;
                pts = [{x:-w/2-off/2, y:h/2, l:'A'}, {x:w/2-off/2, y:h/2, l:'B'}, {x:w/2+off/2, y:-h/2, l:'C'}, {x:-w/2+off/2, y:-h/2, l:'D'}];
                drawPoly(pts);
                drawDim(pts[0], pts[1], 40, s.base + "cm");
                if(s.hasDummy) drawDim(pts[1], pts[2], 40, s.side + "cm");
                ctx.setLineDash([6,6]); ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.beginPath(); ctx.moveTo(pts[3].x, pts[3].y); ctx.lineTo(pts[3].x, pts[0].y); ctx.stroke(); ctx.setLineDash([]);
                drawRightAngle(pts[3].x, pts[0].y, 0, 15); drawDim({x:pts[3].x, y:pts[0].y}, pts[3], 35, s.height + "cm");
            } else if (s.type === 'triangle') {
                const w = s.base * sc, h = s.height * sc;
                const peakX = s.isOuterHeight ? -w/2 - sc*4 : -w/2 + sc*3;
                pts = [{x:-w/2, y:h/2, l:'A'}, {x:w/2, y:h/2, l:'B'}, {x:peakX, y:-h/2, l:'C'}];
                drawPoly(pts);
                drawDim(pts[0], pts[1], 50, s.base + "cm");
                if(s.hasDummy) drawDim(pts[1], pts[2], 40, s.side + "cm");
                ctx.setLineDash([6,6]); ctx.strokeStyle = "rgba(255,255,255,0.6)";
                const dPt = {x:pts[2].x, y:pts[0].y, l:'D'};
                if(s.isOuterHeight) {
                    ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y); ctx.lineTo(dPt.x, dPt.y); ctx.lineTo(pts[2].x, pts[2].y); ctx.stroke();
                    drawRightAngle(dPt.x, dPt.y, 0, 15); drawDim(dPt, pts[2], -35, s.height + "cm");
                } else {
                    const hPt = {x:pts[2].x, y:pts[0].y};
                    ctx.beginPath(); ctx.moveTo(pts[2].x, pts[2].y); ctx.lineTo(hPt.x, hPt.y); ctx.stroke();
                    drawRightAngle(hPt.x, hPt.y, 0, 15); drawDim(hPt, pts[2], 35, s.height + "cm");
                }
            } else if (s.type === 'trapezoid') {
                const tw = s.top * sc, bw = s.bottom * sc, h = s.height * sc;
                pts = [{x:-bw/2, y:h/2, l:'A'}, {x:bw/2, y:h/2, l:'B'}, {x:tw/2, y:-h/2, l:'C'}, {x:-tw/2, y:-h/2, l:'D'}];
                drawPoly(pts);
                drawDim(pts[3], pts[2], -40, s.top + "cm"); drawDim(pts[0], pts[1], 40, s.bottom + "cm");
                if(s.hasDummy) drawDim(pts[1], pts[2], 40, s.side + "cm");
                ctx.setLineDash([6,6]); ctx.strokeStyle = "rgba(255,255,255,0.6)"; 
                const ePt = {x:pts[2].x, y:pts[1].y, l:'E'};
                ctx.beginPath(); ctx.moveTo(pts[2].x, pts[2].y); ctx.lineTo(ePt.x, ePt.y); ctx.stroke();
                drawRightAngle(ePt.x, ePt.y, 0, 15, -1); drawDim(ePt, pts[2], 35, s.height + "cm");
            } else if (s.type === 'rhombus') {
                const d1 = s.d1 * sc, d2 = s.d2 * sc;
                pts = [{x:0, y:-d2/2, l:'A'}, {x:d1/2, y:0, l:'B'}, {x:0, y:d2/2, l:'C'}, {x:-d1/2, y:0, l:'D'}];
                drawPoly(pts);
                ctx.setLineDash([5,5]); ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = 1.5;
                ctx.beginPath(); ctx.moveTo(pts[3].x, pts[3].y); ctx.lineTo(pts[1].x, pts[1].y); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y); ctx.lineTo(pts[2].x, pts[2].y); ctx.stroke();
                drawRightAngle(0,0,0, 15);
                drawDim(pts[3], pts[1], 35, s.d1 + "cm"); drawDim(pts[0], pts[2], 35, s.d2 + "cm");
                if(s.hasDummy) drawDim(pts[1], pts[2], 40, s.edge + "cm");
            }
            pts.forEach(p => drawLabel(p, s));
            ctx.restore();
        }

        function drawPoly(pts) {
            ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
            pts.slice(1).forEach(p => ctx.lineTo(p.x, p.y));
            ctx.closePath(); ctx.fill(); ctx.stroke();
        }

        function drawLabel(p, s) {
            ctx.font = "bold 18px sans-serif"; ctx.fillStyle = "#fff"; ctx.textAlign = "center";
            const offset = 1.4; 
            ctx.fillText(p.l, p.x * offset, p.y * offset + (p.y > 0 ? 10 : -10));
        }

        function drawDim(p1, p2, off, txt) {
            const angle = Math.atan2(p2.y-p1.y, p2.x-p1.x), d = Math.sqrt((p2.x-p1.x)**2 + (p2.y-p1.y)**2);
            ctx.save(); ctx.translate(p1.x, p1.y); ctx.rotate(angle); ctx.strokeStyle = "rgba(255,255,255,0.7)"; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(0,8); ctx.lineTo(0, off+8); ctx.moveTo(d,8); ctx.lineTo(d, off+8); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, off); ctx.lineTo(d, off); ctx.stroke();
            ctx.rotate(-angle);
            const mx = (d/2)*Math.cos(angle) + (off+22)*Math.cos(angle+Math.PI/2), my = (d/2)*Math.sin(angle) + (off+22)*Math.sin(angle+Math.PI/2);
            ctx.font = "bold 16px sans-serif"; ctx.textAlign="center"; ctx.fillStyle="#ffd700"; ctx.fillText(txt, mx, my); ctx.restore();
        }

        function drawRightAngle(px, py, ang, sz=12, flip=1) {
            ctx.save(); ctx.translate(px, py); ctx.rotate(ang); ctx.setLineDash([]); ctx.strokeStyle = "#ffffff"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(sz*flip, 0); ctx.lineTo(sz*flip, -sz); ctx.lineTo(0, -sz); ctx.stroke(); ctx.restore();
        }

        function showHint(level) {
            const box = document.getElementById('hint-display'); const s = state.currentShape; box.style.display = 'block';
            if(level === 1) {
                let msg = "ã€é‘‘å®šã®ãƒ’ãƒ³ãƒˆã€‘<br>";
                if(s.type === 'parallelogram') msg += "åº•è¾ºã¨ã€ãã‚Œã«å¯¾ã—ã¦å‚ç›´ãªé«˜ã•ã‚’è¦‹æ¥µã‚ã¦ãã ã•ã„ã€‚";
                if(s.type === 'triangle') msg += "åº•è¾ºã®å»¶é•·ã«é«˜ã•ãŒç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®é•·ã•ã‚’ä½¿ã„ã¾ã™ã€‚";
                if(s.type === 'trapezoid') msg += "å¹³è¡ŒãªäºŒè¾ºã‚’è¶³ã—ã€é«˜ã•ã‚’ã‹ã‘ã¦åŠåˆ†ã«ã—ã¾ã™ã€‚";
                if(s.type === 'rhombus') msg += "äºŒæœ¬ã®å¯¾è§’ç·šã‚’æ›ã‘åˆã‚ã›ãŸã‚ã¨ã€åŠåˆ†ã«ã™ã‚‹ã®ãŒæ­£ã—ã„ä½œæ³•ã§ã™ã€‚";
                box.innerHTML = msg;
            } else {
                let msg = "ã€ç§˜ä¼ã®å…¬å¼ã€‘<br>";
                if(s.type === 'parallelogram') msg += `åº•è¾º Ã— é«˜ã•`;
                if(s.type === 'triangle') msg += `åº•è¾º Ã— é«˜ã• Ã· 2`;
                if(s.type === 'trapezoid') msg += `(ä¸Šåº• + ä¸‹åº•) Ã— é«˜ã• Ã· 2`;
                if(s.type === 'rhombus') msg += `å¯¾è§’ç·š Ã— å¯¾è§’ç·š Ã· 2`;
                box.innerHTML = msg;
            }
        }

        function handleCheck() { if(state.phase === 1) checkFormula(); else checkFinalAnswer(); }

        function checkFormula() {
            if(!state.currentInput.length) return;
            const formulaStr = state.currentInput.join('');
            const evalStr = formulaStr.replace(/Ã—/g,'*').replace(/Ã·/g,'/').replace(/ï¼ˆ/g,'(').replace(/ï¼‰/g,')');
            try {
                if(Math.abs(eval(evalStr) - state.currentShape.ans) < 0.001) {
                    state.confirmedFormulaString = formulaStr; 
                    document.getElementById('confirmed-formula').innerText = state.confirmedFormulaString;
                    
                    playSound('correct'); notify("æ­£ã—ã„å¼ã§ã”ã–ã„ã¾ã™âœ¨", "#4caf50");
                    state.phase = 2; state.currentInput = []; updateDisplay();
                    document.getElementById('phase1-ui').style.display = 'none'; document.getElementById('phase2-ui').style.display = 'block';
                    document.getElementById('check-btn').innerText = "é¢ç©ã‚’ç‰¹å®šã™ã‚‹"; document.getElementById('back-btn').style.display = 'block';
                    document.getElementById('garcon-text').innerText = "ç´ æ™´ã‚‰ã—ã„å¼ã§ã™ã€‚ã§ã¯ã€æ­£ç¢ºãªæ•°å€¤ã¸ã¨ã€Œç²¾è£½ï¼ˆè¨ˆç®—ï¼‰ã€ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ";
                } else { playSound('wrong'); state.combo = 0; updateCombo(); notify("å¼ãŒç•°ãªã‚Šã¾ã™ğŸ¤”", "#f44336"); }
            } catch(e) { playSound('wrong'); notify("å¼ãŒæˆç«‹ã—ã¦ãŠã‚Šã¾ã›ã‚“ğŸ’¦", "#f44336"); }
        }

        function checkFinalAnswer() {
            if(!state.currentInput.length) return;
            if(Math.abs(parseFloat(state.currentInput.join('')) - state.currentShape.ans) < 0.01) {
                playSound('correct'); state.combo++; updateCombo();
                state.score += Math.ceil(state.currentShape.ans); document.getElementById('score').innerText = state.score;
                checkBadges(); notify(`é¢ç©ç‰¹å®šã€ãŠè¦‹äº‹ã§ã™ï¼âœ¨`, "#ffc107");
                setTimeout(() => { clearMemo(); newQuestion(); }, 1500);
            } else { playSound('wrong'); state.combo = 0; updateCombo(); notify("æ•°å€¤ãŒç•°ãªã‚‹ã‚ˆã†ã§ã™...", "#f44336"); }
        }

        function updateCombo() {
            const cont = document.getElementById('combo-container');
            if(state.combo > 1) { cont.style.display = 'block'; document.getElementById('combo').innerText = state.combo; }
            else cont.style.display = 'none';
        }

        function checkBadges() {
            const targets = [200, 500, 1000], icons = ['ğŸ«', 'ğŸª', 'ğŸ†'];
            targets.forEach((t, i) => {
                if(state.score >= t && !state.badgesEarned.includes(i)) {
                    state.badgesEarned.push(i);
                    const b = document.createElement('div'); b.className = 'badge'; b.innerText = icons[i];
                    document.getElementById('badge-container').appendChild(b);
                }
            });
        }

        function notify(msg, color) {
            const m = document.getElementById('message'); m.innerText = msg; m.style.background = color;
            m.style.display = 'block'; setTimeout(() => m.style.display = 'none', 1500);
        }

        function goBackToStep1() {
            state.phase = 1; state.currentInput = []; updateDisplay();
            document.getElementById('phase1-ui').style.display = 'block'; document.getElementById('phase2-ui').style.display = 'none';
            document.getElementById('check-btn').innerText = "ã“ã®å¼ã§æ³¨æ–‡ã™ã‚‹"; document.getElementById('back-btn').style.display = 'none';
        }

        init();
    </script>
</body>
</html>