<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éë„Éº„Çª„É≥„Éà„Éû„Çπ„Çø„ÉºÔºÅ„ÅäË≤∑„ÅÑÁâ©„ÇØ„Ç®„Çπ„Éà</title>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@500&family=M+PLUS+Rounded+1c:wght@800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF9AA2;
            --secondary: #B5EAD7;
            --accent: #FFDAC1;
            --text: #6B5B95;
            --white: #FFFFF0;
            --badge-bg: rgba(255, 255, 255, 0.6);
            --font-main: 'M PLUS Rounded 1c', sans-serif;
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body {
            font-family: var(--font-main);
            background-color: #E2F0CB;
            background-image: radial-gradient(rgba(255,255,255,0.4) 15%, transparent 16%),
                              radial-gradient(rgba(255,255,255,0.4) 15%, transparent 16%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            color: var(--text);
            overflow: hidden;
            font-size: 16px;
            transition: background-color 1s ease;
        }

        .main-wrapper {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 10px;
            width: 98%;
            max-width: 600px;
            height: 96vh; 
            max-height: 700px;
        }

        /* Â∑¶ÂÅ¥„ÅÆ„Éê„ÉÉ„Ç∏„Ç®„É™„Ç¢ */
        .badge-sidebar {
            width: 55px;
            background: var(--badge-bg);
            border: 4px solid var(--white);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .badge-title {
            writing-mode: vertical-rl;
            font-family: 'Kiwi Maru', serif;
            font-size: 0.75rem;
            color: var(--primary);
            margin-bottom: 5px;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .badge-slot {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            margin-bottom: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        @keyframes pop-in {
            0% { transform: scale(0) rotate(-180deg); }
            60% { transform: scale(1.4) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .badge-new {
            animation: pop-in 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #FFF9C4;
            border: 2px solid #FFD54F;
        }

        /* „Éê„ÉÉ„Ç∏Áç≤Âæó„É™„Éú„É≥ */
        .badge-ribbon {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 1000;
            background: linear-gradient(135deg, #FFD54F 0%, #FFC107 50%, #FFD54F 100%);
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 0 4px rgba(255,255,255,0.5);
            text-align: center;
            font-family: 'Kiwi Maru', serif;
            animation: ribbonShow 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .badge-ribbon::before,
        .badge-ribbon::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .badge-ribbon::before {
            top: -15px;
            left: 20px;
            border-width: 15px 20px 0 20px;
            border-color: #FFC107 transparent transparent transparent;
        }

        .badge-ribbon::after {
            top: -15px;
            right: 20px;
            border-width: 15px 20px 0 20px;
            border-color: #FFC107 transparent transparent transparent;
        }

        .badge-ribbon-title {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .badge-ribbon-name {
            font-size: 1.3rem;
            color: #E65100;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            margin: 5px 0;
        }

        .badge-ribbon-icon {
            font-size: 2rem;
            margin: 5px 0;
        }

        @keyframes ribbonShow {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            60% {
                transform: translate(-50%, -50%) scale(1.2) rotate(10deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes ribbonHide {
            0% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8) rotate(180deg);
                opacity: 0;
            }
        }

        .badge-ribbon.hiding {
            animation: ribbonHide 0.4s ease-in forwards;
        }

        .game-container {
            background: var(--white);
            flex: 1;
            border-radius: 20px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            padding: 5px 12px;
            text-align: center;
            position: relative;
            border: 4px solid var(--white);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: hidden;
        }

        .home-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fff;
            border: 2px solid var(--text);
            color: var(--text);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 3px;
        }
        .home-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .index-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--secondary);
            border: 2px solid var(--text);
            color: var(--text);
            border-radius: 12px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-family: var(--font-main);
            cursor: pointer;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }
        .index-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .index-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--secondary);
            border: 2px solid var(--text);
            color: var(--text);
            border-radius: 12px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-family: var(--font-main);
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
            z-index: 50;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .index-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .calc-btn {
            position: absolute;
            top: 10px;
            left: 90px;
            background: var(--secondary);
            border: 2px solid var(--text);
            color: var(--text);
            border-radius: 12px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-family: var(--font-main);
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
            z-index: 50;
            display: none;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .calc-btn.show {
            display: flex;
        }
        .calc-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* Ë®àÁÆó„Éë„Éç„É´ */
        .calc-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 340px;
            height: 100vh;
            background: var(--white);
            border-left: 4px solid var(--primary);
            box-shadow: -4px 0 10px rgba(0,0,0,0.2);
            z-index: 200;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .calc-panel.closed {
            right: -350px;
        }

        .calc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
        }

        .calc-title {
            font-family: 'Kiwi Maru', serif;
            font-size: 1rem;
            color: var(--primary);
            font-weight: bold;
            line-height: 1.3;
        }

        .calc-description {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            padding: 8px;
            background: var(--accent);
            border-radius: 8px;
            text-align: center;
        }

        .calc-close-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 2px 0 #E07A86;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .calc-close-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .calc-canvas-container {
            flex: 1;
            min-height: 400px;
            background: #fff;
            border: 3px solid var(--accent);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        #calc-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
            cursor: crosshair;
            background: #fafafa;
            border-radius: 10px;
        }

        .calc-controls {
            display: flex;
            gap: 8px;
        }

        .calc-control-btn {
            flex: 1;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 12px;
            font-family: var(--font-main);
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 3px 0 #E07A86;
        }
        .calc-control-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }
        .calc-control-btn.clear {
            background: #FF6B6B;
            box-shadow: 0 3px 0 #E55555;
        }

        .badge-sidebar {
            width: 55px;
            background: var(--badge-bg);
            border: 4px solid var(--white);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .badge-title {
            writing-mode: vertical-rl;
            font-family: 'Kiwi Maru', serif;
            font-size: 0.75rem;
            color: var(--primary);
            margin-bottom: 5px;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .badge-slot {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            margin-bottom: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        @keyframes pop-in {
            0% { transform: scale(0) rotate(-180deg); }
            60% { transform: scale(1.4) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .badge-new {
            animation: pop-in 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #FFF9C4;
            border: 2px solid #FFD54F;
        }

        h1 {
            font-family: 'Kiwi Maru', serif;
            color: var(--primary);
            margin: 0;
            text-shadow: 2px 2px 0 #FFF;
            font-size: 1rem;
            flex-shrink: 0;
            line-height: 1.2;
            padding-right: 30px;
            margin-bottom: 2px;
        }

        .screen {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            height: 100%;
            width: 100%;
            padding-top: 2px;
            gap: 3px;
        }
        .hidden { display: none !important; }

        .level-display {
            background: var(--primary);
            color: white;
            padding: 1px 10px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-block;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
            margin: 2px 0;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            background: var(--accent);
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.75rem;
            color: #555;
            margin: 2px 0;
            flex-shrink: 0;
        }

        /* ÈÄ£Á∂öÊ≠£Ëß£„Ç≥„É≥„ÉúË°®Á§∫ */
        .combo-display {
            text-align: center;
            margin: 2px 0;
            min-height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .combo-text {
            font-size: 0.75rem;
            color: #888;
            transition: all 0.3s;
        }

        .combo-text.active {
            font-size: 1rem;
            font-weight: bold;
            color: #FF6B6B;
            animation: comboPulse 0.5s ease;
        }

        .combo-count {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 0 #FF8C00;
            margin: 0 3px;
            display: inline-block;
            transform: scale(0);
            transition: transform 0.3s;
        }

        .combo-count.show {
            transform: scale(1);
            animation: comboBounce 0.5s ease;
        }

        .combo-bonus {
            font-size: 0.75rem;
            color: #4CAF50;
            font-weight: bold;
            margin-left: 3px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .combo-bonus.show {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes comboPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes comboBounce {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .mascot-area {
            flex-grow: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            min-height: 30px;
            max-height: 50px;
            margin: 2px 0;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .speech-bubble {
            position: relative;
            background: var(--secondary);
            border-radius: 12px;
            padding: 5px 8px;
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: #333;
            flex-shrink: 0;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            top: -5px; left: 50%; transform: translateX(-50%);
            border-width: 0 5px 5px; border-style: solid; border-color: transparent transparent var(--secondary);
        }

        .question-area {
            background: #fff;
            border-radius: 10px;
            padding: 5px 8px;
            margin: 2px 0;
            border: 2px dashed var(--primary);
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .product-display {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }

        .price-display {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text);
            margin: 2px 0;
        }

        .discount-display {
            font-size: 1rem;
            color: #FF6B6B;
            font-weight: bold;
            margin: 5px 0;
        }

        .visual-percent {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            margin: 4px 0;
            padding: 5px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .percent-label {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--text);
        }

        .percent-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px;
            max-width: 220px;
            padding: 5px;
            background: #fff;
            border: 2px solid var(--accent);
            border-radius: 8px;
        }

        .percent-box {
            aspect-ratio: 1;
            background: #e0e0e0;
            border-radius: 3px;
            transition: background 0.3s;
            border: 1px solid #ccc;
        }

        .percent-box.filled {
            background: var(--primary);
            border-color: #E07A86;
            box-shadow: 0 2px 4px rgba(255, 154, 162, 0.3);
        }

        .percent-explanation {
            font-size: 0.75rem;
            color: #666;
            text-align: center;
            padding: 3px 8px;
            background: var(--accent);
            border-radius: 6px;
        }

        /* Êï∞Áõ¥Á∑öÂõ≥ */
        .number-line-container {
            width: 100%;
            max-width: 220px;
            margin: 4px 0;
            padding: 5px;
            background: #fff;
            border: 2px solid var(--accent);
            border-radius: 8px;
        }

        .number-line {
            position: relative;
            width: 100%;
            height: 40px;
            margin: 8px 0;
        }

        .number-line-bar {
            position: absolute;
            top: 16px;
            left: 0;
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .number-line-filled {
            position: absolute;
            top: 16px;
            left: 0;
            height: 10px;
            background: var(--primary);
            border-radius: 5px 0 0 5px;
            transition: width 0.5s ease;
            box-shadow: 0 2px 4px rgba(255, 154, 162, 0.4);
        }

        .number-line-marker {
            position: absolute;
            top: 0;
            width: 2px;
            height: 24px;
            background: #999;
        }

        .number-line-marker.major {
            height: 32px;
            background: #666;
            font-weight: bold;
        }

        .number-line-label {
            position: absolute;
            top: -14px;
            font-size: 0.65rem;
            color: #666;
            transform: translateX(-50%);
            font-weight: bold;
        }

        .number-line-current {
            position: absolute;
            top: 28px;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--primary);
            background: #fff;
            padding: 1px 4px;
            border-radius: 3px;
            border: 2px solid var(--primary);
            white-space: nowrap;
        }

        .number-line-arrow {
            position: absolute;
            top: 26px;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid var(--primary);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 0;
            margin-top: 3px;
            flex-shrink: 0;
        }

        .option-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0;
            font-size: 1rem;
            border-radius: 10px;
            font-family: var(--font-main);
            cursor: pointer;
            box-shadow: 0 3px 0 #E07A86;
            transition: transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 42px;
        }
        .option-btn:active { transform: translateY(3px); box-shadow: none; }
        .option-btn.cant-do { background: #C7CEEA; box-shadow: 0 3px 0 #9AA3C6; font-size: 0.9rem; }

        .feedback {
            position: absolute;
            top: 45%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 5rem;
            font-weight: bold;
            text-shadow: 2px 2px 0 #FFF;
            pointer-events: none;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
        }
        .feedback.show { transform: translate(-50%, -50%) scale(1); }
        .correct { color: #FF6B6B; }
        .wrong { color: #6B5B95; font-size: 4rem; }

        /* ÈñìÈÅï„ÅÑË™¨Êòé„ÅÆË°®Á§∫ */
        .mistake-explanation {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translate(-50%, 0) scale(0);
            background: linear-gradient(135deg, #FFF9C4 0%, #FFE082 100%);
            border: 3px solid #FFD54F;
            border-radius: 20px;
            padding: 20px 25px;
            max-width: 85%;
            max-width: min(85%, 400px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 0 4px rgba(255,255,255,0.5);
            z-index: 200;
            font-family: 'Kiwi Maru', serif;
            text-align: center;
            white-space: pre-line;
            line-height: 1.6;
            animation: explanationShow 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .mistake-explanation.show {
            animation: explanationShow 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .mistake-explanation.hiding {
            animation: explanationHide 0.3s ease-in forwards;
        }

        .mistake-explanation-title {
            font-size: 1.1rem;
            color: #E65100;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .mistake-explanation-text {
            font-size: 0.95rem;
            color: #333;
            margin: 0;
        }

        .mistake-explanation-text strong {
            color: #E65100;
            font-weight: bold;
            font-size: 1.05rem;
            display: block;
            margin-top: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.6);
            border-radius: 8px;
            border-left: 3px solid #FFD54F;
        }

        .formula-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 8px;
            padding: 12px;
            background: rgba(255,255,255,0.6);
            border-radius: 8px;
            border-left: 3px solid #FFD54F;
        }

        .formula-title {
            color: #E65100;
            font-weight: bold;
            font-size: 1.05rem;
            margin-bottom: 8px;
        }

        .formula-line {
            display: flex;
            align-items: center;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            color: #E65100;
            line-height: 1.8;
            white-space: nowrap;
            width: 100%;
        }

        .formula-left {
            display: inline-block;
        }

        .formula-right {
            display: inline-block;
        }

        .formula-line .equals {
            margin: 0 8px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .formula-line[data-formula-continuation] {
            display: flex;
            align-items: center;
        }

        .formula-line[data-formula-continuation] .equals {
            margin-left: 0;
            margin-right: 8px;
        }

        @keyframes explanationShow {
            0% {
                transform: translate(-50%, -20px) scale(0) rotate(-5deg);
                opacity: 0;
            }
            60% {
                transform: translate(-50%, 0) scale(1.05) rotate(2deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, 0) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes explanationHide {
            0% {
                transform: translate(-50%, 0) scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -20px) scale(0.9) rotate(-5deg);
                opacity: 0;
            }
        }

        .explanation-next-btn {
            margin-top: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 10px 25px;
            font-size: 1rem;
            font-family: var(--font-main);
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #E07A86;
            transition: all 0.2s;
        }

        .explanation-next-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .explanation-next-btn:hover {
            background: #FF8A95;
        }

        .start-btn, .retry-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 0;
            font-size: 1.2rem;
            border-radius: 25px;
            font-family: var(--font-main);
            font-weight: bold;
            box-shadow: 0 4px 0 #E07A86;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
        }
        .start-btn:active, .retry-btn:active { transform: translateY(4px); box-shadow: none; }

        .mode-select {
            background: #f0f0f0;
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 10px;
            text-align: left;
            font-size: 0.85rem;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            vertical-align: middle;
            margin-left: 8px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--secondary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .clear-title {
            font-size: 1.8rem;
            color: #FFD700;
            text-shadow: 2px 2px 0 #E65100;
            font-family: 'Kiwi Maru';
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.1);} }

        @media (max-height: 750px) {
            .game-container { padding: 3px 8px; }
            h1 { font-size: 0.9rem; margin-bottom: 1px; }
            .mascot-area { font-size: 1.8rem; height: auto; min-height: 25px; max-height: 40px; margin: 1px 0; }
            .speech-bubble { padding: 4px 6px; margin-bottom: 2px; font-size: 0.8rem; }
            .question-area { min-height: 50px; padding: 4px 6px; margin: 1px 0; }
            .product-display { font-size: 1.3rem; margin-bottom: 1px; }
            .price-display { font-size: 1rem; margin: 1px 0; }
            .option-btn { height: 38px; font-size: 0.95rem; }
            .header-info { padding: 2px 6px; font-size: 0.7rem; margin: 1px 0;}
            .level-display { font-size: 0.8rem; padding: 1px 8px; margin: 1px 0; }
            .calc-canvas-container { min-height: 300px; }
            .percent-grid { max-width: 180px; gap: 2px; }
            .percent-label { font-size: 0.8rem; }
            .percent-explanation { font-size: 0.7rem; padding: 2px 6px; }
            .visual-percent { gap: 3px; margin: 3px 0; padding: 4px; }
            .number-line-container { max-width: 200px; padding: 4px; margin: 3px 0; }
            .number-line { height: 35px; margin: 6px 0; }
            .number-line-label { font-size: 0.6rem; top: -12px; }
            .number-line-current { font-size: 0.75rem; padding: 1px 3px; top: 24px; }
            .number-line-arrow { top: 22px; border-left-width: 4px; border-right-width: 4px; border-top-width: 5px; }
            .number-line-bar { top: 14px; height: 8px; }
            .number-line-filled { top: 14px; height: 8px; }
            .combo-text { font-size: 0.7rem; }
            .combo-text.active { font-size: 0.9rem; }
            .combo-count { font-size: 1.1rem; }
            .combo-bonus { font-size: 0.7rem; }
            .combo-display { margin: 1px 0; min-height: 18px; }
            .badge-sidebar { width: 45px; padding: 8px 4px; }
            .badge-title { font-size: 0.65rem; }
            .badge-slot { width: 30px; height: 30px; font-size: 1rem; margin-bottom: 4px; }
            .badge-ribbon { padding: 15px 30px; }
            .badge-ribbon-title { font-size: 0.8rem; }
            .badge-ribbon-name { font-size: 1.1rem; }
            .badge-ribbon-icon { font-size: 1.6rem; }
            .mistake-explanation { 
                padding: 15px 20px; 
                max-width: 90%; 
                top: 12%;
            }
            .mistake-explanation-title { font-size: 1rem; margin-bottom: 8px; }
            .mistake-explanation-text { font-size: 0.85rem; }
            .formula-container { padding: 10px; }
            .formula-title { font-size: 0.95rem; margin-bottom: 6px; }
            .formula-line { font-size: 0.9rem; }
            .explanation-next-btn { 
                padding: 8px 20px; 
                font-size: 0.9rem; 
                margin-top: 12px; 
            }
        }

        @media (max-width: 480px) {
            .calc-panel {
                width: 90vw;
            }
            .calc-panel.closed {
                right: -90vw;
            }
            .badge-sidebar {
                width: 40px;
                padding: 6px 3px;
            }
            .badge-title {
                font-size: 0.6rem;
            }
            .badge-slot {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
                margin-bottom: 3px;
            }
            .badge-ribbon {
                padding: 12px 25px;
                max-width: 90vw;
            }
            .badge-ribbon-title {
                font-size: 0.75rem;
            }
            .badge-ribbon-name {
                font-size: 1rem;
            }
            .badge-ribbon-icon {
                font-size: 1.4rem;
            }
            .mistake-explanation {
                padding: 12px 18px;
                max-width: 95%;
                top: 10%;
            }
            .mistake-explanation-title {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }
            .mistake-explanation-text {
                font-size: 0.8rem;
            }
            .formula-container { padding: 8px; }
            .formula-title { font-size: 0.9rem; margin-bottom: 5px; }
            .formula-line { font-size: 0.85rem; }
            .explanation-next-btn {
                padding: 8px 18px;
                font-size: 0.85rem;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <!-- Â∑¶ÂÅ¥„ÅÆ„Éê„ÉÉ„Ç∏„Ç®„É™„Ç¢ -->
        <div class="badge-sidebar" id="badge-container">
            <div class="badge-title">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</div>
        </div>
        
        <!-- „É°„Ç§„É≥„Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
        <div class="game-container">
            <button class="home-btn" onclick="confirmReset()" title="„Çø„Ç§„Éà„É´„Å´Êàª„Çã">üè†</button>

            <h1>üõçÔ∏è „Éë„Éº„Çª„É≥„Éà„Éû„Çπ„Çø„ÉºÔºÅ„ÅäË≤∑„ÅÑÁâ©„ÇØ„Ç®„Çπ„Éà</h1>

            <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
            <div id="title-screen" class="screen">
                <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
                    <div style="font-size:3.5rem; margin-bottom:5px;">üê±</div>
                    <div class="speech-bubble">
                        „ÅäË≤∑„ÅÑÁâ©„Åó„Å™„Åå„Çâ<br>
                        Ââ≤Âêà„Å®„Éë„Éº„Çª„É≥„Éà„Çí<br>
                        „Éû„Çπ„Çø„Éº„Åó„Çà„ÅÜÔºÅ<br>
                        „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Åß<br>
                        „ÅäÂ∫ó„Åå„Åã„Çè„Çã„Çà‚ú®
                    </div>
                    
                    <div class="mode-select">
                        <label style="display:flex; align-items:center; justify-content:space-between;">
                            <span>‚è±Ô∏è „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ(60Áßí)</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </label>
                        <label style="display:flex; align-items:center; justify-content:space-between; margin-top:8px;">
                            <span>üí° Ëß£Ë™¨„É¢„Éº„ÉâÔºàÈñìÈÅï„ÅÑ„ÅÆË™¨Êòé„ÇíË°®Á§∫Ôºâ</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="explanation-toggle" checked>
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                </div>
                <button class="start-btn" onclick="startGame()">„Çπ„Çø„Éº„ÉàÔºÅ</button>
            </div>

            <!-- „Ç≤„Éº„É†„Éó„É¨„Ç§ÁîªÈù¢ -->
            <div id="game-screen" class="screen hidden">
                <a href="index.html" class="index-btn" title="„Éõ„Éº„É†„Å´Êàª„Çã">üè† „Éõ„Éº„É†</a>
                <button class="calc-btn" id="calc-open-btn" onclick="toggleCalcPanel()" title="Á≠ÜÁÆó„Ç≥„Éº„Éä„Éº„ÇíÈñã„Åè">‚úèÔ∏è Á≠ÜÁÆó„Ç≥„Éº„Éä„Éº</button>
                <div style="text-align:center;">
                    <div class="level-display">Lv.<span id="level-num">1</span></div>
                </div>
                <div class="header-info">
                    <span>„Çπ„Ç≥„Ç¢: <span id="score">0</span></span>
                    <span id="timer-display" style="color:var(--primary);">--</span>
                    <span>„ÅÇ„Å®: <span id="to-next-level">5</span></span>
                </div>

                <div class="combo-display">
                    <span class="combo-text" id="combo-text">ÈÄ£Á∂öÊ≠£Ëß£: </span>
                    <span class="combo-count" id="combo-count">0</span>
                    <span class="combo-text">„Ç≥„É≥„Éú</span>
                    <span class="combo-bonus" id="combo-bonus"></span>
                </div>

                <div class="mascot-area" id="mascot">üê±</div>

                <div class="speech-bubble">
                    <span id="hint-text">„Åì„ÅÆÂïÜÂìÅ„ÄÅ„ÅÑ„Åè„Çâ„Å´„Å™„ÇãÔºü</span>
                    <div class="question-area" id="question-area"></div>
                </div>

                <div class="options-grid" id="options"></div>
            </div>

            <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ -->
            <div id="result-screen" class="screen hidden">
                <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
                    <div class="mascot-area" id="result-mascot">üò¢</div>
                    <div class="speech-bubble">
                        <div style="font-size:1.1rem; margin-bottom:5px;">„Åò„Åã„Çì„Åé„ÇåÔºÅ</div>
                        „Çπ„Ç≥„Ç¢: <span style="font-size:1.5rem; color:#FF6B6B; font-weight:bold;" id="final-score">0</span><br>
                        „É¨„Éô„É´: <span style="font-size:1.2rem; color:#6B5B95; font-weight:bold;" id="final-level">1</span>
                    </div>
                </div>
                <button class="retry-btn" onclick="toTitle()">„Çø„Ç§„Éà„É´„Å´„ÇÇ„Å©„Çã</button>
            </div>

            <!-- ÂÖ®„ÇØ„É™ÁîªÈù¢ÔºàLevel 10ÈÅîÊàêÔºâ -->
            <div id="clear-screen" class="screen hidden">
                <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                    <div class="clear-title">ALL CLEAR!!</div>
                    <div style="font-size:4rem; margin:5px 0;">üëë</div>
                    <div class="speech-bubble" style="background:#FFF9C4;">
                        <div style="font-size:1rem; font-weight:bold; color:#E65100;">„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</div>
                        „ÅÇ„Å™„Åü„ÅØ<br>
                        „Éë„Éº„Çª„É≥„Éà„Éû„Çπ„Çø„Éº„Åß„ÅôÔºÅ<br>
                        „Åï„ÅÑ„Åî„ÅÆ„Çπ„Ç≥„Ç¢: <span id="clear-score" style="font-size:1.4rem; color:#FF6B6B;"></span>
                    </div>
                </div>
                <button class="retry-btn" onclick="toTitle()">„Åï„ÅÑ„Åó„Çá„Åã„Çâ„ÅÇ„Åù„Å∂</button>
            </div>

            <div id="feedback-msg" class="feedback">‚≠ïÔ∏è</div>
        </div>

        <!-- Âè≥ÂÅ¥„ÅÆ„Éê„ÉÉ„Ç∏„Ç®„É™„Ç¢ -->
        <div class="badge-sidebar" id="badge-container">
            <div class="badge-title">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</div>
        </div>
    </div>

    <!-- Ë®àÁÆó„Éë„Éç„É´ -->
    <div id="calc-panel" class="calc-panel">
        <div class="calc-header">
            <div>
                <div class="calc-title">‚úèÔ∏è Á≠ÜÁÆó„Ç≥„Éº„Éä„Éº„ÅØ„Åì„Å°„Çâ</div>
                <div class="calc-description">„Åì„Åì„ÅßË®àÁÆó„Åó„Å¶„Å≠ÔºÅ</div>
            </div>
            <button class="calc-close-btn" onclick="toggleCalcPanel()">√ó</button>
        </div>
        <div class="calc-canvas-container">
            <canvas id="calc-canvas"></canvas>
        </div>
        <div class="calc-controls">
            <button class="calc-control-btn clear" onclick="clearCanvas()">üóëÔ∏è Ê∂à„Åô</button>
            <button class="calc-control-btn" onclick="toggleCalcPanel()">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <script>
        // --- Èü≥Â£∞Èñ¢ÈÄ£ ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            else if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        
        function playSound(type) {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') {
                const osc = audioCtx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(783.99, now + 0.1);
                osc.connect(gainNode);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(); osc.stop(now + 0.3);

            } else if (type === 'levelup') {
                const freqs = [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98, 2093.00];
                freqs.forEach((f, i) => {
                    const osc = audioCtx.createOscillator();
                    osc.type = i % 2 === 0 ? 'sine' : 'triangle';
                    osc.frequency.setValueAtTime(f, now + i * 0.08);
                    osc.connect(gainNode);
                    osc.start();
                    osc.stop(now + i * 0.08 + 0.3);
                });
                gainNode.gain.setValueAtTime(0.05, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 1.0);

            } else if (type === 'clear') {
                const freqs = [523.25, 523.25, 523.25, 659.25, 783.99, 659.25, 783.99, 1046.50];
                const times = [0, 0.2, 0.4, 0.6, 0.8, 1.2, 1.4, 1.6];
                freqs.forEach((f, i) => {
                    const osc = audioCtx.createOscillator();
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(f, now + times[i]);
                    osc.connect(gainNode);
                    osc.start();
                    osc.stop(now + times[i] + 0.2);
                });
                gainNode.gain.setValueAtTime(0.05, now);

            } else {
                const osc = audioCtx.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.connect(gainNode);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(); osc.stop(now + 0.2);
            }
        }

        // --- „Ç≤„Éº„É†ÂÆöÊï∞„ÉªÂ§âÊï∞ ---
        const bgColors = [
            "#E2F0CB", "#E2F0CB", 
            "#FFDAC1", "#FFDAC1", 
            "#C7CEEA", "#C7CEEA", 
            "#2C3E50", "#2C3E50", 
            "#FFF59D", "#FFF59D"
        ];
        const textColors = [
            "#6B5B95", "#6B5B95", "#6B5B95", "#6B5B95", "#6B5B95", "#6B5B95", 
            "#FFFFFF", "#FFFFFF", "#6B5B95", "#6B5B95"
        ];
        
        const badges = ['üõçÔ∏è', 'üí∞', 'üéØ', 'üìä', 'üèÜ', '‚≠ê', 'üíé', 'üåü', 'üëë', 'üéä'];
        const badgeNames = [
            '„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞„Éû„Çπ„Çø„Éº',
            '„ÅäÈáë„ÅÆÈÅî‰∫∫',
            'Ë®àÁÆó„ÅÆÂêç‰∫∫',
            '„Éá„Éº„ÇøÂàÜÊûêÂÆ∂',
            '„ÉÅ„É£„É≥„Éî„Ç™„É≥',
            '„Çπ„Çø„ÉºÁç≤ÂæóËÄÖ',
            '„ÉÄ„Ç§„É§„É¢„É≥„ÉâÁ¥ö',
            '„Çπ„Éº„Éë„Éº„Çπ„Çø„Éº',
            '„Ç≠„É≥„Ç∞',
            '„Éë„Éº„Éï„Çß„ÇØ„Éà'
        ];
        const products = ['üçé', 'üçå', 'üçá', 'üçä', 'ü•ï', 'ü•ñ', 'üç∞', 'üç©', 'üç™', 'üç≠'];
        const mascots = ['üê±', 'üê∂', 'üê∞', 'üêº', 'üêª', 'ü¶ä'];

        let currentScore = 0;
        let currentLevel = 1;
        let correctInLevel = 0;
        const requiredForLevelUp = 5;
        let currentQuestion = {};
        let isTimeAttack = false;
        let timeLeft = 60;
        let timerInterval = null;
        let comboCount = 0; // ÈÄ£Á∂öÊ≠£Ëß£Êï∞

        // --- DOMË¶ÅÁ¥† ---
        const titleScreen = document.getElementById('title-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const clearScreen = document.getElementById('clear-screen');
        const modeToggle = document.getElementById('mode-toggle');
        const explanationToggle = document.getElementById('explanation-toggle');
        
        const scoreEl = document.getElementById('score');
        const levelNumEl = document.getElementById('level-num');
        const toNextLevelEl = document.getElementById('to-next-level');
        const timerDisplay = document.getElementById('timer-display');
        const questionArea = document.getElementById('question-area');
        const optionsEl = document.getElementById('options');
        const feedbackEl = document.getElementById('feedback-msg');
        const mascotEl = document.getElementById('mascot');
        const hintText = document.getElementById('hint-text');
        const badgeContainer = document.getElementById('badge-container');
        const calcPanel = document.getElementById('calc-panel');
        const calcCanvas = document.getElementById('calc-canvas');
        const calcOpenBtn = document.getElementById('calc-open-btn');
        const comboCountEl = document.getElementById('combo-count');
        const comboTextEl = document.getElementById('combo-text');
        const comboBonusEl = document.getElementById('combo-bonus');

        // --- „Éò„É´„Éë„ÉºÈñ¢Êï∞ ---
        function updateBackground(level) {
            const idx = Math.min(level - 1, bgColors.length - 1);
            document.body.style.backgroundColor = bgColors[idx];
            document.body.style.color = textColors[idx];
        }

        function updateComboDisplay() {
            if (comboCount > 0) {
                comboCountEl.innerText = comboCount;
                comboCountEl.classList.add('show');
                comboTextEl.classList.add('active');
            } else {
                comboCountEl.classList.remove('show');
                comboTextEl.classList.remove('active');
                comboBonusEl.classList.remove('show');
            }
        }

        function calculateComboBonus() {
            // ÈÄ£Á∂öÊ≠£Ëß£Êï∞„Å´Âøú„Åò„Åü„Éú„Éº„Éä„Çπ„Çπ„Ç≥„Ç¢„ÇíË®àÁÆó
            // 3ÂïèÈÄ£Á∂ö: +10ÁÇπ„ÄÅ5ÂïèÈÄ£Á∂ö: +30ÁÇπ„ÄÅ10ÂïèÈÄ£Á∂ö: +100ÁÇπ„ÄÅ20ÂïèÈÄ£Á∂ö: +300ÁÇπ
            if (comboCount >= 20) {
                return 300;
            } else if (comboCount >= 10) {
                return 100;
            } else if (comboCount >= 5) {
                return 30;
            } else if (comboCount >= 3) {
                return 10;
            }
            return 0;
        }

        function showComboBonus(bonus) {
            if (bonus > 0) {
                comboBonusEl.innerText = `+${bonus}ÁÇπ„Éú„Éº„Éä„ÇπÔºÅ`;
                comboBonusEl.classList.add('show');
                setTimeout(() => {
                    comboBonusEl.classList.remove('show');
                }, 2000);
            }
        }

        function getMistakeExplanation(selected, correctAnswer) {
            const basePrice = currentQuestion.basePrice;
            const discountPercent = currentQuestion.discountPercent;
            const answerUnit = currentQuestion.answerUnit || 'ÂÜÜ';
            
            if (currentLevel <= 5) {
                // Ââ≤ÂºïÂïèÈ°å
                const discountAmount = Math.floor(basePrice * discountPercent / 100);
                const discountDecimal = discountPercent / 100;
                const correctFormula = `${basePrice} √ó (1 - ${discountDecimal}) = ${basePrice} √ó ${(1 - discountDecimal).toFixed(2)} = ${correctAnswer}${answerUnit}`;
                
                // 1. Ââ≤ÂºïÈ°ç„Å†„Åë„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü
                if (selected === discountAmount) {
                    return `Ââ≤ÂºïÈ°çÔºà${discountAmount}${answerUnit}Ôºâ„Å†„Åë„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\nÊîØÊâï„ÅÜÈáëÈ°ç„ÅØ„ÄåÂÖÉ„ÅÆÂÄ§ÊÆµ - Ââ≤ÂºïÈ°ç„Äç„ÅßË®àÁÆó„Åô„Çã„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                }
                
                // 2. „Éë„Éº„Çª„É≥„Éà„ÇíË∂≥„Åó„Å¶„Åó„Åæ„Å£„Åü
                if (selected === basePrice + discountAmount) {
                    return `„Éë„Éº„Çª„É≥„Éà„ÇíË∂≥„Åó„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\nÂâ≤Âºï„ÅØ„ÄåÂºï„Åè„Äç„Å†„Åã„Çâ„ÄÅÂÖÉ„ÅÆÂÄ§ÊÆµ„Åã„ÇâÂâ≤ÂºïÈ°ç„ÇíÂºï„Åè„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                }
                
                // 3. ÂÖÉ„ÅÆÂÄ§ÊÆµ„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü
                if (selected === basePrice) {
                    return `ÂÖÉ„ÅÆÂÄ§ÊÆµ„Çí„Åù„ÅÆ„Åæ„ÅæÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\n${discountPercent}%Âºï„Åç„Å†„Åã„Çâ„ÄÅÂâ≤ÂºïÈ°ç„ÇíÂºï„ÅèÂøÖË¶Å„Åå„ÅÇ„Çã„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                }
                
                // 4. ‰ºº„Åü„Éë„Éº„Çª„É≥„Éà„Å®ÂãòÈÅï„ÅÑ
                const similarPercent = discountPercent === 10 ? 20 : discountPercent === 20 ? 10 : discountPercent - 10;
                const similarAnswer = Math.floor(basePrice * (100 - similarPercent) / 100);
                if (Math.abs(selected - similarAnswer) <= 5) {
                    return `${similarPercent}%Âºï„Åç„Å®ÂãòÈÅï„ÅÑ„Åó„Åü„Åã„Å™Ôºü\n‰ªäÂõû„ÅØ${discountPercent}%Âºï„Åç„Å†„Åã„Çâ„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë®àÁÆó„Åó„Å¶„Åø„Çà„ÅÜÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                }
                
            } else if (currentLevel <= 8) {
                // Ââ≤Âêà„ÅÆÂïèÈ°å
                const remaining = basePrice - correctAnswer;
                const percentDecimal = discountPercent / 100;
                const correctFormula = `${basePrice} √ó ${percentDecimal} = ${basePrice} √ó ${discountPercent} √∑ 100 = ${correctAnswer}${answerUnit}`;
                
                // 1. ÊÆã„Çä„ÅÆ%„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü
                if (selected === remaining) {
                    return `ÊÆã„Çä„ÅÆ${100 - discountPercent}%„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\nËÅû„Åã„Çå„Å¶„ÅÑ„Çã„ÅÆ„ÅØ${discountPercent}%„ÅÆÊñπ„Å†„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                }
                
                // 2. ÂÖ®‰Ωì„ÅÆ‰∫∫Êï∞„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü
                if (selected === basePrice) {
                    return `ÂÖ®‰Ωì„ÅÆ‰∫∫Êï∞„Çí„Åù„ÅÆ„Åæ„ÅæÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\n${discountPercent}%„ÅØ„ÄåÂÖ®‰Ωì √ó ${discountPercent} √∑ 100„Äç„ÅßË®àÁÆó„Åô„Çã„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                }
                
                // 3. „Éë„Éº„Çª„É≥„Éà„Å®total„ÇíË∂≥„Åó„Å¶„Åó„Åæ„Å£„Åü
                if (selected === basePrice + discountPercent) {
                    return `„Éë„Éº„Çª„É≥„Éà„Å®ÂÖ®‰Ωì„ÇíË∂≥„Åó„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\n${discountPercent}%„ÅØ„ÄåÂÖ®‰Ωì √ó ${discountPercent} √∑ 100„Äç„ÅßË®àÁÆó„Åô„Çã„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                }
                
                // 4. ‰ºº„Åü„Éë„Éº„Çª„É≥„Éà„Å®ÂãòÈÅï„ÅÑ
                const similarPercent = discountPercent === 10 ? 20 : discountPercent === 20 ? 30 : discountPercent + 10;
                const similarAnswer = Math.floor(basePrice * similarPercent / 100);
                if (Math.abs(selected - similarAnswer) <= 5 && selected !== correctAnswer) {
                    return `${similarPercent}%„Å®ÂãòÈÅï„ÅÑ„Åó„Åü„Åã„Å™Ôºü\n‰ªäÂõû„ÅØ${discountPercent}%„Å†„Åã„Çâ„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë®àÁÆó„Åó„Å¶„Åø„Çà„ÅÜÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                }
                
            } else {
                // „É¨„Éô„É´9-10: Ë§áÂêàÂïèÈ°å
                if (answerUnit === '%') {
                    // „Äå‚óãÂÄã„ÅÆ„ÅÜ„Å°‚óãÂÄã„ÅØ‰Ωï%Ôºü„Äç„ÅÆÂïèÈ°å
                    const remainingPercent = Math.round((basePrice - discountPercent) * 100 / basePrice);
                    const correctFormula = `${discountPercent} √∑ ${basePrice} √ó 100 = ${correctAnswer}%`;
                    
                    // 1. ÊÆã„Çä„ÅÆ%„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü
                    if (selected === remainingPercent) {
                        return `ÊÆã„Çä„ÅÆ${remainingPercent}%„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\nËÅû„Åã„Çå„Å¶„ÅÑ„Çã„ÅÆ„ÅØ${discountPercent}ÂÄã„ÅÆÊñπ„ÅÆ%„Å†„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                    }
                    
                    // 2. 10ÂÄç„Åó„Å¶„Åó„Åæ„Å£„Åü
                    if (selected === Math.min(100, correctAnswer * 10)) {
                        return `10ÂÄç„Åó„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\n${discountPercent}ÂÄã √∑ ${basePrice}ÂÄã √ó 100 „ÅßË®àÁÆó„Åô„Çã„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                    }
                    
                    // 3. ÂÄãÊï∞„Çí„Åù„ÅÆ„Åæ„Åæ%„Å®Á≠î„Åà„Å¶„Åó„Åæ„Å£„Åü
                    if (selected === discountPercent) {
                        return `ÂÄãÊï∞Ôºà${discountPercent}Ôºâ„Çí„Åù„ÅÆ„Åæ„Åæ%„Å®Á≠î„Åà„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\n%„ÅØ„ÄåÂÄãÊï∞ √∑ ÂÖ®‰Ωì √ó 100„Äç„ÅßË®àÁÆó„Åô„Çã„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                    }
                    
                } else {
                    // „Äå„ÅÑ„Åè„Çâ„Å´„Å™„ÇãÔºü„Äç„ÅÆÂïèÈ°åÔºà‰∫åÈáçÂâ≤Âºï„Å™„Å©Ôºâ
                    const discount1 = currentQuestion.discount1 || discountPercent;
                    const discount2 = currentQuestion.discount2 || 0;
                    const firstDiscountOnly = Math.floor(basePrice * (100 - discount1) / 100);
                    const discount1Decimal = discount1 / 100;
                    const discount2Decimal = discount2 / 100;
                    const afterFirstDiscount = basePrice * (1 - discount1Decimal);
                    const correctFormula = `${basePrice} √ó (1 - ${discount1Decimal}) √ó (1 - ${discount2Decimal}) = ${basePrice} √ó ${(1 - discount1Decimal).toFixed(2)} √ó ${(1 - discount2Decimal).toFixed(2)} = ${correctAnswer}${answerUnit}`;
                    
                    // 1. ÊúÄÂàù„ÅÆÂâ≤Âºï„Å†„Åë„ÇíË®àÁÆó„Åó„Å¶„Åó„Åæ„Å£„Åü
                    if (selected === firstDiscountOnly) {
                        return `ÊúÄÂàù„ÅÆ${discount1}%Âºï„Åç„Å†„Åë„ÇíË®àÁÆó„Åó„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\n${discount2}%Âºï„Åç„ÇÇÁ∂ö„Åë„Å¶Ë®àÁÆó„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                    }
                    
                    // 2. Ââ≤ÂºïÁéá„ÇíË∂≥„Åó„Å¶„Åó„Åæ„Å£„Åü
                    const addedDiscount = Math.floor(basePrice * (100 - discount1 - discount2) / 100);
                    if (selected === addedDiscount) {
                        return `Ââ≤ÂºïÁéá„ÇíË∂≥„Åó„Å¶„Åó„Åæ„Å£„Åü„Å≠„ÄÇ\n‰∫åÈáçÂâ≤Âºï„ÅØ„ÄåÊúÄÂàù„Å´${discount1}%Âºï„Åç„ÄÅ„Åù„ÅÆÂÄ§ÊÆµ„Åã„Çâ„Åï„Çâ„Å´${discount2}%Âºï„Åç„Äç„Å†„ÇàÔºÅ\n\nÊ≠£„Åó„ÅÑÂºè: ${correctFormula}`;
                    }
                }
            }
            
            // „Éá„Éï„Ç©„É´„Éà„ÅÆË™¨ÊòéÔºàÊ≠£„Åó„ÅÑÂºè„ÇíËøΩÂä†Ôºâ
            let defaultFormula = '';
            if (currentLevel <= 5) {
                const discountDecimal = discountPercent / 100;
                defaultFormula = `\n\nÊ≠£„Åó„ÅÑÂºè: ${basePrice} √ó (1 - ${discountDecimal}) = ${basePrice} √ó ${(1 - discountDecimal).toFixed(2)} = ${correctAnswer}${answerUnit}`;
            } else if (currentLevel <= 8) {
                const percentDecimal = discountPercent / 100;
                defaultFormula = `\n\nÊ≠£„Åó„ÅÑÂºè: ${basePrice} √ó ${percentDecimal} = ${basePrice} √ó ${discountPercent} √∑ 100 = ${correctAnswer}${answerUnit}`;
            } else {
                if (answerUnit === '%') {
                    defaultFormula = `\n\nÊ≠£„Åó„ÅÑÂºè: ${discountPercent} √∑ ${basePrice} √ó 100 = ${correctAnswer}%`;
                } else {
                    const discount1 = currentQuestion.discount1 || discountPercent;
                    const discount2 = currentQuestion.discount2 || 0;
                    const discount1Decimal = discount1 / 100;
                    const discount2Decimal = discount2 / 100;
                    defaultFormula = `\n\nÊ≠£„Åó„ÅÑÂºè: ${basePrice} √ó (1 - ${discount1Decimal}) √ó (1 - ${discount2Decimal}) = ${correctAnswer}${answerUnit}`;
                }
            }
            return `Ê≠£Ëß£„ÅØ${correctAnswer}${answerUnit}„Å†„Çà„ÄÇ\n„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÄÉ„Åà„Å¶„Åø„Çà„ÅÜÔºÅ${defaultFormula}`;
        }

        function createPercentVisual(percent) {
            const container = document.createElement('div');
            container.className = 'visual-percent';
            
            // „Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„É©„Éô„É´
            const label = document.createElement('div');
            label.className = 'percent-label';
            label.innerText = `${percent}%Âºï„Åç`;
            container.appendChild(label);
            
            // Êï∞Áõ¥Á∑öÂõ≥
            const numberLineContainer = document.createElement('div');
            numberLineContainer.className = 'number-line-container';
            
            const numberLine = document.createElement('div');
            numberLine.className = 'number-line';
            
            // ËÉåÊôØ„Éê„Éº
            const bar = document.createElement('div');
            bar.className = 'number-line-bar';
            numberLine.appendChild(bar);
            
            // Â°ó„Çä„Å§„Å∂„ÅóÈÉ®ÂàÜÔºàÂâ≤ÂºïÈÉ®ÂàÜÔºâ
            const filled = document.createElement('div');
            filled.className = 'number-line-filled';
            filled.style.width = `${percent}%`;
            numberLine.appendChild(filled);
            
            // ÁõÆÁõõ„Çä„Å®„É©„Éô„É´Ôºà0, 25, 50, 75, 100Ôºâ
            const marks = [0, 25, 50, 75, 100];
            marks.forEach(value => {
                const marker = document.createElement('div');
                marker.className = 'number-line-marker major';
                marker.style.left = `${value}%`;
                
                const labelEl = document.createElement('div');
                labelEl.className = 'number-line-label';
                labelEl.innerText = value;
                if (value === 0) {
                    labelEl.style.left = '0%';
                    labelEl.style.transform = 'translateX(0)';
                } else if (value === 100) {
                    labelEl.style.left = '100%';
                    labelEl.style.transform = 'translateX(-100%)';
                } else {
                    labelEl.style.left = `${value}%`;
                    labelEl.style.transform = 'translateX(-50%)';
                }
                numberLine.appendChild(labelEl);
                numberLine.appendChild(marker);
            });
            
            // ÁèæÂú®„ÅÆÂÄ§„ÅÆ„Éû„Éº„Ç´„Éº
            const currentMarker = document.createElement('div');
            currentMarker.className = 'number-line-current';
            currentMarker.innerText = `${percent}%`;
            currentMarker.style.left = `${percent}%`;
            numberLine.appendChild(currentMarker);
            
            const arrow = document.createElement('div');
            arrow.className = 'number-line-arrow';
            arrow.style.left = `${percent}%`;
            numberLine.appendChild(arrow);
            
            numberLineContainer.appendChild(numberLine);
            container.appendChild(numberLineContainer);
            
            // Ë™¨ÊòéÊñá
            const explanation = document.createElement('div');
            explanation.className = 'percent-explanation';
            const remaining = 100 - percent;
            explanation.innerText = `100%„ÅÆ„ÅÜ„Å°${percent}%„ÅåÂâ≤Âºï„ÄÅÊÆã„Çä${remaining}%„ÅåÊîØÊâï„ÅÑ`;
            container.appendChild(explanation);
            
            return container;
        }

        // --- „É™„Çª„ÉÉ„ÉàÊ©üËÉΩ ---
        function confirmReset() {
            if (!titleScreen.classList.contains('hidden')) return;

            if (confirm("„Çø„Ç§„Éà„É´„Å´„ÇÇ„Å©„ÇãÔºü\nÔºà‰ªä„ÅÆ„Çπ„Ç≥„Ç¢„ÅØ„Åç„Åà„Å°„ÇÉ„ÅÜ„ÇàÔºâ")) {
                if (timerInterval) clearInterval(timerInterval);
                toTitle();
            }
        }

        // --- „Ç≤„Éº„É†ÈÄ≤Ë°å ---
        function startGame() {
            initAudio();
            isTimeAttack = modeToggle.checked;
            
            titleScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            clearScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            currentScore = 0;
            currentLevel = 1;
            correctInLevel = 0;
            comboCount = 0;
            
            scoreEl.innerText = 0;
            levelNumEl.innerText = 1;
            toNextLevelEl.innerText = requiredForLevelUp;
            updateComboDisplay();
            
            updateBackground(1);
            
            badgeContainer.innerHTML = '<div class="badge-title">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</div>';

            // Ë®àÁÆó„Éë„Éç„É´„ÇíÈñã„Åè
            openCalcPanel();

            if (isTimeAttack) {
                timeLeft = 60;
                timerDisplay.innerText = "60Áßí";
                startTimer();
            } else {
                timerDisplay.innerText = "„Å™„Åó";
            }
            
            generateProblem();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft + "Áßí";
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        function generateProblem() {
            mascotEl.innerText = mascots[Math.floor(Math.random() * mascots.length)];

            let problemType;
            let basePrice, discountPercent, answer;
            let questionText = "";
            let discount1 = null;
            let discount2 = null;

            if (currentLevel <= 2) {
                // „É¨„Éô„É´1-2: Âü∫Êú¨ÁöÑ„Å™Ââ≤ÂêàÔºà25%, 50%, 75%„Å™„Å©Ôºâ
                const easyPercents = [10, 20, 25, 30, 50, 75, 80, 90];
                discountPercent = easyPercents[Math.floor(Math.random() * easyPercents.length)];
                basePrice = Math.floor(Math.random() * 9 + 1) * 100; // 100-900ÂÜÜ
                answer = Math.floor(basePrice * (100 - discountPercent) / 100);
                questionText = `${basePrice}ÂÜÜ„ÅÆÂïÜÂìÅ„Åå${discountPercent}%Âºï„ÅçÔºÅ„ÅÑ„Åè„Çâ„Å´„Å™„ÇãÔºü`;
                hintText.innerText = "„Åã„Çì„Åü„ÇìÔºÅ";

            } else if (currentLevel <= 5) {
                // „É¨„Éô„É´3-5: Ââ≤ÂºïË®àÁÆóÔºàÂ∞ë„ÅóË§áÈõëÔºâ
                discountPercent = Math.floor(Math.random() * 40 + 10); // 10-50%
                basePrice = Math.floor(Math.random() * 19 + 1) * 100; // 100-1900ÂÜÜ
                answer = Math.floor(basePrice * (100 - discountPercent) / 100);
                questionText = `${basePrice}ÂÜÜ„ÅÆÂïÜÂìÅ„Åå${discountPercent}%Âºï„ÅçÔºÅ„ÅÑ„Åè„Çâ„Å´„Å™„ÇãÔºü`;
                hintText.innerText = "„Å°„Çá„Å£„Å®„ÇÄ„Åö„Åã„Åó„ÅÑ";

            } else if (currentLevel <= 8) {
                // „É¨„Éô„É´6-8: Ââ≤Âêà„Åã„ÇâÂÆüÈöõ„ÅÆÊï∞„ÇíÊ±Ç„ÇÅ„Çã
                const total = Math.floor(Math.random() * 9 + 2) * 10; // 20-100
                const percent = Math.floor(Math.random() * 8 + 1) * 10; // 10-80%
                answer = Math.floor(total * percent / 100);
                questionText = `${total}‰∫∫„ÅÆ${percent}%„ÅØ‰Ωï‰∫∫Ôºü`;
                hintText.innerText = "„Åß„Åç„Çã„Åã„Å™Ôºü";
                basePrice = total;
                discountPercent = percent;

            } else {
                // „É¨„Éô„É´9-10: Ë§áÂêàÂïèÈ°å
                if (Math.random() < 0.5) {
                    // ‰∫åÈáçÂâ≤Âºï
                    basePrice = Math.floor(Math.random() * 19 + 1) * 100;
                    discount1 = Math.floor(Math.random() * 30 + 10);
                    discount2 = Math.floor(Math.random() * 20 + 10);
                    answer = Math.floor(basePrice * (100 - discount1) / 100 * (100 - discount2) / 100);
                    questionText = `${basePrice}ÂÜÜ„ÅÆÂïÜÂìÅ„Åå${discount1}%Âºï„Åç„ÄÅ„Åï„Çâ„Å´${discount2}%Âºï„ÅçÔºÅ„ÅÑ„Åè„Çâ„Å´„Å™„ÇãÔºü`;
                    discountPercent = discount1; // ÊúÄÂàù„ÅÆÂâ≤ÂºïÁéá„Çí‰øùÂ≠ò
                } else {
                    // Ââ≤Âêà„ÅÆË®àÁÆó
                    const total = Math.floor(Math.random() * 9 + 2) * 10;
                    const part = Math.floor(Math.random() * (total - 1) + 1);
                    answer = Math.round(part * 100 / total);
                    questionText = `${total}ÂÄã„ÅÆ„ÅÜ„Å°${part}ÂÄã„ÅØ‰Ωï%Ôºü`;
                    basePrice = total;
                    discountPercent = part;
                }
                hintText.innerText = "„É©„Çπ„Éà„Çπ„Éë„Éº„ÉàÔºÅ";
            }

            // ÂïèÈ°å„Çø„Ç§„Éó„ÇíÂà§ÂÆö
            let answerUnit = 'ÂÜÜ'; // „Éá„Éï„Ç©„É´„Éà„ÅØÂÜÜ
            if (questionText.includes('‰Ωï%') || questionText.includes('%„ÅØ')) {
                answerUnit = '%';
            } else if (questionText.includes('‰Ωï‰∫∫')) {
                answerUnit = '‰∫∫';
            } else if (questionText.includes('„ÅÑ„Åè„Çâ„Å´„Å™„Çã')) {
                answerUnit = 'ÂÜÜ';
            }

            currentQuestion = {
                type: currentLevel <= 5 ? 'discount' : currentLevel <= 8 ? 'percent' : 'complex',
                answer: answer,
                basePrice: basePrice,
                discountPercent: discountPercent,
                questionText: questionText,
                answerUnit: answerUnit,
                discount1: discount1,
                discount2: discount2
            };

            // ÂïèÈ°åË°®Á§∫
            questionArea.innerHTML = `
                <div class="product-display">${products[Math.floor(Math.random() * products.length)]}</div>
                <div class="price-display">${questionText}</div>
                ${currentLevel <= 5 ? createPercentVisual(discountPercent).outerHTML : ''}
            `;

            generateOptions(answer);
        }

        function generateOptions(correctAnswer) {
            optionsEl.innerHTML = '';
            const basePrice = currentQuestion.basePrice;
            const discountPercent = currentQuestion.discountPercent;
            let wrongOptions = [];

            if (currentLevel <= 5) {
                // Ââ≤ÂºïÂïèÈ°åÔºöÂ≠ê‰æõ„ÅåÈñìÈÅï„Åà„Åù„ÅÜ„Å™ÈÅ∏ÊäûËÇ¢
                // 1. Ââ≤ÂºïÈ°ç„Å†„Åë„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö100ÂÜÜ10%Âºï„Åç ‚Üí 10ÂÜÜ„Å®Á≠î„Åà„ÇãÔºâ
                const discountAmount = Math.floor(basePrice * discountPercent / 100);
                wrongOptions.push(discountAmount);
                
                // 2. „Éë„Éº„Çª„É≥„Éà„ÇíË∂≥„Åó„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö100ÂÜÜ10%Âºï„Åç ‚Üí 110ÂÜÜ„Å®Á≠î„Åà„ÇãÔºâ
                const addedPrice = basePrice + discountAmount;
                wrongOptions.push(addedPrice);
                
                // 3. „Éë„Éº„Çª„É≥„Éà„Çí„Åù„ÅÆ„Åæ„ÅæÂºï„ÅÑ„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö100ÂÜÜ10%Âºï„Åç ‚Üí 90ÂÜÜ„Åß„ÅØ„Å™„Åè90%„Å®ÂãòÈÅï„ÅÑ„Åó„Å¶100-10=90„ÄÅ„Åß„ÇÇ„Åì„Çå„ÅØÂÅ∂ÁÑ∂Ê≠£Ëß£„Å´„Å™„Çã„Åì„Å®„ÇÇ„ÅÇ„Çã„ÅÆ„Åß„ÄÅÂà•„ÅÆ„Éë„Çø„Éº„É≥Ôºâ
                // ‰ª£„Çè„Çä„Å´„ÄÅ‰ºº„Åü„Éë„Éº„Çª„É≥„Éà„Å®ÂãòÈÅï„ÅÑÔºà‰æãÔºö20%Âºï„Åç„Å®ÂãòÈÅï„ÅÑÔºâ
                const similarPercent = discountPercent === 10 ? 20 : discountPercent === 20 ? 10 : discountPercent - 10;
                const similarAnswer = Math.floor(basePrice * (100 - similarPercent) / 100);
                wrongOptions.push(similarAnswer);
                
                // 4. Ââ≤ÂºïÈ°ç„ÇíÂºï„Åè„ÅÆ„ÇíÂøò„Çå„Å¶„ÄÅÂÖÉ„ÅÆÂÄ§ÊÆµ„ÇíÁ≠î„Åà„Çã
                wrongOptions.push(basePrice);

            } else if (currentLevel <= 8) {
                // Ââ≤Âêà„ÅÆÂïèÈ°åÔºö„Äå‚óã‰∫∫„ÅÆ‚óã%„ÅØ‰Ωï‰∫∫Ôºü„Äç
                // 1. ÊÆã„Çä„ÅÆ%„ÇíÁ≠î„Åà„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö100‰∫∫„ÅÆ30% ‚Üí 70‰∫∫„Å®Á≠î„Åà„ÇãÔºâ
                const remaining = basePrice - correctAnswer;
                wrongOptions.push(remaining);
                
                // 2. „Éë„Éº„Çª„É≥„Éà„Çí„Åù„ÅÆ„Åæ„ÅæÁ≠î„Åà„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö100‰∫∫„ÅÆ30% ‚Üí 30„Å®Á≠î„Åà„Çã„ÄÅ„Åß„ÇÇ„Åì„Çå„ÅØÊ≠£Ëß£„ÅÆÂ†¥Âêà„ÇÇ„ÅÇ„Çã„ÅÆ„Åß„ÄÅÂà•„ÅÆ„Éë„Çø„Éº„É≥Ôºâ
                // ‰ª£„Çè„Çä„Å´„ÄÅ„Éë„Éº„Çª„É≥„Éà„Çí„Åù„ÅÆ„Åæ„Åæ‰∫∫Êï∞„Å®„Åó„Å¶Á≠î„Åà„ÇãÔºà‰æãÔºö30% ‚Üí 30‰∫∫„ÄÅ„Åß„ÇÇ„Åì„Çå„ÅØÊ≠£Ëß£„ÅÆÂ†¥Âêà„ÇÇ„ÅÇ„ÇãÔºâ
                // „Çà„ÇäÁ¢∫ÂÆü„Å´ÈñìÈÅï„Åà„Çã„Éë„Çø„Éº„É≥Ôºötotal„Çí„Åù„ÅÆ„Åæ„ÅæÁ≠î„Åà„Çã
                wrongOptions.push(basePrice);
                
                // 3. „Éë„Éº„Çª„É≥„Éà„Å®total„ÇíË∂≥„Åó„Å¶„Åó„Åæ„ÅÜ
                const added = basePrice + discountPercent;
                wrongOptions.push(added);
                
                // 4. ‰ºº„Åü„Éë„Éº„Çª„É≥„Éà„Å®ÂãòÈÅï„ÅÑÔºà‰æãÔºö30%„Å®40%„ÇíÈñìÈÅï„Åà„ÇãÔºâ
                const similarPercent = discountPercent === 10 ? 20 : discountPercent === 20 ? 30 : discountPercent + 10;
                const similarAnswer = Math.floor(basePrice * similarPercent / 100);
                if (similarAnswer !== correctAnswer && similarAnswer <= basePrice) {
                    wrongOptions.push(similarAnswer);
                } else {
                    // ‰ª£„Çè„Çä„Å´„ÄÅ„Éë„Éº„Çª„É≥„Éà„Çí„Åù„ÅÆ„Åæ„ÅæÂºï„ÅÑ„ÅüÂÄ§
                    wrongOptions.push(Math.max(1, basePrice - discountPercent));
                }

            } else {
                // „É¨„Éô„É´9-10: Ë§áÂêàÂïèÈ°å
                if (currentQuestion.answerUnit === '%') {
                    // „Äå‚óãÂÄã„ÅÆ„ÅÜ„Å°‚óãÂÄã„ÅØ‰Ωï%Ôºü„Äç„ÅÆÂïèÈ°å
                    // 1. ÈÄÜ„Å´„Åó„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö100ÂÄã„ÅÆ„ÅÜ„Å°30ÂÄã ‚Üí 30%„Åß„ÅØ„Å™„Åè„ÄÅ100/30*100„ÅÆ„Çà„ÅÜ„Å™Ë®àÁÆóÔºâ
                    const reversed = Math.round(basePrice * 100 / discountPercent);
                    if (reversed !== correctAnswer && reversed <= 100) {
                        wrongOptions.push(reversed);
                    } else {
                        wrongOptions.push(Math.min(100, Math.round(discountPercent * 10)));
                    }
                    
                    // 2. ÂÄãÊï∞„Çí„Åù„ÅÆ„Åæ„ÅæÁ≠î„Åà„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö30ÂÄã ‚Üí 30%„Å®Á≠î„Åà„Çã„ÄÅ„Åß„ÇÇ„Åì„Çå„ÅØÊ≠£Ëß£„ÅÆÂ†¥Âêà„ÇÇ„ÅÇ„ÇãÔºâ
                    // ‰ª£„Çè„Çä„Å´„ÄÅÊÆã„Çä„ÅÆ%„ÇíÁ≠î„Åà„Çã
                    const remainingPercent = Math.round((basePrice - discountPercent) * 100 / basePrice);
                    wrongOptions.push(remainingPercent);
                    
                    // 3. 10ÂÄç„Åó„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö3%„Çí30%„Å®Á≠î„Åà„ÇãÔºâ
                    const multiplied = Math.min(100, correctAnswer * 10);
                    if (multiplied !== correctAnswer) {
                        wrongOptions.push(multiplied);
                    } else {
                        wrongOptions.push(Math.max(1, Math.floor(correctAnswer / 10)));
                    }
                    
                    // 4. ‰ºº„ÅüÂÄãÊï∞„Å®ÂãòÈÅï„ÅÑ
                    const similarPart = discountPercent === 1 ? 2 : discountPercent - 1;
                    const similarPercent = Math.round(similarPart * 100 / basePrice);
                    if (similarPercent !== correctAnswer && similarPercent <= 100) {
                        wrongOptions.push(similarPercent);
                    } else {
                        wrongOptions.push(Math.min(100, correctAnswer + 5));
                    }
                } else {
                    // „Äå„ÅÑ„Åè„Çâ„Å´„Å™„ÇãÔºü„Äç„ÅÆÂïèÈ°åÔºà‰∫åÈáçÂâ≤Âºï„Å™„Å©Ôºâ
                    const discount1 = currentQuestion.discount1 || discountPercent; // ÊúÄÂàù„ÅÆÂâ≤ÂºïÁéá
                    const discount2 = currentQuestion.discount2 || Math.floor(Math.random() * 20 + 10); // 2„Å§ÁõÆ„ÅÆÂâ≤ÂºïÁéá
                    
                    // 1. ÊúÄÂàù„ÅÆÂâ≤Âºï„Å†„Åë„ÇíË®àÁÆó„Åó„Å¶„Åó„Åæ„ÅÜ
                    const firstDiscountOnly = Math.floor(basePrice * (100 - discount1) / 100);
                    wrongOptions.push(firstDiscountOnly);
                    
                    // 2. Ââ≤ÂºïÁéá„ÇíË∂≥„Åó„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö10%+20%=30%Âºï„Åç„Å®ÂãòÈÅï„ÅÑÔºâ
                    const addedDiscount = Math.floor(basePrice * (100 - discount1 - discount2) / 100);
                    wrongOptions.push(addedDiscount);
                    
                    // 3. Ââ≤ÂºïÈ°ç„ÇíË∂≥„Åó„Å¶„Åó„Åæ„ÅÜÔºà‰æãÔºö10%Âºï„Åç„ÅÆÈ°ç„Å®20%Âºï„Åç„ÅÆÈ°ç„Çí‰∏°ÊñπÂºï„ÅèÔºâ
                    const discountAmount1 = Math.floor(basePrice * discount1 / 100);
                    const discountAmount2 = Math.floor(basePrice * discount2 / 100);
                    const addedAmount = basePrice - discountAmount1 - discountAmount2;
                    wrongOptions.push(addedAmount);
                    
                    // 4. ÂÖÉ„ÅÆÂÄ§ÊÆµ„Çí„Åù„ÅÆ„Åæ„ÅæÁ≠î„Åà„ÇãÔºàÂâ≤Âºï„ÇíÂøò„Çå„ÇãÔºâ
                    wrongOptions.push(basePrice);
                }
            }

            // Ê≠£Ëß£„Å®ÈñìÈÅï„ÅÑ„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÂêà„Çè„Åõ„Å¶„ÄÅÈáçË§á„ÇíÈô§„Åè
            let options = new Set([correctAnswer]);
            wrongOptions.forEach(opt => {
                if (opt !== correctAnswer && opt > 0) {
                    // Âçò‰Ωç„Å´Âøú„Åò„Å¶ÁØÑÂõ≤„ÉÅ„Çß„ÉÉ„ÇØ
                    if (currentQuestion.answerUnit === '%' && opt <= 100) {
                        options.add(opt);
                    } else if (currentQuestion.answerUnit === '‰∫∫' && opt <= basePrice) {
                        options.add(opt);
                    } else if (currentQuestion.answerUnit === 'ÂÜÜ') {
                        options.add(opt);
                    }
                }
            });

            // 4Êäû„Å´„Å™„Çã„Åæ„Åß„ÄÅ„É©„É≥„ÉÄ„É†„Å™ÈÅ∏ÊäûËÇ¢„ÇíËøΩÂä†Ôºà‰∏á„Åå‰∏Ä‰∏çË∂≥„Åó„ÅüÂ†¥ÂêàÔºâ
            while (options.size < 4) {
                let randomOption;
                if (currentQuestion.answerUnit === '%') {
                    randomOption = Math.floor(Math.random() * 100) + 1;
                } else if (currentQuestion.answerUnit === '‰∫∫') {
                    randomOption = Math.floor(Math.random() * basePrice) + 1;
                } else {
                    randomOption = Math.floor(Math.random() * basePrice * 2) + Math.floor(basePrice * 0.5);
                }
                if (randomOption !== correctAnswer && randomOption > 0) {
                    options.add(randomOption);
                }
            }

            // 4Êäû„Å´Áµû„ÇãÔºàÊ≠£Ëß£„ÇíÂê´„ÇÅ„Å¶ÂøÖ„Åö4„Å§Ôºâ
            const optionsArray = Array.from(options);
            
            // Ê≠£Ëß£„ÇíÁ¢∫ÂÆü„Å´Âê´„ÇÅ„Çã
            const selectedOptions = [correctAnswer];
            
            // Ê≠£Ëß£‰ª•Â§ñ„Åã„Çâ3„Å§ÈÅ∏„Å∂
            const wrongOptionsArray = optionsArray.filter(opt => opt !== correctAnswer);
            while (selectedOptions.length < 4 && wrongOptionsArray.length > 0) {
                const randomIndex = Math.floor(Math.random() * wrongOptionsArray.length);
                const selected = wrongOptionsArray.splice(randomIndex, 1)[0];
                selectedOptions.push(selected);
            }
            
            // „Åæ„Å†4„Å§„Å´Ê∫Ä„Åü„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„É©„É≥„ÉÄ„É†„Å´ËøΩÂä†
            while (selectedOptions.length < 4) {
                let randomOption;
                if (currentQuestion.answerUnit === '%') {
                    randomOption = Math.floor(Math.random() * 100) + 1;
                } else if (currentQuestion.answerUnit === '‰∫∫') {
                    randomOption = Math.floor(Math.random() * basePrice) + 1;
                } else {
                    randomOption = Math.floor(Math.random() * basePrice * 2) + Math.floor(basePrice * 0.5);
                }
                if (!selectedOptions.includes(randomOption) && randomOption > 0) {
                    selectedOptions.push(randomOption);
                }
            }

            // „É©„É≥„ÉÄ„É†„Å´‰∏¶„Å≥Êõø„Åà„Å¶Ë°®Á§∫
            selectedOptions.sort(() => Math.random() - 0.5).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                // ÂïèÈ°åÊñá„Å´Âøú„Åò„Å¶Âçò‰Ωç„ÇíË°®Á§∫
                if (currentQuestion.answerUnit === '%') {
                    btn.innerText = opt + "%";
                } else if (currentQuestion.answerUnit === '‰∫∫') {
                    btn.innerText = opt + "‰∫∫";
                } else {
                    // „Éá„Éï„Ç©„É´„Éà„ÅØÂÜÜ
                    btn.innerText = opt + "ÂÜÜ";
                }
                
                btn.onclick = () => checkAnswer(opt);
                optionsEl.appendChild(btn);
            });
        }

        function checkAnswer(selected) {
            if (selected === currentQuestion.answer) {
                // ÈÄ£Á∂öÊ≠£Ëß£Êï∞„ÇíÂ¢ó„ÇÑ„Åô
                comboCount++;
                updateComboDisplay();
                
                // Âü∫Êú¨„Çπ„Ç≥„Ç¢
                let baseScore = 10 * currentLevel;
                currentScore += baseScore;
                
                // „Ç≥„É≥„Éú„Éú„Éº„Éä„Çπ„ÇíË®àÁÆó
                const comboBonus = calculateComboBonus();
                if (comboBonus > 0) {
                    currentScore += comboBonus;
                    showComboBonus(comboBonus);
                }
                
                scoreEl.innerText = currentScore;
                correctInLevel++;
                
                if (correctInLevel >= requiredForLevelUp) {
                    levelUp();
                } else {
                    playSound('correct');
                    showFeedback(true);
                    toNextLevelEl.innerText = requiredForLevelUp - correctInLevel;
                    setTimeout(nextTurn, 800);
                }
            } else {
                // ÈñìÈÅï„Åà„Åü„ÇâÈÄ£Á∂öÊ≠£Ëß£Êï∞„Çí„É™„Çª„ÉÉ„Éà
                comboCount = 0;
                updateComboDisplay();
                
                playSound('wrong');
                showFeedback(false);
                
                // Ëß£Ë™¨„É¢„Éº„Éâ„ÅåON„ÅÆÊôÇ„Å†„ÅëË™¨Êòé„ÇíË°®Á§∫Ôºà„Éú„Çø„É≥„ÅßÊ¨°„Å∏ÈÄ≤„ÇÄÔºâ
                if (explanationToggle.checked) {
                    const explanation = getMistakeExplanation(selected, currentQuestion.answer);
                    showMistakeExplanation(explanation);
                    // „Éú„Çø„É≥„ÇíÊäº„Åô„Åæ„ÅßÂæÖ„Å§ÔºàËá™Âãï„ÅßÈÄ≤„Åæ„Å™„ÅÑÔºâ
                } else {
                    setTimeout(nextTurn, 800); // Ëß£Ë™¨„É¢„Éº„ÉâOFF„ÅÆÊôÇ„ÅØÈÄöÂ∏∏„ÅÆÊôÇÈñì
                }
            }
        }

        function showBadgeRibbon(badgeIcon, badgeName) {
            // Êó¢Â≠ò„ÅÆ„É™„Éú„É≥„ÇíÂâäÈô§
            const existingRibbon = document.querySelector('.badge-ribbon');
            if (existingRibbon) {
                existingRibbon.remove();
            }

            // „É™„Éú„É≥„Çí‰ΩúÊàê
            const ribbon = document.createElement('div');
            ribbon.className = 'badge-ribbon';
            ribbon.innerHTML = `
                <div class="badge-ribbon-title">„Éê„ÉÉ„Ç∏„ÇíÁç≤ÂæóÔºÅ</div>
                <div class="badge-ribbon-icon">${badgeIcon}</div>
                <div class="badge-ribbon-name">${badgeName}</div>
            `;
            document.body.appendChild(ribbon);

            // 2ÁßíÂæå„Å´„É™„Éú„É≥„ÇíÈùûË°®Á§∫
            setTimeout(() => {
                ribbon.classList.add('hiding');
                setTimeout(() => {
                    ribbon.remove();
                }, 400);
            }, 2000);
        }

        function levelUp() {
            const badgeIndex = Math.min(currentLevel - 1, badges.length - 1);
            const badgeIcon = badges[badgeIndex];
            const badgeName = badgeNames[badgeIndex];
            
            // „Éê„ÉÉ„Ç∏„ÇíËøΩÂä†
            const badgeEl = document.createElement('div');
            badgeEl.className = 'badge-slot badge-new';
            badgeEl.innerText = badgeIcon;
            badgeContainer.appendChild(badgeEl);
            badgeEl.scrollIntoView({ behavior: 'smooth' });

            // „É™„Éú„É≥„ÇíË°®Á§∫
            showBadgeRibbon(badgeIcon, badgeName);

            currentLevel++;
            correctInLevel = 0;

            if (currentLevel > 10) {
                playSound('levelup');
                showFeedback(true, "Clear!");
                setTimeout(() => {
                    gameClear();
                }, 1500);
                return;
            }

            playSound('levelup');
            showFeedback(true, "Level Up!");
            updateBackground(currentLevel);

            setTimeout(() => {
                levelNumEl.innerText = currentLevel;
                toNextLevelEl.innerText = requiredForLevelUp;
                nextTurn();
            }, 1500);
        }

        function nextTurn() {
            if (isTimeAttack && timeLeft <= 0) return;
            generateProblem();
        }

        function showFeedback(isCorrect, text = null) {
            feedbackEl.innerText = text ? text : (isCorrect ? '‚≠ïÔ∏è' : '‚ùå');
            feedbackEl.className = `feedback show ${isCorrect ? 'correct' : 'wrong'}`;
            if (text) feedbackEl.style.fontSize = "3.5rem";
            else feedbackEl.style.fontSize = "";

            mascotEl.innerText = isCorrect ? 'üòÜ' : 'ü•∫';
            setTimeout(() => feedbackEl.classList.remove('show'), 700);
        }

        function formatFormula(formulaString) {
            // „ÄåÊ≠£„Åó„ÅÑÂºè: „Äç„ÇíÂâäÈô§„Åó„Å¶Âºè„Å†„Åë„ÇíÂèñÂæó
            const formulaMatch = formulaString.match(/Ê≠£„Åó„ÅÑÂºè: (.+)/);
            if (!formulaMatch) return formulaString;

            const formula = formulaMatch[1];
            // „Äå=„Äç„ÅßÂàÜÂâ≤Ôºà„Åü„Å†„Åó„ÄÅ„Ç§„Ç≥„Éº„É´„ÇÇÂê´„ÇÅ„ÇãÔºâ
            const parts = formula.split(' = ');
            
            if (parts.length < 2) {
                // „Ç§„Ç≥„Éº„É´„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
                return `<div class="formula-container"><div class="formula-title">Ê≠£„Åó„ÅÑÂºè:</div><div class="formula-line">${formula}</div></div>`;
            }

            // ÊúÄÂàù„ÅÆÈÉ®ÂàÜÔºàÂ∑¶ÂÅ¥Ôºâ
            const firstPart = parts[0];
            // ÊÆã„Çä„ÅÆÈÉ®ÂàÜÔºàÂè≥ÂÅ¥„ÄÅË§áÊï∞„ÅÆ„Ç§„Ç≥„Éº„É´„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
            const remainingParts = parts.slice(1);

            let formulaHTML = '<div class="formula-container" data-formula-container>';
            formulaHTML += '<div class="formula-title">Ê≠£„Åó„ÅÑÂºè:</div>';
            
            // ÊúÄÂàù„ÅÆË°åÔºàÂ∑¶ÂÅ¥„ÅÆÂºèÔºâ
            formulaHTML += `<div class="formula-line" data-formula-first><span class="formula-left">${firstPart}</span><span class="equals">=</span><span class="formula-right">${remainingParts[0]}</span></div>`;
            
            // ÊÆã„Çä„ÅÆË°åÔºà„Ç§„Ç≥„Éº„É´„Åã„ÇâÂßã„Åæ„ÇãÔºâ
            for (let i = 1; i < remainingParts.length; i++) {
                formulaHTML += `<div class="formula-line" data-formula-continuation><span class="equals">=</span><span class="formula-right">${remainingParts[i]}</span></div>`;
            }
            
            formulaHTML += '</div>';
            return formulaHTML;
        }

        function showMistakeExplanation(explanation) {
            // Êó¢Â≠ò„ÅÆË™¨Êòé„ÇíÂâäÈô§
            const existingExplanation = document.querySelector('.mistake-explanation');
            if (existingExplanation) {
                existingExplanation.remove();
            }

            // Ë™¨ÊòéÊñá„ÇíÂá¶ÁêÜ
            let formattedExplanation = explanation;
            
            // „ÄåÊ≠£„Åó„ÅÑÂºè:„Äç„ÅßÂßã„Åæ„ÇãË°å„ÇíÊäΩÂá∫„Åó„Å¶„ÄÅË®àÁÆóÂºè„Å®„Åó„Å¶Âá¶ÁêÜ
            const formulaRegex = /Ê≠£„Åó„ÅÑÂºè: (.+)/g;
            let match;
            while ((match = formulaRegex.exec(explanation)) !== null) {
                const formulaHTML = formatFormula(match[0]);
                formattedExplanation = formattedExplanation.replace(match[0], formulaHTML);
            }

            // ÊÆã„Çä„ÅÆÊîπË°å„Çí<br>„Å´Â§âÊèõ
            formattedExplanation = formattedExplanation.replace(/\n/g, '<br>');

            // Ë™¨Êòé„ÇíË°®Á§∫
            const explanationEl = document.createElement('div');
            explanationEl.className = 'mistake-explanation show';
            explanationEl.innerHTML = `
                <div class="mistake-explanation-title">
                    üí° „Éí„É≥„Éà
                </div>
                <div class="mistake-explanation-text">${formattedExplanation}</div>
                <button class="explanation-next-btn" onclick="closeExplanationAndNext()">Ê¨°„Å∏ÈÄ≤„ÇÄ</button>
            `;
            document.body.appendChild(explanationEl);

            // Ë®àÁÆóÂºè„ÅÆ„Ç§„Ç≥„Éº„É´‰ΩçÁΩÆ„ÇíÊèÉ„Åà„Çã
            setTimeout(() => {
                const formulaContainer = explanationEl.querySelector('[data-formula-container]');
                if (formulaContainer) {
                    const firstLine = formulaContainer.querySelector('[data-formula-first]');
                    const continuationLines = formulaContainer.querySelectorAll('[data-formula-continuation]');
                    
                    if (firstLine && continuationLines.length > 0) {
                        const leftPart = firstLine.querySelector('.formula-left');
                        const equalsPart = firstLine.querySelector('.equals');
                        
                        if (leftPart && equalsPart) {
                            // Â∑¶ÂÅ¥ÈÉ®ÂàÜ„Å®„Ç§„Ç≥„Éº„É´„ÅÆÂπÖ„ÇíË®àÁÆó
                            const leftWidth = leftPart.offsetWidth;
                            const equalsWidth = equalsPart.offsetWidth;
                            const totalLeftWidth = leftWidth + equalsWidth + 16; // 16px„ÅØ„Éû„Éº„Ç∏„É≥
                            
                            // 2Ë°åÁõÆ‰ª•Èôç„ÅÆ„Ç§„Ç≥„Éº„É´„ÇíÂêå„Åò‰ΩçÁΩÆ„Å´ÈÖçÁΩÆ
                            continuationLines.forEach(line => {
                                const equals = line.querySelector('.equals');
                                if (equals) {
                                    equals.style.marginLeft = `${leftWidth}px`;
                                }
                            });
                        }
                    }
                }
            }, 50);
        }

        function closeExplanationAndNext() {
            const explanationEl = document.querySelector('.mistake-explanation');
            if (explanationEl) {
                explanationEl.classList.add('hiding');
                setTimeout(() => {
                    explanationEl.remove();
                    nextTurn();
                }, 300);
            } else {
                nextTurn();
            }
        }

        function endGame() {
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('final-score').innerText = currentScore;
            document.getElementById('final-level').innerText = currentLevel;
            gameScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
        }

        function gameClear() {
            if (timerInterval) clearInterval(timerInterval);
            playSound('clear');
            document.getElementById('clear-score').innerText = currentScore;
            gameScreen.classList.add('hidden');
            clearScreen.classList.remove('hidden');
        }

        function toTitle() {
            updateBackground(1);
            gameScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            clearScreen.classList.add('hidden');
            titleScreen.classList.remove('hidden');
            closeCalcPanel();
        }

        // --- Ë®àÁÆó„Éë„Éç„É´Ê©üËÉΩ ---
        function openCalcPanel() {
            calcPanel.classList.remove('closed');
            calcOpenBtn.classList.remove('show');
            initCanvas();
        }

        function closeCalcPanel() {
            calcPanel.classList.add('closed');
            calcOpenBtn.classList.add('show');
        }

        function toggleCalcPanel() {
            if (calcPanel.classList.contains('closed')) {
                openCalcPanel();
            } else {
                closeCalcPanel();
            }
        }

        function initCanvas() {
            const container = calcCanvas.parentElement;
            const rect = container.getBoundingClientRect();
            calcCanvas.width = rect.width - 20;
            calcCanvas.height = rect.height - 20;
            
            const ctx = calcCanvas.getContext('2d');
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function getCanvasCoordinates(e) {
            const rect = calcCanvas.getBoundingClientRect();
            const scaleX = calcCanvas.width / rect.width;
            const scaleY = calcCanvas.height / rect.height;
            
            if (e.touches) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const coords = getCanvasCoordinates(e);
            lastX = coords.x;
            lastY = coords.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const ctx = calcCanvas.getContext('2d');
            const coords = getCanvasCoordinates(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
            
            lastX = coords.x;
            lastY = coords.y;
        }

        function stopDrawing(e) {
            e.preventDefault();
            isDrawing = false;
        }

        function clearCanvas() {
            const ctx = calcCanvas.getContext('2d');
            ctx.clearRect(0, 0, calcCanvas.width, calcCanvas.height);
        }

        // Canvas„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        calcCanvas.addEventListener('mousedown', startDrawing);
        calcCanvas.addEventListener('mousemove', draw);
        calcCanvas.addEventListener('mouseup', stopDrawing);
        calcCanvas.addEventListener('mouseleave', stopDrawing);

        calcCanvas.addEventListener('touchstart', startDrawing);
        calcCanvas.addEventListener('touchmove', draw);
        calcCanvas.addEventListener('touchend', stopDrawing);
        calcCanvas.addEventListener('touchcancel', stopDrawing);

        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„Å´Canvas„ÇíÂÜçÂàùÊúüÂåñ
        window.addEventListener('resize', () => {
            if (!calcPanel.classList.contains('closed')) {
                setTimeout(initCanvas, 100);
            }
        });
    </script>
</body>
</html>
